<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegramè¥é”€æœºå™¨äºº - å®Œæ•´ç®¡ç†åå°</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; }
        
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; text-align: center; }
        .header h1 { margin-bottom: 5px; }
        .header p { opacity: 0.9; }
        
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .tab { padding: 10px 20px; background: white; border: none; border-radius: 5px; cursor: pointer; transition: all 0.3s; font-size: 14px; }
        .tab.active { background: #667eea; color: white; }
        .tab:hover { transform: translateY(-2px); }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .card { background: white; border-radius: 10px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .card h3 { margin-bottom: 15px; color: #333; display: flex; align-items: center; gap: 10px; }
        
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; color: #555; }
        .form-group input, .form-group textarea, .form-group select { 
            width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px; 
            font-size: 14px; transition: border-color 0.3s; 
        }
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus { 
            outline: none; border-color: #667eea; 
        }
        .form-group small { color: #666; font-size: 12px; }
        
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .form-row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; }
        
        .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; transition: all 0.3s; }
        .btn-primary { background: #667eea; color: white; }
        .btn-danger { background: #f44336; color: white; }
        .btn-success { background: #4CAF50; color: white; }
        .btn-warning { background: #ff9800; color: white; }
        .btn-small { padding: 5px 10px; font-size: 12px; }
        .btn:hover { transform: translateY(-2px); opacity: 0.9; }
        
        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; 
                     border: 1px solid #eee; border-radius: 5px; margin-bottom: 10px; }
        .list-item:hover { background: #f9f9f9; }
        .list-item-content { flex: 1; }
        .list-item-actions { display: flex; gap: 5px; }
        
        .badge { background: #e0e0e0; color: #666; padding: 2px 8px; border-radius: 12px; font-size: 12px; margin-right: 5px; }
        .badge.success { background: #4CAF50; color: white; }
        .badge.warning { background: #ff9800; color: white; }
        .badge.info { background: #2196F3; color: white; }
        
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px; text-align: center; }
        .stat-number { font-size: 2em; font-weight: bold; margin-bottom: 5px; }
        
        .alert { padding: 15px; border-radius: 5px; margin-bottom: 15px; }
        .alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alert-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .alert-info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        
        .loading { display: none; text-align: center; padding: 20px; }
        .spinner { border: 3px solid #f3f3f3; border-top: 3px solid #667eea; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .button-builder { border: 1px solid #ddd; border-radius: 5px; padding: 15px; margin-bottom: 15px; }
        .button-row { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; }
        .button-preview { background: #f0f0f0; padding: 10px; border-radius: 5px; margin-top: 10px; }
        .preview-button { background: #667eea; color: white; padding: 8px 16px; border-radius: 4px; margin: 2px; display: inline-block; }
        
        .template-preview { background: #f9f9f9; border: 1px solid #ddd; border-radius: 5px; padding: 15px; margin-top: 10px; }
        .template-preview img { max-width: 200px; border-radius: 5px; margin-bottom: 10px; }
        
        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            position: relative;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            position: absolute;
            right: 15px;
            top: 10px;
        }

        .close:hover,
        .close:focus {
            color: #000;
            text-decoration: none;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        @media (max-width: 768px) {
            .form-row, .form-row-3 { grid-template-columns: 1fr; }
            .tabs { justify-content: center; }
            .container { padding: 10px; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ¤– Telegramè¥é”€æœºå™¨äºº - å®Œæ•´ç®¡ç†åå°</h1>
        <p>è§¦å‘è¯ç›‘å¬ | å®šæ—¶å‘é€ | æ¶ˆæ¯æ¨¡æ¿ | æ•°æ®ç»Ÿè®¡</p>
    </div>

    <div class="container">
        <div class="tabs">
            <button class="tab active" onclick="showTab('dashboard')">ğŸ“Š ä»ªè¡¨ç›˜</button>
            <button class="tab" onclick="showTab('bind-codes')">ğŸ”‘ ç»‘å®šç ç®¡ç†</button>
            <button class="tab" onclick="showTab('regions')">ğŸ“ åœ°åŒºç®¡ç†</button>
            <button class="tab" onclick="showTab('merchants')">ğŸ‘¥ å•†å®¶ç®¡ç†</button>
            <button class="tab" onclick="showTab('templates')">ğŸ“ æ¶ˆæ¯æ¨¡æ¿</button>
            <button class="tab" onclick="showTab('triggers')">ğŸ¯ è§¦å‘è¯é…ç½®</button>
            <button class="tab" onclick="showTab('tasks')">â° å®šæ—¶ä»»åŠ¡</button>
            <button class="tab" onclick="showTab('buttons')">ğŸ”˜ æŒ‰é’®ç®¡ç†</button>
            <button class="tab" onclick="showTab('test')">ğŸ§ª æµ‹è¯•å‘é€</button>
            <button class="tab" onclick="window.open('admin/orders.html', '_blank')">ğŸ“ˆ è®¢å•ç»Ÿè®¡</button>
        </div>

        <!-- ä»ªè¡¨ç›˜ -->
        <div id="dashboard" class="tab-content active">
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-number" id="totalOrders">0</div>
                    <div>ğŸ“‹ æ€»è®¢å•</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="bookedOrders">0</div>
                    <div>ğŸ“… å·²é¢„çº¦è®¢å•</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="incompleteOrders">0</div>
                    <div>â³ å¾…å¤„ç†è®¢å•</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="completedOrders">0</div>
                    <div>âœ… å·²å®Œæˆè®¢å•</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="avgPrice">Â¥0</div>
                    <div>ğŸ’° å¹³å‡è®¢å•ä»·æ ¼</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="avgUserRating">-</div>
                    <div>ğŸ‘¤ å¹³å‡ç”¨æˆ·è¯„åˆ†</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="avgMerchantRating">-</div>
                    <div>ğŸ‘©â€ğŸ« å¹³å‡å‡ºå‡»ç´ è´¨</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="completionRate">0%</div>
                    <div>ğŸ“Š å®Œæˆç‡</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalMerchants">0</div>
                    <div>ğŸ‘¨â€ğŸ« å•†å®¶æ•°é‡</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalBindCodes">0</div>
                    <div>ğŸ”‘ ç»‘å®šç æ€»æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalRegions">0</div>
                    <div>ğŸ“ åœ°åŒºæ•°é‡</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalTemplates">0</div>
                    <div>ğŸ“ æ¶ˆæ¯æ¨¡æ¿</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalClicks">0</div>
                    <div>ğŸ‘† æ€»ç‚¹å‡»æ•°</div>
                </div>
            </div>
            
            <div class="card">
                <h3>ğŸ“ˆ ç³»ç»ŸçŠ¶æ€</h3>
                <div id="systemStatus">
                    <p>âœ… æœºå™¨äººè¿è¡Œæ­£å¸¸</p>
                    <p>âœ… æ•°æ®åº“è¿æ¥æ­£å¸¸</p>
                    <p>âœ… å®šæ—¶ä»»åŠ¡è°ƒåº¦å™¨è¿è¡Œä¸­</p>
                    <p>âœ… è§¦å‘è¯ç›‘å¬å·²å¯ç”¨</p>
                </div>
            </div>

            <div class="card">
                <h3>ğŸ‘¥ å•†å®¶é¢„çº¦ç»Ÿè®¡</h3>
                <div id="merchantBookingStats">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>åŠ è½½ä¸­...</p>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3>ğŸ“Š æ¶ˆæ¯äº’åŠ¨ç»Ÿè®¡</h3>
                <div id="messageStats">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>åŠ è½½ä¸­...</p>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3>ğŸ•’ æœ€è¿‘é¢„çº¦è®°å½•</h3>
                <div id="recentBookings">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>åŠ è½½ä¸­...</p>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3>ğŸ”˜ æŒ‰é’®ç‚¹å‡»ç»Ÿè®¡</h3>
                <div id="buttonStats">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>åŠ è½½ä¸­...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç»‘å®šç ç®¡ç† -->
        <div id="bind-codes" class="tab-content">
            <div class="card">
                <h3>ğŸ”‘ ç”Ÿæˆæ–°ç»‘å®šç </h3>
                <form onsubmit="createBindCode(event)">
                    <div class="form-group">
                        <label>ç»‘å®šç æè¿°</label>
                        <input type="text" id="bindCodeDescription" required placeholder="ä¾‹å¦‚ï¼šVIPå•†å®¶ä¸“ç”¨ç»‘å®šç ">
                        <small>ç”¨äºæ ‡è¯†ç»‘å®šç çš„ç”¨é€”</small>
                    </div>
                    <button type="submit" class="btn btn-primary">ç”Ÿæˆç»‘å®šç </button>
                </form>
            </div>

            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3>ğŸ“‹ ç»‘å®šç åˆ—è¡¨</h3>
                    <button class="btn btn-success btn-small" onclick="loadBindCodes(true)">ğŸ”„ åˆ·æ–°æ•°æ®</button>
                </div>
                <div style="margin-bottom: 15px;">
                    <button class="btn btn-danger" onclick="batchDeleteTestBindCodes()">ğŸ—‘ï¸ æ‰¹é‡åˆ é™¤æµ‹è¯•ç»‘å®šç </button>
                    <small style="margin-left: 10px; color: #666;">å°†åˆ é™¤æ‰€æœ‰æè¿°ä¸­åŒ…å«"æµ‹è¯•"çš„ç»‘å®šç ï¼ˆåŒ…æ‹¬å·²ä½¿ç”¨çš„ï¼‰</small>
                </div>
                <div id="bindCodesList"></div>
            </div>
        </div>

        <!-- åœ°åŒºç®¡ç† -->
        <div id="regions" class="tab-content">
            <div class="card">
                <h3>ğŸ“ æ·»åŠ æ–°åœ°åŒº</h3>
                <form onsubmit="createRegion(event)">
                    <div class="form-row">
                        <div class="form-group">
                            <label>åœ°åŒºåç§°</label>
                            <input type="text" id="regionName" required placeholder="ä¾‹å¦‚ï¼šåŒ—äº¬">
                        </div>
                        <div class="form-group">
                            <label>æ’åºé¡ºåº</label>
                            <input type="number" id="regionSortOrder" value="0" min="0" placeholder="æ•°å­—è¶Šå°è¶Šé å‰">
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">æ·»åŠ åœ°åŒº</button>
                </form>
            </div>

            <div class="card">
                <h3>ğŸ—ºï¸ åœ°åŒºåˆ—è¡¨</h3>
                <div id="regionsList"></div>
            </div>
        </div>

        <!-- æ¶ˆæ¯æ¨¡æ¿ç®¡ç† -->
        <div id="templates" class="tab-content">
            <div class="card">
                <h3>â• åˆ›å»ºæ¶ˆæ¯æ¨¡æ¿</h3>
                <form onsubmit="createTemplate(event)">
                    <div class="form-row">
                        <div class="form-group">
                            <label>æ¨¡æ¿åç§°</label>
                            <input type="text" id="templateName" required placeholder="ä¾‹å¦‚ï¼šå®¢æœè”ç³»æ¨¡æ¿">
                        </div>
                        <div class="form-group">
                            <label>å›¾ç‰‡URLï¼ˆå¯é€‰ï¼‰</label>
                            <input type="url" id="templateImage" placeholder="https://example.com/image.jpg">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>æ¶ˆæ¯å†…å®¹</label>
                        <textarea id="templateContent" rows="4" required placeholder="è¾“å…¥æ¶ˆæ¯å†…å®¹ï¼Œæ”¯æŒHTMLæ ¼å¼"></textarea>
                        <small>æ”¯æŒHTMLæ ¼å¼ï¼š&lt;b&gt;ç²—ä½“&lt;/b&gt; &lt;i&gt;æ–œä½“&lt;/i&gt; &lt;code&gt;ä»£ç &lt;/code&gt;</small>
                    </div>
                    
                    <div class="button-builder">
                        <label>æŒ‰é’®é…ç½®</label>
                        <div id="buttonRows"></div>
                        <button type="button" onclick="addButtonRow()" class="btn btn-success btn-small">+ æ·»åŠ æŒ‰é’®è¡Œ</button>
                    </div>
                    
                    <div class="template-preview" id="templatePreview" style="display: none;">
                        <h4>é¢„è§ˆæ•ˆæœï¼š</h4>
                        <div id="previewContent"></div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">åˆ›å»ºæ¨¡æ¿</button>
                    <button type="button" onclick="previewTemplate()" class="btn btn-warning">é¢„è§ˆæ•ˆæœ</button>
                </form>
            </div>

            <div class="card">
                <h3>ğŸ“‹ æ¨¡æ¿åˆ—è¡¨</h3>
                <div id="templatesList"></div>
            </div>
        </div>

        <!-- è§¦å‘è¯é…ç½® -->
        <div id="triggers" class="tab-content">
            <div class="card">
                <h3>ğŸ¯ æ·»åŠ è§¦å‘è¯</h3>
                <form onsubmit="createTrigger(event)">
                    <div class="form-row">
                        <div class="form-group">
                            <label>è§¦å‘è¯</label>
                            <input type="text" id="triggerWord" required placeholder="ä¾‹å¦‚ï¼šè”ç³»å®¢æœ">
                            <small>æ”¯æŒä¸­è‹±æ–‡ï¼Œä¸åŒºåˆ†å¤§å°å†™</small>
                        </div>
                        <div class="form-group">
                            <label>åŒ¹é…æ¨¡å¼</label>
                            <select id="triggerMatchType" required>
                                <option value="exact">ç²¾ç¡®åŒ¹é…</option>
                                <option value="contains">åŒ…å«åŒ¹é…</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>å…³è”æ¨¡æ¿</label>
                            <select id="triggerTemplate" required>
                                <option value="">é€‰æ‹©æ¶ˆæ¯æ¨¡æ¿</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ç¾¤ç»„ID</label>
                            <input type="text" id="triggerChatId" required placeholder="-1001234567890">
                            <small>ç¾¤ç»„IDé€šå¸¸ä¸ºè´Ÿæ•°</small>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">æ·»åŠ è§¦å‘è¯</button>
                </form>
            </div>

            <div class="card">
                <h3>ğŸ“ è§¦å‘è¯åˆ—è¡¨</h3>
                <div id="triggersList"></div>
            </div>
        </div>

        <!-- å®šæ—¶ä»»åŠ¡ -->
        <div id="tasks" class="tab-content">
            <div class="card">
                <h3>â° åˆ›å»ºå®šæ—¶ä»»åŠ¡</h3>
                <form onsubmit="createTask(event)">
                    <div class="form-row">
                        <div class="form-group">
                            <label>ä»»åŠ¡åç§°</label>
                            <input type="text" id="taskName" required placeholder="ä¾‹å¦‚ï¼šæ¯æ—¥è¥é”€æ¨é€">
                        </div>
                        <div class="form-group">
                            <label>å…³è”æ¨¡æ¿</label>
                            <select id="taskTemplate" required>
                                <option value="">é€‰æ‹©æ¶ˆæ¯æ¨¡æ¿</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>ç¾¤ç»„ID</label>
                            <input type="text" id="taskChatId" required placeholder="-1001234567890">
                        </div>
                        <div class="form-group">
                            <label>è°ƒåº¦ç±»å‹</label>
                            <select id="taskScheduleType" required onchange="updateScheduleInput()">
                                <option value="daily">æ¯æ—¥æ‰§è¡Œ</option>
                                <option value="weekly">æ¯å‘¨æ‰§è¡Œ</option>
                                <option value="cron">è‡ªå®šä¹‰Cron</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label id="scheduleLabel">æ‰§è¡Œæ—¶é—´</label>
                        <input type="text" id="taskScheduleTime" required placeholder="09:00">
                        <small id="scheduleHelp">æ ¼å¼ï¼šHH:MMï¼ˆ24å°æ—¶åˆ¶ï¼‰</small>
                    </div>
                    <button type="submit" class="btn btn-primary">åˆ›å»ºä»»åŠ¡</button>
                </form>
            </div>

            <div class="card">
                <h3>ğŸ“… ä»»åŠ¡åˆ—è¡¨</h3>
                <div id="tasksList"></div>
            </div>
        </div>

        <!-- å•†å®¶ç®¡ç† -->
        <div id="merchants" class="tab-content">
            <div class="card">
                <h3>ğŸ“Š ç»‘å®šç»Ÿè®¡</h3>
                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-number" id="totalBindCodes">0</div>
                        <div>æ€»ç»‘å®šç </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="usedBindCodes">0</div>
                        <div>å·²ä½¿ç”¨</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="boundMerchants">0</div>
                        <div>å·²ç»‘å®šå•†å®¶</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="bindingInProgress">0</div>
                        <div>ç»‘å®šä¸­</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="section-header">
                    <h3>ğŸ“Š å·²ç»‘å®šå•†å®¶åˆ—è¡¨</h3>
                    <div class="header-actions">
                        <button class="btn btn-success" onclick="openNewMerchantModal()">â• æ–°å¢å•†å®¶</button>
                        <button class="btn btn-info" onclick="refreshFollowStatus()">ğŸ”„ åˆ·æ–°å…³æ³¨çŠ¶æ€</button>
                    </div>
                </div>
                <div id="merchantsList"></div>
            </div>

            <!-- å•†å®¶ç¼–è¾‘æ¨¡æ€æ¡† -->
            <div id="merchantEditModal" class="modal">
                <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
                    <span class="close" onclick="closeMerchantEditModal()">&times;</span>
                    <h3>âœï¸ ç¼–è¾‘å•†å®¶ä¿¡æ¯æ¨¡æ¿</h3>
                    <form onsubmit="updateMerchant(event)">
                        <input type="hidden" id="editMerchantId">
                        
                        <!-- åŸºæœ¬ä¿¡æ¯ -->
                        <div class="card" style="margin-bottom: 20px;">
                            <h4>ğŸ“‹ åŸºæœ¬ä¿¡æ¯</h4>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>åœ°åŒºï¼š#<span id="regionPrefix"></span></label>
                                    <select id="editRegionId" required onchange="updateRegionPrefix()">
                                        <option value="">é€‰æ‹©åœ°åŒº</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>è‰ºåï¼š</label>
                                    <input type="text" id="editTeacherName" required placeholder="è¯·è¾“å…¥è‰ºå">
                                </div>
                            </div>
                        </div>

                        <!-- æè¿°ä¿¡æ¯ -->
                        <div class="card" style="margin-bottom: 20px;">
                            <h4>ğŸ“ æè¿°ä¿¡æ¯</h4>
                            <div class="form-group">
                                <label>ä¼˜ç‚¹ï¼š</label>
                                <textarea id="editAdvantages" rows="3" placeholder="è¯·è¾“å…¥ä¼˜ç‚¹æè¿°ï¼Œæ”¯æŒæ–‡å­—ã€ç©ºæ ¼ã€emoji"></textarea>
                            </div>
                            <div class="form-group">
                                <label>ç¼ºç‚¹ï¼š</label>
                                <textarea id="editDisadvantages" rows="3" placeholder="è¯·è¾“å…¥ç¼ºç‚¹æè¿°ï¼Œæ”¯æŒæ–‡å­—ã€ç©ºæ ¼ã€emoji"></textarea>
                            </div>
                        </div>

                        <!-- ä»·æ ¼ä¿¡æ¯ -->
                        <div class="card" style="margin-bottom: 20px;">
                            <h4>ğŸ’° ä»·æ ¼ä¿¡æ¯</h4>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>ä»·æ ¼1ï¼š</label>
                                    <div style="display: flex; align-items: center;">
                                        <select id="editPrice1" style="flex: 1;">
                                            <option value="">é€‰æ‹©ä»·æ ¼</option>
                                        </select>
                                        <span style="margin-left: 5px; font-weight: bold;">p</span>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>ä»·æ ¼2ï¼š</label>
                                    <div style="display: flex; align-items: center;">
                                        <select id="editPrice2" style="flex: 1;">
                                            <option value="">é€‰æ‹©ä»·æ ¼</option>
                                        </select>
                                        <span style="margin-left: 5px; font-weight: bold;">pp</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- è”ç³»æ–¹å¼ -->
                        <div class="card" style="margin-bottom: 20px;">
                            <h4>ğŸ“ è”ç³»æ–¹å¼</h4>
                            <div class="form-group">
                                <label>è”ç³»ï¼š</label>
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <input type="text" id="editContact" placeholder="@username" style="flex: 1;">
                                    <button type="button" class="btn btn-small" onclick="useBindContact()" style="white-space: nowrap;">ä½¿ç”¨ç»‘å®šè”ç³»æ–¹å¼</button>
                                </div>
                                <small>å¯ä»¥æ‰‹åŠ¨ç¼–è¾‘æˆ–ä½¿ç”¨å•†å®¶ç»‘å®šæ—¶å¡«å†™çš„è”ç³»æ–¹å¼</small>
                            </div>
                            <div class="form-group">
                                <label>é¢‘é“é“¾æ¥ï¼š</label>
                                <input type="text" id="editChannelLink" placeholder="https://t.me/channelname">
                                <small>ç”¨æˆ·ç‚¹å‡»"å…³æ³¨è€å¸ˆé¢‘é“"æŒ‰é’®æ—¶è·³è½¬çš„é“¾æ¥</small>
                            </div>
                        </div>

                        <!-- å›¾ç‰‡ç®¡ç† -->
                        <div class="card" style="margin-bottom: 20px;">
                            <h4>ğŸ–¼ï¸ å›¾ç‰‡ç®¡ç†</h4>
                            <div class="form-group">
                                <label>å•†å®¶å›¾ç‰‡ï¼š</label>
                                <div style="display: flex; gap: 10px; align-items: flex-start;">
                                    <div style="flex: 1;">
                                        <div id="imageDropZone" style="border: 2px dashed #ccc; border-radius: 5px; padding: 20px; text-align: center; cursor: pointer; margin-bottom: 10px;" onclick="document.getElementById('editImageFile').click()">
                                            <p style="margin: 0; color: #666;">ç‚¹å‡»é€‰æ‹©å›¾ç‰‡æˆ–æ‹–æ‹½å›¾ç‰‡åˆ°æ­¤å¤„</p>
                                            <p style="margin: 5px 0 0 0; font-size: 12px; color: #999;">æ”¯æŒ JPGã€PNGã€GIF æ ¼å¼ï¼Œæœ€å¤§ 5MB</p>
                                        </div>
                                        <input type="file" id="editImageFile" accept="image/*" onchange="handleImageFileUpload(event)" style="display: none;">
                                        <small>å›¾ç‰‡å°†ä¿å­˜åˆ°æ•°æ®åº“ä¸­ï¼Œæ˜¾ç¤ºåœ¨å•†å®¶ä¿¡æ¯ä¸Šæ–¹</small>
                                    </div>
                                    <button type="button" class="btn btn-small btn-warning" onclick="clearMerchantImage()" style="white-space: nowrap;">æ¸…é™¤å›¾ç‰‡</button>
                                </div>
                                <div id="imagePreview" style="margin-top: 10px; display: none;">
                                    <img id="previewImage" style="max-width: 200px; max-height: 200px; border-radius: 5px; border: 1px solid #ddd;">
                                </div>
                            </div>
                        </div>

                        <!-- ç»‘å®šç ç®¡ç† -->
                        <div class="card" style="margin-bottom: 20px;">
                            <h4>ğŸ”— ç»‘å®šç ç®¡ç†</h4>
                            <div class="form-group">
                                <label>å½“å‰ç»‘å®šç ï¼š</label>
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <input type="text" id="editBindCode" placeholder="æœªè®¾ç½®ç»‘å®šç " style="flex: 1;">
                                    <button type="button" class="btn btn-small" onclick="generateNewBindCode()" style="white-space: nowrap;">ç”Ÿæˆæ–°ç»‘å®šç </button>
                                    <button type="button" class="btn btn-small btn-warning" onclick="clearBindCode()" style="white-space: nowrap;">æ¸…é™¤ç»‘å®šç </button>
                                </div>
                                <small>ç»‘å®šç ç”¨äºå•†å®¶ç»‘å®šï¼Œå¦‚æœä¿®æ”¹å°†å½±å“ç°æœ‰ç»‘å®šå…³ç³»</small>
                            </div>
                        </div>

                        <!-- åŸºæœ¬åŠŸä¿¡æ¯ -->
                        <div class="card" style="margin-bottom: 20px;">
                            <h4>ğŸ’ƒ è€å¸ˆè‡ªå¡«åŸºæœ¬åŠŸ</h4>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>ğŸ’¦æ´—ï¼š</label>
                                    <input type="text" id="editWash" placeholder="è¯·å¡«å†™">
                                </div>
                                <div class="form-group">
                                    <label>ğŸ‘„å¹ï¼š</label>
                                    <input type="text" id="editBlow" placeholder="è¯·å¡«å†™">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>â¤ï¸åšï¼š</label>
                                    <input type="text" id="editDo" placeholder="è¯·å¡«å†™">
                                </div>
                                <div class="form-group">
                                    <label>ğŸå»ï¼š</label>
                                    <input type="text" id="editKiss" placeholder="è¯·å¡«å†™">
                                </div>
                            </div>
                        </div>

                        <!-- é¢„è§ˆåŒºåŸŸ -->
                        <div class="card" style="margin-bottom: 20px;">
                            <h4>ğŸ‘€ ä¿¡æ¯é¢„è§ˆ</h4>
                            <div id="merchantInfoPreview" style="background: #f9f9f9; padding: 15px; border-radius: 5px; white-space: pre-line; font-family: monospace;"></div>
                        </div>

                        <div class="form-actions">
                            <button type="button" onclick="closeMerchantEditModal()" class="btn btn-secondary">å–æ¶ˆ</button>
                            <button type="button" onclick="previewMerchantInfo()" class="btn btn-warning">é¢„è§ˆ</button>
                            <button type="submit" class="btn btn-primary">ä¿å­˜ä¿®æ”¹</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- æ–°å¢å•†å®¶æ¨¡æ€æ¡† -->
            <div id="newMerchantModal" class="modal">
                <div class="modal-content" style="max-width: 600px;">
                    <span class="close" onclick="closeNewMerchantModal()">&times;</span>
                    <h3>â• æ–°å¢å•†å®¶</h3>
                    <form onsubmit="createNewMerchant(event)">
                        <div class="form-group">
                            <label>å•†å®¶åç§°ï¼š</label>
                            <input type="text" id="newMerchantName" required placeholder="è¯·è¾“å…¥å•†å®¶åç§°">
                            <small>æ­¤åç§°å°†ä½œä¸ºå•†å®¶çš„è‰ºåæ˜¾ç¤º</small>
                        </div>
                        <div class="form-group">
                            <label>Telegramç”¨æˆ·åï¼š</label>
                            <input type="text" id="newMerchantUsername" required placeholder="è¯·è¾“å…¥ç”¨æˆ·åï¼Œä¾‹å¦‚ï¼šusername">
                            <small>ä¸éœ€è¦è¾“å…¥@ç¬¦å·ï¼Œåªéœ€è¦è¾“å…¥ç”¨æˆ·åéƒ¨åˆ†</small>
                        </div>
                        <div class="form-group">
                            <label>ç»‘å®šç ï¼š</label>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <input type="text" id="newMerchantBindCode" readonly style="flex: 1;">
                                <button type="button" class="btn btn-small" onclick="generateBindCodeForNewMerchant()">ç”Ÿæˆç»‘å®šç </button>
                            </div>
                        </div>
                        <div class="form-actions">
                            <button type="button" onclick="closeNewMerchantModal()" class="btn btn-secondary">å–æ¶ˆ</button>
                            <button type="submit" class="btn btn-primary">åˆ›å»ºå•†å®¶</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- æŒ‰é’®ç®¡ç† -->
        <div id="buttons" class="tab-content">
            <div class="card">
                <h3>â• åˆ›å»ºæ–°æŒ‰é’®</h3>
                <form onsubmit="createButton(event)">
                    <div class="form-row">
                        <div class="form-group">
                            <label>æŒ‰é’®æ ‡é¢˜</label>
                            <input type="text" id="buttonTitle" required placeholder="ä¾‹å¦‚ï¼šè”ç³»å®¢æœ">
                        </div>
                        <div class="form-group">
                            <label>å…³è”å•†å®¶</label>
                            <select id="buttonMerchant" required>
                                <option value="">é€‰æ‹©å•†å®¶</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>å›å¤æ¶ˆæ¯</label>
                        <textarea id="buttonMessage" rows="3" placeholder="ç”¨æˆ·ç‚¹å‡»æŒ‰é’®åæ”¶åˆ°çš„æ¶ˆæ¯"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">åˆ›å»ºæŒ‰é’®</button>
                </form>
            </div>

            <div class="card">
                <h3>ğŸ”˜ æŒ‰é’®åˆ—è¡¨</h3>
                <div id="buttonsList"></div>
            </div>
        </div>

        <!-- æµ‹è¯•å‘é€ -->
        <div id="test" class="tab-content">
            <div class="card">
                <h3>ğŸ“¤ å‘é€ä¿¡æ¯</h3>
                <form onsubmit="sendTestMessage(event)">
                    <div class="form-row">
                        <div class="form-group">
                            <label>ç¾¤ç»„ID</label>
                            <input type="text" id="testChatId" required placeholder="ä¾‹å¦‚ï¼š-1001234567890">
                            <small>ç¾¤ç»„IDé€šå¸¸ä¸ºè´Ÿæ•°ï¼Œå¯ä»¥é€šè¿‡æ·»åŠ æœºå™¨äººåˆ°ç¾¤ç»„è·å–</small>
                        </div>
                        <div class="form-group">
                            <label>æ¨¡å—é€‰æ‹©</label>
                            <select id="testModuleType" onchange="handleModuleTypeChange()">
                                <option value="">è¯·é€‰æ‹©å‘é€æ¨¡å—</option>
                                <option value="merchant">å•†å®¶ä¿¡æ¯é€‰æ‹©</option>
                                <option value="template">æ¶ˆæ¯æ¨¡æ¿é€‰æ‹©</option>
                                <option value="custom">è‡ªå®šä¹‰æ¶ˆæ¯å†…å®¹</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- å•†å®¶ä¿¡æ¯é€‰æ‹© -->
                    <div id="merchantModule" class="form-group" style="display: none;">
                        <label>é€‰æ‹©å•†å®¶</label>
                        <select id="testMerchant">
                            <option value="">è¯·é€‰æ‹©å•†å®¶</option>
                        </select>
                        <div id="merchantPreview" style="margin-top: 10px; padding: 10px; background: #f5f5f5; border-radius: 5px; display: none;">
                            <h4>å•†å®¶ä¿¡æ¯é¢„è§ˆï¼š</h4>
                            <div id="merchantPreviewContent"></div>
                        </div>
                    </div>
                    
                    <!-- æ¶ˆæ¯æ¨¡æ¿é€‰æ‹© -->
                    <div id="templateModule" class="form-group" style="display: none;">
                        <label>é€‰æ‹©æ¶ˆæ¯æ¨¡æ¿</label>
                        <select id="testTemplate" onchange="handleTemplateChange()">
                            <option value="">è¯·é€‰æ‹©æ¶ˆæ¯æ¨¡æ¿</option>
                        </select>
                        <div id="templatePreviewTest" style="margin-top: 10px; padding: 10px; background: #f5f5f5; border-radius: 5px; display: none;">
                            <h4>æ¨¡æ¿é¢„è§ˆï¼š</h4>
                            <div id="templatePreviewTestContent"></div>
                        </div>
                    </div>
                    
                    <!-- è‡ªå®šä¹‰æ¶ˆæ¯å†…å®¹ -->
                    <div id="customModule" class="form-group" style="display: none;">
                        <label>æ¶ˆæ¯å†…å®¹</label>
                        <textarea id="testMessage" rows="5" placeholder="è¯·è¾“å…¥è‡ªå®šä¹‰æ¶ˆæ¯å†…å®¹"></textarea>
                        <div class="form-group" style="margin-top: 10px;">
                            <label>å›¾ç‰‡URLï¼ˆå¯é€‰ï¼‰</label>
                            <input type="url" id="testImageUrl" placeholder="https://example.com/image.jpg">
                    </div>
                        <div class="form-group">
                            <label>æŒ‰é’®é…ç½®ï¼ˆå¯é€‰ï¼‰</label>
                            <div id="testButtonRows"></div>
                            <button type="button" onclick="addTestButtonRow()" class="btn btn-secondary" style="margin-top: 5px;">+ æ·»åŠ æŒ‰é’®</button>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-success">å‘é€åˆ°ç¾¤ç»„</button>
                </form>
            </div>
        </div>
    </div>

    <div id="loading" class="loading">
        <div class="spinner"></div>
        <p>å¤„ç†ä¸­...</p>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let merchants = [];
        let regions = [];
        let bindCodes = [];
        let botUsername = ''; // Botç”¨æˆ·å

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadMerchants();
            loadRegions();
            loadBindCodes();
            loadBotUsername(); // åŠ è½½Botç”¨æˆ·å
        });

        // åŠ è½½Botç”¨æˆ·å
        async function loadBotUsername() {
            try {
                const response = await fetch('/api/bot-username');
                if (response.ok) {
                    const data = await response.json();
                    // å…¼å®¹ä¸¤ç§å“åº”æ ¼å¼
                    botUsername = data.username || data.data?.username || 'xiaojisystembot';
                    window.BOT_USERNAME = botUsername; // è®¾ç½®å…¨å±€å˜é‡
                    console.log('Botç”¨æˆ·ååŠ è½½æˆåŠŸ:', botUsername);
                } else {
                    console.error('è·å–Botç”¨æˆ·åå¤±è´¥:', response.status);
                    botUsername = 'xiaojisystembot'; // é»˜è®¤å€¼
                    window.BOT_USERNAME = botUsername;
                }
            } catch (error) {
                console.error('åŠ è½½Botç”¨æˆ·åå¤±è´¥:', error);
                botUsername = 'xiaojisystembot'; // é»˜è®¤å€¼
                window.BOT_USERNAME = botUsername;
            }
        }

        // å¤åˆ¶å•†å®¶URLé“¾æ¥
        function copyMerchantUrl(url) {
            if (navigator.clipboard && window.isSecureContext) {
                // ç°ä»£æµè§ˆå™¨æ”¯æŒClipboard API
                navigator.clipboard.writeText(url).then(() => {
                    showAlert('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼', 'success');
                }).catch(err => {
                    console.error('å¤åˆ¶å¤±è´¥:', err);
                    fallbackCopyTextToClipboard(url);
                });
            } else {
                // æ—§æµè§ˆå™¨çš„å›é€€æ–¹æ¡ˆ
                fallbackCopyTextToClipboard(url);
            }
        }

        // å›é€€çš„å¤åˆ¶æ–¹æ³•
        function fallbackCopyTextToClipboard(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            
            // é¿å…åœ¨å±å¹•ä¸Šæ˜¾ç¤º
            textArea.style.position = "fixed";
            textArea.style.top = "0";
            textArea.style.left = "0";
            textArea.style.width = "2em";
            textArea.style.height = "2em";
            textArea.style.padding = "0";
            textArea.style.border = "none";
            textArea.style.outline = "none";
            textArea.style.boxShadow = "none";
            textArea.style.background = "transparent";
            
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showAlert('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼', 'success');
                } else {
                    showAlert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶é“¾æ¥', 'error');
                }
            } catch (err) {
                console.error('Fallback: å¤åˆ¶å¤±è´¥', err);
                showAlert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶é“¾æ¥', 'error');
            }
            
            document.body.removeChild(textArea);
        }

        // æµ‹è¯•å•†å®¶URLé“¾æ¥
        function openMerchantUrl(url) {
            window.open(url, '_blank');
            showAlert('å·²åœ¨æ–°çª—å£æ‰“å¼€æµ‹è¯•é“¾æ¥', 'info');
        }

        let buttons = [];
        let templates = [];
        let triggers = [];
        let tasks = [];
        let buttonRowCount = 0;

        // è·å–Botç”¨æˆ·å
        async function fetchBotUsername() {
            try {
                const response = await fetch('/api/bot-username');
                if (response.ok) {
                    const data = await response.json();
                    window.BOT_USERNAME = data.username;
                    console.log('âœ… è·å–Botç”¨æˆ·åæˆåŠŸ:', data.username);
                } else {
                    console.warn('âš ï¸ è·å–Botç”¨æˆ·åå¤±è´¥ï¼Œä½¿ç”¨ç¯å¢ƒé»˜è®¤å€¼');
                    // æ ¹æ®é¡µé¢URLåˆ¤æ–­ç¯å¢ƒ
                    const hostname = window.location.hostname;
                    if (hostname.includes('staging') || hostname.includes('test')) {
                        window.BOT_USERNAME = 'xiaoji_daniao_bot'; // æµ‹è¯•ç¯å¢ƒ
                    } else {
                        window.BOT_USERNAME = 'xiaojisystembot'; // ç”Ÿäº§ç¯å¢ƒ
                    }
                }
            } catch (error) {
                console.error('âŒ è·å–Botç”¨æˆ·åå‡ºé”™:', error);
                // æ ¹æ®é¡µé¢URLåˆ¤æ–­ç¯å¢ƒ
                const hostname = window.location.hostname;
                if (hostname.includes('staging') || hostname.includes('test')) {
                    window.BOT_USERNAME = 'xiaoji_daniao_bot'; // æµ‹è¯•ç¯å¢ƒ
                } else {
                    window.BOT_USERNAME = 'xiaojisystembot'; // ç”Ÿäº§ç¯å¢ƒ
                }
            }
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async () => {
            await fetchBotUsername(); // å…ˆè·å–Botç”¨æˆ·å
            initializePriceSelectors();
            loadAllData();
        });

        // åˆå§‹åŒ–ä»·æ ¼é€‰æ‹©å™¨
        function initializePriceSelectors() {
            const price1Select = document.getElementById('editPrice1');
            const price2Select = document.getElementById('editPrice2');
            
            // ç”Ÿæˆä»·æ ¼é€‰é¡¹ï¼Œä»100åˆ°5000ï¼Œé—´éš”100
            for (let price = 100; price <= 5000; price += 100) {
                const option1 = document.createElement('option');
                option1.value = price;
                option1.textContent = price;
                price1Select.appendChild(option1);
                
                const option2 = document.createElement('option');
                option2.value = price;
                option2.textContent = price;
                price2Select.appendChild(option2);
            }
        }

        // æ˜¾ç¤ºæç¤ºä¿¡æ¯
        function showAlert(message, type = 'success') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            
            const container = document.querySelector('.container');
            container.insertBefore(alertDiv, container.firstChild);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 3000);
        }

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        function showLoading() {
            document.getElementById('loading').style.display = 'block';
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function showTab(tabName) {
            // éšè—æ‰€æœ‰æ ‡ç­¾å†…å®¹
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // ç§»é™¤æ‰€æœ‰æ ‡ç­¾çš„æ¿€æ´»çŠ¶æ€
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // æ˜¾ç¤ºé€‰ä¸­çš„æ ‡ç­¾å†…å®¹
            document.getElementById(tabName).classList.add('active');
            
            // æ¿€æ´»é€‰ä¸­çš„æ ‡ç­¾
            event.target.classList.add('active');
            
            // åŠ è½½å¯¹åº”æ•°æ®
            if (tabName === 'dashboard') {
                loadStats();
                loadMerchantBookingStats();
                loadMessageStats();
                loadRecentBookings();
                loadButtonStats();
            } else if (tabName === 'bind-codes') {
                // å¼ºåˆ¶æ¸…ç©ºç¼“å­˜å¹¶é‡æ–°åŠ è½½ç»‘å®šç æ•°æ®
                bindCodes = [];
                loadBindCodes(true); // å¼ºåˆ¶åˆ·æ–°
            } else if (tabName === 'regions') {
                loadRegions();
            } else if (tabName === 'merchants') {
                loadMerchants();
            } else if (tabName === 'templates') {
                loadTemplates();
            } else if (tabName === 'triggers') {
                loadTriggers();
            } else if (tabName === 'tasks') {
                loadTasks();
            } else if (tabName === 'buttons') {
                loadButtons();
            }
        }

        // åŠ è½½æ‰€æœ‰æ•°æ®
        async function loadAllData() {
            showLoading();
            try {
                await Promise.all([
                    loadMerchants(),
                    loadButtons(),
                    loadTemplates(),
                    loadTriggers(),
                    loadTasks(),
                    loadBindCodes(),
                    loadRegions(),
                    loadStats()
                ]);
                updateSelects();
                // ç¡®ä¿æµ‹è¯•å‘é€é¡µé¢çš„å•†å®¶é€‰æ‹©å™¨ä¹Ÿå¾—åˆ°æ›´æ–°
                if (typeof updateMerchantSelect === 'function') {
                    updateMerchantSelect();
                }
                loadChatId(); // åŠ è½½ä¿å­˜çš„ç¾¤ç»„ID
            } catch (error) {
                showAlert('åŠ è½½æ•°æ®å¤±è´¥: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // APIè¯·æ±‚å°è£…
        async function apiRequest(url, method = 'GET', data = null, forceRefresh = false) {
            const options = {
                method,
                headers: {
                    'Content-Type': 'application/json'
                }
            };
            
            // å¯¹äºå¼ºåˆ¶åˆ·æ–°çš„GETè¯·æ±‚ï¼Œæ·»åŠ ç¼“å­˜æ§åˆ¶å¤´å’Œæ—¶é—´æˆ³
            if (forceRefresh && method === 'GET') {
                options.headers['Cache-Control'] = 'no-cache, no-store, must-revalidate';
                options.headers['Pragma'] = 'no-cache';
                // æ·»åŠ æ—¶é—´æˆ³å‚æ•°ç¡®ä¿URLå”¯ä¸€
                const separator = url.includes('?') ? '&' : '?';
                url = `${url}${separator}_t=${Date.now()}`;
            }
            
            if (data) {
                options.body = JSON.stringify(data);
            }
            
            const response = await fetch(url, options);
            const result = await response.json();
            
            if (!result.success) {
                throw new Error(result.error || result.message || 'è¯·æ±‚å¤±è´¥');
            }
            
            // å¯¹äºGETè¯·æ±‚è¿”å›dataï¼Œå¯¹äºå…¶ä»–è¯·æ±‚è¿”å›å®Œæ•´ç»“æœä»¥ä¿ç•™messageç­‰ä¿¡æ¯
            if (method === 'GET') {
                return result.data || result;
            } else {
                return result;
            }
        }

        // åŠ è½½ç»‘å®šç æ•°æ®
        async function loadBindCodes(forceRefresh = false) {
            try {
                // å…ˆæ¸…ç©ºæ—§æ•°æ®
                bindCodes = [];
                const freshData = await apiRequest('/api/bind-codes', 'GET', null, forceRefresh);
                bindCodes = freshData;
                renderBindCodes();
                console.log('âœ… ç»‘å®šç æ•°æ®å·²åˆ·æ–°' + (forceRefresh ? ' (å¼ºåˆ¶åˆ·æ–°)' : ''));
            } catch (error) {
                console.error('âŒ åŠ è½½ç»‘å®šç å¤±è´¥:', error);
                // å‡ºé”™æ—¶ä¹Ÿè¦æ¸…ç©ºæ•°æ®ï¼Œé¿å…æ˜¾ç¤ºæ—§æ•°æ®
                bindCodes = [];
                renderBindCodes();
                showAlert('åŠ è½½ç»‘å®šç æ•°æ®å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ¸²æŸ“ç»‘å®šç åˆ—è¡¨
        function renderBindCodes() {
            const container = document.getElementById('bindCodesList');
            if (!container) return;

            if (bindCodes.length === 0) {
                container.innerHTML = '<p>æš‚æ— ç»‘å®šç </p>';
                return;
            }

            container.innerHTML = bindCodes.map(code => `
                <div class="list-item">
                    <div class="list-item-content">
                        <strong>ğŸ”‘ ${code.code}</strong>
                        <div style="color: #666; font-size: 14px; margin-top: 5px;">
                            ğŸ“ ${code.description || 'æ— æè¿°'}
                        </div>
                        <div style="color: #666; font-size: 12px; margin-top: 5px;">
                            ${code.used ? 
                                `âœ… å·²ä½¿ç”¨ - ç»‘å®šå•†å®¶: ${code.teacher_name || 'æœªçŸ¥'} (@${code.username || 'æœªçŸ¥'})` : 
                                'â³ æœªä½¿ç”¨'
                            }
                        </div>
                        <div style="color: #999; font-size: 12px;">
                            åˆ›å»ºæ—¶é—´: ${new Date(code.created_at * 1000).toLocaleString()}
                        </div>
                    </div>
                    <div class="list-item-actions">
                        ${!code.used ? 
                            `<button class="btn btn-danger btn-small" onclick="deleteBindCode(${code.id})">åˆ é™¤</button>` : 
                            `<button class="btn btn-warning btn-small" onclick="forceDeleteBindCode(${code.id})">å¼ºåˆ¶åˆ é™¤</button>`
                        }
                    </div>
                </div>
            `).join('');
        }

        // åˆ›å»ºç»‘å®šç 
        async function createBindCode(event) {
            event.preventDefault();
            const description = document.getElementById('bindCodeDescription').value;

            try {
                showLoading();
                const result = await apiRequest('/api/bind-codes', 'POST', { description });
                showAlert(`ç»‘å®šç åˆ›å»ºæˆåŠŸï¼ç»‘å®šç ï¼š${result.code}`);
                document.getElementById('bindCodeDescription').value = '';
                await loadBindCodes();
            } catch (error) {
                showAlert('åˆ›å»ºç»‘å®šç å¤±è´¥: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // åˆ é™¤ç»‘å®šç  - éœ€è¦ç®¡ç†å‘˜å¯†ç éªŒè¯
        async function deleteBindCode(id) {
            // é¦–å…ˆæ£€æŸ¥ç»‘å®šç çŠ¶æ€
            const bindCode = bindCodes.find(bc => bc.id == id); // ä½¿ç”¨ == è€Œä¸æ˜¯ === ä»¥å¤„ç†ç±»å‹è½¬æ¢
            
            if (!bindCode) {
                showAlert('ç»‘å®šç ä¸å­˜åœ¨ï¼Œå¯èƒ½æ˜¯ç¼“å­˜é—®é¢˜ã€‚æ­£åœ¨é‡æ–°åŠ è½½æ•°æ®...', 'warning');
                await loadBindCodes();
                return;
            }
            
            if (bindCode.used) {
                showAlert('å·²ä½¿ç”¨çš„ç»‘å®šç æ— æ³•åˆ é™¤ï¼Œè¯·ä½¿ç”¨å¼ºåˆ¶åˆ é™¤åŠŸèƒ½', 'error');
                return;
            }
            
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªç»‘å®šç å—ï¼Ÿ')) return;

            try {
                showLoading();
                const response = await apiRequest(`/api/bind-codes/${id}`, 'DELETE');
                
                showAlert(response.message || 'ç»‘å®šç åˆ é™¤æˆåŠŸ');
                await loadBindCodes();
            } catch (error) {
                // å¤„ç†APIè¿”å›çš„é”™è¯¯ä¿¡æ¯
                if (error.message.includes('BIND_CODE_IN_USE')) {
                    const confirmForce = confirm(
                        `${error.message}\n\næ˜¯å¦è¦å¼ºåˆ¶åˆ é™¤ï¼Ÿ\nâš ï¸ è­¦å‘Šï¼šå¼ºåˆ¶åˆ é™¤å°†åŒæ—¶åˆ é™¤ç›¸å…³çš„å•†å®¶è®°å½•ï¼`
                    );
                    if (confirmForce) {
                        await forceDeleteBindCode(id);
                        return;
                    }
                } else {
                    showAlert('åˆ é™¤ç»‘å®šç å¤±è´¥: ' + error.message, 'error');
                }
            } finally {
                hideLoading();
            }
        }

        // å¼ºåˆ¶åˆ é™¤å·²ä½¿ç”¨çš„ç»‘å®šç  - éœ€è¦ç®¡ç†å‘˜å¯†ç éªŒè¯
        async function forceDeleteBindCode(id) {
            // å¦‚æœæ˜¯ä»deleteBindCodeè°ƒç”¨çš„ï¼Œä¸éœ€è¦å†æ¬¡ç¡®è®¤
            const needConfirm = arguments.length === 1;
            
            if (needConfirm && !confirm('ç¡®å®šè¦å¼ºåˆ¶åˆ é™¤è¿™ä¸ªå·²ä½¿ç”¨çš„ç»‘å®šç å—ï¼Ÿ\nâš ï¸ æ³¨æ„ï¼šè¿™å°†åŒæ—¶åˆ é™¤ç›¸å…³çš„å•†å®¶è®°å½•ï¼')) {
                return;
            }

            // è¦æ±‚è¾“å…¥ç®¡ç†å‘˜å¯†ç 
            const adminPassword = prompt('âš ï¸ å¼ºåˆ¶åˆ é™¤éœ€è¦ç®¡ç†å‘˜å¯†ç éªŒè¯\nè¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç :');
            if (!adminPassword) {
                showAlert('æ“ä½œå·²å–æ¶ˆ', 'info');
                return;
            }
            
            // ç®€å•çš„å¯†ç éªŒè¯ï¼ˆå®é™…é¡¹ç›®ä¸­åº”è¯¥ä½¿ç”¨æ›´å®‰å…¨çš„æ–¹å¼ï¼‰
                            const isValid = await verifyAdminPassword(adminPassword, 'å¼ºåˆ¶åˆ é™¤ç»‘å®šç ');
                if (!isValid) {
                    showAlert('ç®¡ç†å‘˜å¯†ç é”™è¯¯ï¼', 'error');
                    return;
                }

            try {
                showLoading();
                const response = await apiRequest(`/api/bind-codes/${id}/force`, 'DELETE');
                
                showAlert(response.message || 'ç»‘å®šç å·²å¼ºåˆ¶åˆ é™¤');
                await loadBindCodes();
                // å¦‚æœåˆ é™¤äº†å•†å®¶ï¼Œä¹Ÿè¦åˆ·æ–°å•†å®¶åˆ—è¡¨
                if (response.data && response.data.deletedMerchant) {
                    await loadMerchants();
                }
            } catch (error) {
                showAlert('å¼ºåˆ¶åˆ é™¤ç»‘å®šç å¤±è´¥: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // æ‰¹é‡åˆ é™¤æµ‹è¯•ç»‘å®šç 
        async function batchDeleteTestBindCodes() {
            if (!confirm('ç¡®å®šè¦æ‰¹é‡åˆ é™¤æ‰€æœ‰æµ‹è¯•ç»‘å®šç å—ï¼Ÿ\nâš ï¸ è¿™å°†åˆ é™¤æ‰€æœ‰æè¿°ä¸­åŒ…å«"æµ‹è¯•"çš„ç»‘å®šç ï¼ˆåŒ…æ‹¬å·²ä½¿ç”¨çš„ï¼‰ï¼\nâš ï¸ å·²ä½¿ç”¨çš„ç»‘å®šç å°†åŒæ—¶åˆ é™¤ç›¸å…³å•†å®¶è®°å½•ï¼')) return;

            try {
                showLoading();
                const response = await apiRequest('/api/bind-codes/batch-delete-test', 'DELETE');
                
                showAlert(response.message || 'æ‰¹é‡åˆ é™¤æˆåŠŸ');
                await loadBindCodes();
                // å¦‚æœåˆ é™¤äº†å•†å®¶ï¼Œä¹Ÿè¦åˆ·æ–°å•†å®¶åˆ—è¡¨
                if (response.data && response.data.deletedMerchants > 0) {
                    await loadMerchants();
                }
            } catch (error) {
                showAlert('æ‰¹é‡åˆ é™¤æµ‹è¯•ç»‘å®šç å¤±è´¥: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // åŠ è½½åœ°åŒºæ•°æ®
        async function loadRegions() {
            try {
                regions = await apiRequest('/api/regions');
                renderRegions();
            } catch (error) {
                console.error('åŠ è½½åœ°åŒºå¤±è´¥:', error);
            }
        }

        // æ¸²æŸ“åœ°åŒºåˆ—è¡¨
        function renderRegions() {
            const container = document.getElementById('regionsList');
            if (!container) return;

            if (regions.length === 0) {
                container.innerHTML = '<p>æš‚æ— åœ°åŒºé…ç½®</p>';
                return;
            }

            container.innerHTML = regions.map(region => {
                // è®¡ç®—ç»‘å®šåˆ°æ­¤åœ°åŒºçš„å•†å®¶æ•°é‡
                const merchantCount = merchants.filter(m => m.region_id === region.id).length;
                
                return `
                <div class="list-item">
                    <div class="list-item-content">
                        <strong>ğŸ“ ${region.name}</strong>
                        <div style="color: #666; font-size: 14px; margin-top: 5px;">
                                æ’åº: ${region.sort_order} | ç»‘å®šå•†å®¶: ${merchantCount} ä¸ª
                        </div>
                            ${merchantCount > 0 ? `<div style="margin-top: 5px;">
                                <span class="badge info">${merchantCount} ä¸ªå•†å®¶</span>
                            </div>` : ''}
                    </div>
                    <div class="list-item-actions">
                        <button class="btn btn-warning btn-small" onclick="editRegion(${region.id}, '${region.name}', ${region.sort_order})">ç¼–è¾‘</button>
                            <button class="btn btn-danger btn-small" onclick="deleteRegion(${region.id})" ${merchantCount > 0 ? 'title="æœ‰å•†å®¶ç»‘å®šï¼Œæ— æ³•åˆ é™¤"' : ''}>åˆ é™¤</button>
                    </div>
                </div>
                `;
            }).join('');
        }

        // åˆ›å»ºåœ°åŒº
        async function createRegion(event) {
            event.preventDefault();
            const name = document.getElementById('regionName').value;
            const sortOrder = parseInt(document.getElementById('regionSortOrder').value) || 0;

            try {
                showLoading();
                await apiRequest('/api/regions', 'POST', { name, sortOrder });
                showAlert('åœ°åŒºæ·»åŠ æˆåŠŸ');
                document.getElementById('regionName').value = '';
                document.getElementById('regionSortOrder').value = '0';
                await loadRegions();
            } catch (error) {
                showAlert('æ·»åŠ åœ°åŒºå¤±è´¥: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // ç¼–è¾‘åœ°åŒº
        function editRegion(id, currentName, currentSortOrder) {
            const name = prompt('è¯·è¾“å…¥æ–°çš„åœ°åŒºåç§°:', currentName);
            if (!name) return;

            const sortOrder = prompt('è¯·è¾“å…¥æ’åºé¡ºåº:', currentSortOrder);
            if (sortOrder === null) return;

            updateRegion(id, name, parseInt(sortOrder) || 0);
        }

        // æ›´æ–°åœ°åŒº
        async function updateRegion(id, name, sortOrder) {
            try {
                showLoading();
                await apiRequest('/api/regions', 'PUT', { id, name, sortOrder });
                showAlert('åœ°åŒºæ›´æ–°æˆåŠŸ');
                await loadRegions();
            } catch (error) {
                showAlert('æ›´æ–°åœ°åŒºå¤±è´¥: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // åˆ é™¤åœ°åŒº
        async function deleteRegion(id) {
            try {
                showLoading();
                
                // é¦–å…ˆæ£€æŸ¥ä¾èµ–å…³ç³»
                const dependencies = await apiRequest(`/api/regions/${id}/dependencies`);
                
                if (dependencies.merchants > 0) {
                    hideLoading();
                    showAlert(`æ— æ³•åˆ é™¤åœ°åŒºï¼šè¿˜æœ‰ ${dependencies.merchants} ä¸ªå•†å®¶ç»‘å®šåˆ°æ­¤åœ°åŒºã€‚è¯·å…ˆå°†è¿™äº›å•†å®¶è½¬ç§»åˆ°å…¶ä»–åœ°åŒºæˆ–åˆ é™¤å•†å®¶åå†åˆ é™¤åœ°åŒºã€‚`, 'error');
                    return;
                }
                
                if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªåœ°åŒºå—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
                    hideLoading();
                    return;
                }

                // åˆ é™¤åœ°åŒº - apiRequeståœ¨æˆåŠŸæ—¶ä¸ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œæ‰€ä»¥ç›´æ¥è®¤ä¸ºæˆåŠŸ
                await apiRequest('/api/regions', 'DELETE', { id });
                
                showAlert('åœ°åŒºåˆ é™¤æˆåŠŸ');
                await loadRegions();
                await loadMerchants(); // åˆ·æ–°å•†å®¶åˆ—è¡¨
                
            } catch (error) {
                showAlert('åˆ é™¤åœ°åŒºå¤±è´¥: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // åŠ è½½ç»Ÿè®¡æ•°æ®
        async function loadStats() {
            try {
                console.log('å¼€å§‹åŠ è½½ç»Ÿè®¡æ•°æ®...');
                
                // è·å–8ä¸ªæ ¸å¿ƒè®¢å•æŒ‡æ ‡
                const orderStats = await apiRequest('/api/stats/optimized');
                console.log('è·å–è®¢å•ç»Ÿè®¡æ•°æ®:', orderStats);
                
                // è·å–åŸºç¡€ç³»ç»Ÿæ•°æ®
                const basicStats = await apiRequest('/api/stats');
                console.log('è·å–åŸºç¡€ç»Ÿè®¡æ•°æ®:', basicStats);
                
                // æ›´æ–°8ä¸ªæ ¸å¿ƒè®¢å•æŒ‡æ ‡
                document.getElementById('totalOrders').textContent = orderStats.totalOrders || 0;
                document.getElementById('bookedOrders').textContent = orderStats.bookedOrders || 0;
                document.getElementById('incompleteOrders').textContent = orderStats.incompleteOrders || 0;
                document.getElementById('completedOrders').textContent = orderStats.completedOrders || 0;
                document.getElementById('avgPrice').textContent = orderStats.avgPrice ? `Â¥${orderStats.avgPrice}` : 'Â¥0';
                document.getElementById('avgUserRating').textContent = orderStats.avgUserRating > 0 ? `${orderStats.avgUserRating}/10` : '-';
                document.getElementById('avgMerchantRating').textContent = orderStats.avgMerchantRating > 0 ? `${orderStats.avgMerchantRating}/10` : '-';
                document.getElementById('completionRate').textContent = `${orderStats.completionRate || 0}%`;
                
                // æ›´æ–°åŸºç¡€ç³»ç»Ÿæ•°æ®
                document.getElementById('totalMerchants').textContent = basicStats.totalMerchants || 0;
                document.getElementById('totalBindCodes').textContent = basicStats.totalBindCodes || 0;
                document.getElementById('totalRegions').textContent = basicStats.totalRegions || 0;
                document.getElementById('totalTemplates').textContent = basicStats.totalTemplates || 0;
                document.getElementById('totalClicks').textContent = basicStats.totalClicks || 0;
                
                console.log('ç»Ÿè®¡æ•°æ®åŠ è½½å®Œæˆ');
            } catch (error) {
                console.error('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
            }
        }

        // åŠ è½½å•†å®¶é¢„çº¦ç»Ÿè®¡
        async function loadMerchantBookingStats() {
            try {
                const stats = await apiRequest('/api/merchant-bookings');
                const container = document.getElementById('merchantBookingStats');
                
                if (stats.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #666;">æš‚æ— é¢„çº¦è®°å½•</p>';
                    return;
                }

                // è®¡ç®—æ€»é¢„çº¦æ•°
                const totalBookings = stats.reduce((sum, merchant) => sum + merchant.booking_count, 0);
                document.getElementById('totalBookings').textContent = totalBookings;

                container.innerHTML = stats.map(merchant => {
                    const bookingDetails = merchant.booking_details ? 
                        merchant.booking_details.split('; ').filter(detail => detail.trim()).map(detail => {
                            const [username, courseType, time] = detail.split('|');
                            return `<div style="font-size: 12px; color: #666; margin: 2px 0;">
                                ${username} - ${courseType} - ${time}
                            </div>`;
                        }).join('') : '';

                    return `
                        <div class="list-item">
                            <div class="list-item-content">
                                <strong>ğŸ‘¨â€ğŸ« ${merchant.teacher_name || 'æœªçŸ¥è€å¸ˆ'}</strong>
                                <div style="color: #666; font-size: 14px; margin-top: 5px;">
                                    ğŸ“ åœ°åŒº: ${merchant.region_name || 'æœªè®¾ç½®'}
                                </div>
                                <div style="margin-top: 8px;">
                                    <span class="badge success">é¢„çº¦æ¬¡æ•°: ${merchant.booking_count}</span>
                                </div>
                                ${bookingDetails ? `<div style="margin-top: 10px; border-top: 1px solid #eee; padding-top: 8px;">
                                    <strong style="font-size: 12px;">é¢„çº¦è¯¦æƒ…:</strong>
                                    ${bookingDetails}
                                </div>` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('åŠ è½½å•†å®¶é¢„çº¦ç»Ÿè®¡å¤±è´¥:', error);
                document.getElementById('merchantBookingStats').innerHTML = '<p style="color: red;">åŠ è½½å¤±è´¥</p>';
            }
        }

        // åŠ è½½æ¶ˆæ¯ç»Ÿè®¡
        async function loadMessageStats() {
            try {
                const stats = await apiRequest('/api/message-stats');
                const container = document.getElementById('messageStats');
                
                if (stats.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #666;">æš‚æ— æ¶ˆæ¯äº’åŠ¨è®°å½•</p>';
                    return;
                }

                container.innerHTML = stats.map(stat => {
                    const actionTypeText = {
                        'click': 'æŒ‰é’®ç‚¹å‡»',
                        'template_click': 'æ¨¡æ¿ç‚¹å‡»',
                        'view': 'æ¶ˆæ¯æµè§ˆ'
                    }[stat.action_type] || stat.action_type;

                    return `
                        <div class="list-item">
                            <div class="list-item-content">
                                <strong>ğŸ“Š ${actionTypeText}</strong>
                                <div style="color: #666; font-size: 14px; margin-top: 5px;">
                                    ğŸ’¬ ç¾¤ç»„ID: ${stat.chat_id}
                                </div>
                                <div style="color: #666; font-size: 14px;">
                                    ğŸ‘¥ ç‹¬ç«‹ç”¨æˆ·: ${stat.unique_users} äºº
                                </div>
                                <div style="color: #666; font-size: 14px;">
                                    ğŸ•’ æœ€åäº’åŠ¨: ${stat.last_interaction || 'æœªçŸ¥'}
                                </div>
                                <div style="margin-top: 8px;">
                                    <span class="badge info">æ€»æ¬¡æ•°: ${stat.count}</span>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('åŠ è½½æ¶ˆæ¯ç»Ÿè®¡å¤±è´¥:', error);
                document.getElementById('messageStats').innerHTML = '<p style="color: red;">åŠ è½½å¤±è´¥</p>';
            }
        }

        // åŠ è½½æœ€è¿‘é¢„çº¦è®°å½•
        async function loadRecentBookings() {
            try {
                const bookings = await apiRequest('/api/recent-bookings');
                const container = document.getElementById('recentBookings');
                
                if (bookings.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #666;">æš‚æ— æœ€è¿‘é¢„çº¦è®°å½•</p>';
                    return;
                }

                container.innerHTML = bookings.map(booking => {
                    // æ„å»ºç”¨æˆ·æ˜¾ç¤ºåç§°
                    const fullName = `${booking.first_name || ''} ${booking.last_name || ''}`.trim() || 'æœªè®¾ç½®åç§°';
                    const username = booking.username ? `@${booking.username}` : 'æœªè®¾ç½®ç”¨æˆ·å';
                    const displayName = `${fullName}ï¼ˆ${username}ï¼‰`;
                    
                    return `
                        <div class="list-item">
                            <div class="list-item-content">
                                <strong>ğŸ‘¤ ${displayName}</strong>
                                <div style="color: #666; font-size: 14px; margin-top: 5px;">
                                    ğŸ‘¨â€ğŸ« é¢„çº¦è€å¸ˆ: ${booking.teacher_name || 'æœªçŸ¥'}
                                </div>
                                <div style="color: #666; font-size: 14px;">
                                    ğŸ“ åœ°åŒº: ${booking.region_name || 'æœªè®¾ç½®'}
                                </div>
                                <div style="color: #666; font-size: 14px;">
                                    ğŸ•’ é¢„çº¦æ—¶é—´: ${booking.booking_time}
                                </div>
                                <div style="margin-top: 8px;">
                                    <span class="badge info">${booking.course_type}</span>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('åŠ è½½æœ€è¿‘é¢„çº¦è®°å½•å¤±è´¥:', error);
                document.getElementById('recentBookings').innerHTML = '<p style="color: red;">åŠ è½½å¤±è´¥</p>';
            }
        }

        // åŠ è½½æŒ‰é’®ç‚¹å‡»ç»Ÿè®¡
        async function loadButtonStats() {
            try {
                const stats = await apiRequest('/api/button-stats');
                const container = document.getElementById('buttonStats');
                
                if (stats.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #666;">æš‚æ— æŒ‰é’®ç‚¹å‡»è®°å½•</p>';
                    return;
                }

                container.innerHTML = stats.map(button => `
                    <div class="list-item">
                        <div class="list-item-content">
                            <strong>ğŸ”˜ ${button.title}</strong>
                            <div style="color: #666; font-size: 14px; margin-top: 5px;">
                                ğŸ‘¨â€ğŸ« å…³è”å•†å®¶: ${button.merchant_name || 'æ— '}
                            </div>
                            <div style="color: #666; font-size: 14px;">
                                ğŸ•’ æœ€åç‚¹å‡»: ${button.last_click || 'ä»æœªç‚¹å‡»'}
                            </div>
                            <div style="margin-top: 8px;">
                                <span class="badge success">ç‚¹å‡»æ¬¡æ•°: ${button.click_count}</span>
                                <span class="badge info">äº’åŠ¨è®°å½•: ${button.interaction_count}</span>
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('åŠ è½½æŒ‰é’®ç»Ÿè®¡å¤±è´¥:', error);
                document.getElementById('buttonStats').innerHTML = '<p style="color: red;">åŠ è½½å¤±è´¥</p>';
            }
        }

        // åŠ è½½å•†å®¶æ•°æ®
        async function loadMerchants() {
            try {
                // æ·»åŠ æ—¶é—´æˆ³é¿å…æµè§ˆå™¨ç¼“å­˜
                const timestamp = Date.now();
                merchants = await apiRequest(`/api/merchants?t=${timestamp}`);
                renderMerchants();
                updateSelects(); // æ›´æ–°ä¸‹æ‹‰é€‰æ‹©æ¡†
            } catch (error) {
                console.error('åŠ è½½å•†å®¶æ•°æ®å¤±è´¥:', error);
                showAlert('åŠ è½½å•†å®¶æ•°æ®å¤±è´¥: ' + error.message, 'error');
                document.getElementById('merchantsList').innerHTML = '<p style="color: red;">åŠ è½½å•†å®¶æ•°æ®å¤±è´¥</p>';
            }
        }

        // æ¸²æŸ“å•†å®¶åˆ—è¡¨
        function renderMerchants() {
            const container = document.getElementById('merchantsList');
            if (!container) return;

            if (merchants.length === 0) {
                container.innerHTML = '<p>æš‚æ— å•†å®¶æ•°æ®</p>';
                return;
            }

            container.innerHTML = merchants.map(merchant => {
                // ç”Ÿæˆå•†å®¶è·³è½¬URLé“¾æ¥
                const merchantUrl = `https://t.me/${window.BOT_USERNAME}?start=merchant_${merchant.id}`;
                
                return `
                <div class="list-item">
                    <div class="list-item-content">
                        <strong>ğŸ‘¨â€ğŸ« ${merchant.teacher_name || 'æœªçŸ¥è€å¸ˆ'}</strong>
                        <div class="merchant-info">
                            <span class="info-item">ğŸ“ åœ°åŒº: ${merchant.region_name || 'æœªè®¾ç½®'}</span>
                            <span class="info-item">ğŸ“ è”ç³»æ–¹å¼: ${merchant.contact || 'æœªè®¾ç½®'}</span>
                            <span class="info-item">ğŸ’° ä»·æ ¼: ${merchant.price1 || 'æœªè®¾ç½®'}p / ${merchant.price2 || 'æœªè®¾ç½®'}pp</span>
                            <span class="info-item">ğŸ‘¤ ç”¨æˆ·ID: ${merchant.user_id || 'æœªç»‘å®š'}</span>
                            <span class="info-item">ğŸ“± ç”¨æˆ·å: ${merchant.username ? '@' + merchant.username : 'æœªè®¾ç½®'}</span>
                            <span class="info-item">ğŸ”— ç»‘å®šç : ${merchant.bind_code || 'æ— '}</span>
                            <span class="info-item status-${merchant.status}">
                                ğŸ“Š çŠ¶æ€: ${merchant.status === 'active' ? 'âœ… æ¿€æ´»' : 'âŒ åœç”¨'}
                            </span>
                            <span class="info-item">
                                ğŸ“‹ ç»‘å®šæ­¥éª¤: ${merchant.bind_step}/5
                            </span>
                        </div>
                        <div style="margin-top: 10px; padding: 10px; background: #f0f8ff; border-radius: 5px; border-left: 4px solid #007bff;">
                            <strong style="color: #007bff;">ğŸ”— é¢‘é“æ¨å¹¿é“¾æ¥ï¼š</strong>
                            <div style="margin-top: 5px;">
                                <input type="text" value="${merchantUrl}" readonly 
                                       style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 3px; font-family: monospace; font-size: 12px;" 
                                       onclick="this.select()" title="ç‚¹å‡»é€‰æ‹©å…¨éƒ¨">
                            </div>
                            <div style="margin-top: 5px; display: flex; gap: 5px;">
                                <button class="btn btn-small" style="background: #28a745; color: white;" onclick="copyMerchantUrl('${merchantUrl}')">ğŸ“‹ å¤åˆ¶é“¾æ¥</button>
                                <button class="btn btn-small" style="background: #17a2b8; color: white;" onclick="openMerchantUrl('${merchantUrl}')">ğŸ”— æµ‹è¯•é“¾æ¥</button>
                            </div>
                            <div style="margin-top: 3px; font-size: 11px; color: #666;">
                                ğŸ’¡ ç”¨æˆ·ç‚¹å‡»æ­¤é“¾æ¥å¯ç›´æ¥è·³è½¬åˆ°æœºå™¨äººæŸ¥çœ‹å•†å®¶ä¿¡æ¯å¹¶å¼€å§‹çº¦è¯¾æµç¨‹
                            </div>
                        </div>
                    </div>
                    <div class="list-item-actions">
                        <button class="btn btn-primary btn-small" onclick="editMerchant(${merchant.id})">ç¼–è¾‘</button>
                        <button class="btn ${merchant.status === 'active' ? 'btn-warning' : 'btn-success'} btn-small" 
                                onclick="toggleMerchantStatus(${merchant.id}, '${merchant.status}')">
                            ${merchant.status === 'active' ? 'åœç”¨' : 'æ¿€æ´»'}
                        </button>
                        <button class="btn btn-danger btn-small" onclick="deleteMerchant(${merchant.id})">åˆ é™¤</button>
                    </div>
                </div>
            `;
            }).join('');
        }

        // éªŒè¯ç®¡ç†å‘˜å¯†ç 
        async function verifyAdminPassword(password, actionName = 'æ“ä½œ') {
            try {
                const response = await fetch('/api/admin/verify-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ password })
                });
                
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error('éªŒè¯è¯·æ±‚å¤±è´¥');
                }
                
                return result.valid;
            } catch (error) {
                console.error('å¯†ç éªŒè¯å¤±è´¥:', error);
                showAlert(`å¯†ç éªŒè¯å¤±è´¥: ${error.message}`, 'error');
                return false;
            }
        }

        // ç¼–è¾‘å•†å®¶ä¿¡æ¯
        async function editMerchant(id) {
            // éªŒè¯ç®¡ç†å‘˜å¯†ç 
            const password = prompt('è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç ä»¥è¿›è¡Œç¼–è¾‘æ“ä½œï¼š');
            if (!password) {
                return;
            }
            
            const isValid = await verifyAdminPassword(password, 'ç¼–è¾‘å•†å®¶');
            if (!isValid) {
                showAlert('ç®¡ç†å‘˜å¯†ç é”™è¯¯ï¼Œç¼–è¾‘æ“ä½œå·²å–æ¶ˆ', 'error');
                return;
            }

            const merchant = merchants.find(m => m.id == id); // ä½¿ç”¨æ¾æ•£æ¯”è¾ƒï¼Œé¿å…ç±»å‹é—®é¢˜
            if (!merchant) return;

            // å¡«å……åŸºæœ¬ä¿¡æ¯
            document.getElementById('editMerchantId').value = id;
            document.getElementById('editTeacherName').value = merchant.teacher_name || '';
            document.getElementById('editRegionId').value = merchant.region_id || '';
            document.getElementById('editContact').value = merchant.contact || '';
            document.getElementById('editChannelLink').value = merchant.channel_link || '';
            document.getElementById('editBindCode').value = merchant.bind_code || '';
            
            // å¡«å……æ¨¡æ¿ä¿¡æ¯
            document.getElementById('editAdvantages').value = merchant.advantages || '';
            document.getElementById('editDisadvantages').value = merchant.disadvantages || '';
            document.getElementById('editPrice1').value = merchant.price1 || '';
            document.getElementById('editPrice2').value = merchant.price2 || '';
            document.getElementById('editWash').value = merchant.skill_wash || '';
            document.getElementById('editBlow').value = merchant.skill_blow || '';
            document.getElementById('editDo').value = merchant.skill_do || '';
            document.getElementById('editKiss').value = merchant.skill_kiss || '';
            
            // æ›´æ–°åœ°åŒºé€‰æ‹©æ¡†
            const regionSelect = document.getElementById('editRegionId');
            regionSelect.innerHTML = '<option value="">é€‰æ‹©åœ°åŒº</option>' + 
                regions.map(r => `<option value="${r.id}" ${r.id === merchant.region_id ? 'selected' : ''}>${r.name}</option>`).join('');
            
            // æ›´æ–°åœ°åŒºå‰ç¼€æ˜¾ç¤º
            updateRegionPrefix();
            
            // å¡«å……å›¾ç‰‡ä¿¡æ¯
            if (merchant.image_url) {
                showImagePreview(merchant.image_url);
                window.currentMerchantImageData = merchant.image_url;
            } else {
                hideImagePreview();
                window.currentMerchantImageData = null;
            }
            
            // å­˜å‚¨åŸå§‹è”ç³»æ–¹å¼ç”¨äº"ä½¿ç”¨ç»‘å®šè”ç³»æ–¹å¼"åŠŸèƒ½
            window.currentMerchantBindContact = merchant.contact;
            
            document.getElementById('merchantEditModal').style.display = 'block';
        }

        // å…³é—­ç¼–è¾‘æ¨¡æ€æ¡†
        function closeMerchantEditModal() {
            document.getElementById('merchantEditModal').style.display = 'none';
        }

        // æ›´æ–°åœ°åŒºå‰ç¼€æ˜¾ç¤º
        function updateRegionPrefix() {
            const regionSelect = document.getElementById('editRegionId');
            const regionPrefix = document.getElementById('regionPrefix');
            
            if (regionSelect.value) {
                const selectedRegion = regions.find(r => r.id == regionSelect.value);
                if (selectedRegion) {
                    regionPrefix.textContent = selectedRegion.name;
                } else {
                    regionPrefix.textContent = 'xx';
                }
            } else {
                regionPrefix.textContent = 'xx';
            }
        }

        // ä½¿ç”¨ç»‘å®šè”ç³»æ–¹å¼
        function useBindContact() {
            const contactInput = document.getElementById('editContact');
            if (window.currentMerchantBindContact) {
                contactInput.value = window.currentMerchantBindContact;
                showAlert('å·²å¡«å…¥ç»‘å®šæ—¶çš„è”ç³»æ–¹å¼', 'info');
            } else {
                showAlert('æœªæ‰¾åˆ°ç»‘å®šæ—¶çš„è”ç³»æ–¹å¼', 'warning');
            }
        }

        // ç”Ÿæˆæ–°ç»‘å®šç 
        async function generateNewBindCode() {
            try {
                showLoading();
                const response = await apiRequest('/api/bind-codes', 'POST', {
                    description: 'å•†å®¶ç¼–è¾‘-æ‰‹åŠ¨ç”Ÿæˆ'
                });
                
                // ä½¿ç”¨ä¸ç»‘å®šç ç®¡ç†é¡µé¢å®Œå…¨ç›¸åŒçš„å“åº”å¤„ç†é€»è¾‘
                let bindCode = null;
                if (response && response.success && response.data && response.data.code) {
                    bindCode = response.data.code;
                } else if (response && response.code) {
                    bindCode = response.code;
                } else {
                    console.error('å“åº”æ ¼å¼é”™è¯¯:', response);
                    throw new Error('ç”Ÿæˆç»‘å®šç å¤±è´¥ï¼šæœåŠ¡å™¨å“åº”æ ¼å¼é”™è¯¯');
                }
                
                document.getElementById('editBindCode').value = bindCode;
                showAlert('æ–°ç»‘å®šç ç”ŸæˆæˆåŠŸ', 'success');
                
                // åˆ·æ–°ç»‘å®šç åˆ—è¡¨ä»¥ä¿æŒæ•°æ®åŒæ­¥
                await loadBindCodes();
            } catch (error) {
                console.error('ç”Ÿæˆç»‘å®šç å¤±è´¥:', error);
                showAlert('ç”Ÿæˆç»‘å®šç å¤±è´¥: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // æ¸…é™¤ç»‘å®šç 
        function clearBindCode() {
            if (confirm('ç¡®å®šè¦æ¸…é™¤å½“å‰ç»‘å®šç å—ï¼Ÿæ¸…é™¤åå•†å®¶å°†æ— æ³•ä½¿ç”¨æ­¤ç»‘å®šç è¿›è¡Œç»‘å®šã€‚')) {
                document.getElementById('editBindCode').value = '';
                showAlert('ç»‘å®šç å·²æ¸…é™¤', 'info');
            }
        }

        // å¤„ç†å›¾ç‰‡æ–‡ä»¶ä¸Šä¼ 
        async function handleImageFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // æ£€æŸ¥æ–‡ä»¶ç±»å‹
            if (!file.type.startsWith('image/')) {
                showAlert('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶', 'error');
                return;
            }

            // æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆé™åˆ¶ä¸º5MBï¼‰
            if (file.size > 5 * 1024 * 1024) {
                showAlert('å›¾ç‰‡æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡5MB', 'error');
                return;
            }

            try {
                showLoading();
                
                // å°†å›¾ç‰‡è½¬æ¢ä¸ºbase64
                const base64 = await fileToBase64(file);
                
                // æ˜¾ç¤ºé¢„è§ˆ
                showImagePreview(base64);
                
                // å°†base64æ•°æ®å­˜å‚¨åˆ°å…¨å±€å˜é‡ä¸­ï¼Œä¿å­˜æ—¶ä¸€èµ·æäº¤
                window.currentMerchantImageData = base64;
                
                hideLoading();
                showAlert('å›¾ç‰‡å·²é€‰æ‹©ï¼Œç‚¹å‡»ä¿å­˜æŒ‰é’®å®Œæˆä¸Šä¼ ', 'success');
                
            } catch (error) {
                hideLoading();
                console.error('å›¾ç‰‡å¤„ç†é”™è¯¯:', error);
                showAlert('å›¾ç‰‡å¤„ç†å¤±è´¥: ' + error.message, 'error');
            }
        }

        // å°†æ–‡ä»¶è½¬æ¢ä¸ºbase64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // æ˜¾ç¤ºå›¾ç‰‡é¢„è§ˆ
        function showImagePreview(imageUrl) {
            const preview = document.getElementById('imagePreview');
            const img = document.getElementById('previewImage');
            
            img.src = imageUrl;
            img.onload = function() {
                preview.style.display = 'block';
            };
            img.onerror = function() {
                preview.style.display = 'none';
                showAlert('å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥URLæ˜¯å¦æ­£ç¡®', 'warning');
            };
        }

        // éšè—å›¾ç‰‡é¢„è§ˆ
        function hideImagePreview() {
            document.getElementById('imagePreview').style.display = 'none';
        }

        // æ¸…é™¤å•†å®¶å›¾ç‰‡
        function clearMerchantImage() {
            if (confirm('ç¡®å®šè¦æ¸…é™¤å•†å®¶å›¾ç‰‡å—ï¼Ÿ')) {
                document.getElementById('editImageFile').value = '';
                window.currentMerchantImageData = null;
                hideImagePreview();
                showAlert('å›¾ç‰‡å·²æ¸…é™¤', 'info');
            }
        }

        // é¢„è§ˆå•†å®¶ä¿¡æ¯
        function previewMerchantInfo() {
            const regionSelect = document.getElementById('editRegionId');
            const selectedRegion = regions.find(r => r.id == regionSelect.value);
            const regionName = selectedRegion ? selectedRegion.name : 'xx';
            
            const teacherName = document.getElementById('editTeacherName').value || 'æœªå¡«å†™';
            const advantages = document.getElementById('editAdvantages').value || 'æœªå¡«å†™';
            const disadvantages = document.getElementById('editDisadvantages').value || 'æœªå¡«å†™';
            const price1 = document.getElementById('editPrice1').value || 'æœªå¡«å†™';
            const price2 = document.getElementById('editPrice2').value || 'æœªå¡«å†™';
            const contact = document.getElementById('editContact').value || 'æœªå¡«å†™';
            const skillWash = document.getElementById('editWash').value || 'æœªå¡«å†™';
            const skillBlow = document.getElementById('editBlow').value || 'æœªå¡«å†™';
            const skillDo = document.getElementById('editDo').value || 'æœªå¡«å†™';
            const skillKiss = document.getElementById('editKiss').value || 'æœªå¡«å†™';
            const imageData = window.currentMerchantImageData;

            const preview = `åœ°åŒºï¼š#${regionName}              è‰ºåï¼š${teacherName}
ä¼˜ç‚¹ï¼š${advantages}
ç¼ºç‚¹ï¼š${disadvantages}
ä»·æ ¼ï¼š${price1}p              ${price2}pp
è”ç³»ï¼š${contact}

è€å¸ˆğŸ’ƒè‡ªå¡«åŸºæœ¬åŠŸï¼š
ğŸ’¦æ´—:${skillWash}
ğŸ‘„å¹:${skillBlow}
â¤ï¸åš:${skillDo}
ğŸå»:${skillKiss}`;

            const previewContainer = document.getElementById('merchantInfoPreview');
            
            // å¦‚æœæœ‰å›¾ç‰‡ï¼Œæ˜¾ç¤ºå›¾ç‰‡é¢„è§ˆ
            if (imageData) {
                previewContainer.innerHTML = `
                    <div style="margin-bottom: 15px;">
                        <img src="${imageData}" style="max-width: 200px; max-height: 200px; border-radius: 5px; border: 1px solid #ddd;" onerror="this.style.display='none'">
                    </div>
                    <pre style="white-space: pre-line; font-family: monospace; margin: 0;">${preview}</pre>
                `;
            } else {
                previewContainer.innerHTML = `<pre style="white-space: pre-line; font-family: monospace; margin: 0;">${preview}</pre>`;
            }
        }

        // æ›´æ–°å•†å®¶ä¿¡æ¯
        async function updateMerchant(event) {
            event.preventDefault();
            
            const id = document.getElementById('editMerchantId').value;
            const teacherName = document.getElementById('editTeacherName').value;
            const regionId = document.getElementById('editRegionId').value;
            const contact = document.getElementById('editContact').value;
            const channelLink = document.getElementById('editChannelLink').value;
            const bindCode = document.getElementById('editBindCode').value;
            const advantages = document.getElementById('editAdvantages').value;
            const disadvantages = document.getElementById('editDisadvantages').value;
            const price1 = document.getElementById('editPrice1').value ? parseInt(document.getElementById('editPrice1').value) : null;
            const price2 = document.getElementById('editPrice2').value ? parseInt(document.getElementById('editPrice2').value) : null;
            const skillWash = document.getElementById('editWash').value;
            const skillBlow = document.getElementById('editBlow').value;
            const skillDo = document.getElementById('editDo').value;
            const skillKiss = document.getElementById('editKiss').value;
            const imageData = window.currentMerchantImageData;

            try {
                showLoading();
                await apiRequest(`/api/merchants/${id}`, 'PUT', {
                    teacherName,
                    regionId,
                    contact,
                    channelLink,
                    bindCode,
                    advantages,
                    disadvantages,
                    price1,
                    price2,
                    skillWash,
                    skillBlow,
                    skillDo,
                    skillKiss,
                    imageData
                });
                showAlert('å•†å®¶ä¿¡æ¯æ¨¡æ¿æ›´æ–°æˆåŠŸ');
                closeMerchantEditModal();
                await loadMerchants();
            } catch (error) {
                showAlert('æ›´æ–°å•†å®¶ä¿¡æ¯å¤±è´¥: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // æš‚åœ/å¯åŠ¨å•†å®¶
        async function toggleMerchantStatus(id, status) {
            console.log('toggleMerchantStatus è°ƒç”¨:', { id, idType: typeof id, merchantsLength: merchants.length, merchants });
            const merchant = merchants.find(m => m.id == id); // ä½¿ç”¨æ¾æ•£æ¯”è¾ƒï¼Œé¿å…ç±»å‹é—®é¢˜
            console.log('æ‰¾åˆ°çš„å•†å®¶:', merchant);
            if (!merchant) {
                console.error('æœªæ‰¾åˆ°å•†å®¶ï¼ŒID:', id);
                showAlert('æœªæ‰¾åˆ°æŒ‡å®šçš„å•†å®¶ï¼Œè¯·åˆ·æ–°é¡µé¢åé‡è¯•', 'error');
                return;
            }

            const action = status === 'active' ? 'æš‚åœ' : 'å¯åŠ¨';
            
            // éªŒè¯ç®¡ç†å‘˜å¯†ç 
            const password = prompt(`è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç ä»¥${action}å•†å®¶ï¼š`);
            if (!password) {
                return;
            }
            
            const isValid = await verifyAdminPassword(password, action + 'å•†å®¶');
            if (!isValid) {
                showAlert('ç®¡ç†å‘˜å¯†ç é”™è¯¯ï¼Œæ“ä½œå·²å–æ¶ˆ', 'error');
                return;
            }

            if (!confirm(`ç¡®å®šè¦${action}è¿™ä¸ªå•†å®¶å—ï¼Ÿ`)) return;

            try {
                showLoading();
                await apiRequest(`/api/merchants/${id}/toggle-status`, 'POST');
                showAlert(`å•†å®¶${action}æˆåŠŸ`);
                await loadMerchants();
            } catch (error) {
                showAlert(`${action}å•†å®¶å¤±è´¥: ` + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // åˆ é™¤å•†å®¶
        async function deleteMerchant(id) {
            // æ‰¾åˆ°è¦åˆ é™¤çš„å•†å®¶
            const merchant = merchants.find(m => m.id == id); // ä½¿ç”¨æ¾æ•£æ¯”è¾ƒï¼Œé¿å…ç±»å‹é—®é¢˜
            if (!merchant) {
                showAlert('æœªæ‰¾åˆ°æŒ‡å®šçš„å•†å®¶', 'error');
                return;
            }

            if (!confirm(`ç¡®å®šè¦åˆ é™¤å•†å®¶"${merchant.teacher_name}"å—ï¼Ÿ\n\nâš ï¸ è¿™å°†åŒæ—¶åˆ é™¤ï¼š\n- ç›¸å…³çš„æŒ‰é’®æ•°æ®\n- ç›¸å…³çš„äº¤äº’è®°å½•\n- ç›¸å…³çš„é¢„çº¦æ•°æ®\n\næ­¤æ“ä½œä¸å¯æ’¤é”€ï¼`)) return;

            // éªŒè¯ç®¡ç†å‘˜å¯†ç 
            const password = prompt('è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç ä»¥ç¡®è®¤åˆ é™¤æ“ä½œï¼š');
            if (!password) {
                return;
            }
            
            const isValid = await verifyAdminPassword(password, 'åˆ é™¤å•†å®¶');
            if (!isValid) {
                showAlert('ç®¡ç†å‘˜å¯†ç é”™è¯¯ï¼Œåˆ é™¤æ“ä½œå·²å–æ¶ˆ', 'error');
                return;
            }

            try {
                console.log(`å¼€å§‹åˆ é™¤å•†å®¶: ID=${id}, å§“å=${merchant.teacher_name}`);
                showLoading();
                
                // å…ˆæ£€æŸ¥ä¾èµ–å…³ç³»
                console.log('æ£€æŸ¥å•†å®¶ä¾èµ–å…³ç³»...');
                const checkResponse = await fetch(`/api/merchants/${id}/dependencies`);
                if (checkResponse.ok) {
                    const dependencies = await checkResponse.json();
                    if (dependencies.data && dependencies.data.total > 0) {
                        const details = [];
                        if (dependencies.data.orders > 0) details.push(`${dependencies.data.orders}ä¸ªè®¢å•`);
                        if (dependencies.data.bookingSessions > 0) details.push(`${dependencies.data.bookingSessions}ä¸ªé¢„çº¦`);
                        if (dependencies.data.buttons > 0) details.push(`${dependencies.data.buttons}ä¸ªæŒ‰é’®`);
                        
                        const confirmMessage = `è¯¥å•†å®¶æœ‰ä»¥ä¸‹ç›¸å…³æ•°æ®ï¼š\n${details.join('ã€')}\n\nç»§ç»­åˆ é™¤å°†æ¸…é™¤æ‰€æœ‰ç›¸å…³æ•°æ®ï¼Œç¡®å®šç»§ç»­å—ï¼Ÿ`;
                        if (!confirm(confirmMessage)) {
                            hideLoading();
                            return;
                        }
                    }
                }
                
                const response = await fetch(`/api/merchants/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTPé”™è¯¯: ${response.status} ${response.statusText}`);
                }

                const result = await response.json();
                console.log('åˆ é™¤APIå“åº”:', result);
                
                if (!result.success) {
                    throw new Error(result.error || result.message || 'åˆ é™¤å¤±è´¥');
                }

                showAlert(`å•†å®¶"${merchant.teacher_name}"åˆ é™¤æˆåŠŸ`, 'success');
                console.log('åˆ é™¤æˆåŠŸï¼Œå¼€å§‹é‡æ–°åŠ è½½æ•°æ®...');
                
                // æ¸…ç©ºæœ¬åœ°ç¼“å­˜
                merchants = [];
                buttons = [];
                
                // é‡æ–°åŠ è½½æ‰€æœ‰ç›¸å…³æ•°æ®
                await Promise.all([
                    loadMerchants(),
                    loadButtons(),
                    loadStats() // å¦‚æœå­˜åœ¨ç»Ÿè®¡æ•°æ®ä¹Ÿéœ€è¦åˆ·æ–°
                ]);
                
                console.log('æ•°æ®é‡æ–°åŠ è½½å®Œæˆ');
                
            } catch (error) {
                console.error('åˆ é™¤å•†å®¶å¤±è´¥:', error);
                
                // è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯å¤„ç†
                let errorMessage = 'åˆ é™¤å•†å®¶å¤±è´¥';
                if (error.message) {
                    if (error.message.includes('FOREIGN KEY constraint')) {
                        errorMessage = 'åˆ é™¤å¤±è´¥ï¼šè¯¥å•†å®¶ä»æœ‰ç›¸å…³æ•°æ®å¼•ç”¨ï¼Œè¯·å…ˆåˆ é™¤ç›¸å…³çš„è®¢å•ã€é¢„çº¦æˆ–å…¶ä»–å…³è”æ•°æ®';
                    } else if (error.message.includes('HTTPé”™è¯¯')) {
                        errorMessage = `ç½‘ç»œé”™è¯¯ï¼š${error.message}`;
                    } else {
                        errorMessage = `åˆ é™¤å¤±è´¥ï¼š${error.message}`;
                    }
                }
                
                showAlert(errorMessage, 'error');
            } finally {
                hideLoading();
            }
        }

        // åŠ è½½æŒ‰é’®æ•°æ®
        async function loadButtons() {
            const timestamp = Date.now();
            buttons = await apiRequest(`/api/buttons?t=${timestamp}`);
            renderButtons();
        }

        function renderButtons() {
            const container = document.getElementById('buttonsList');
            if (buttons.length === 0) {
                container.innerHTML = '<p>æš‚æ— æŒ‰é’®æ•°æ®</p>';
                return;
            }
            
            container.innerHTML = buttons.map(button => `
                <div class="list-item">
                    <div class="list-item-content">
                        <strong>${button.title}</strong>
                        <div>å•†å®¶: ${button.merchant_name || 'æœªå…³è”'}</div>
                        <div>ç‚¹å‡»æ¬¡æ•°: <span class="badge info">${button.click_count}</span></div>
                    </div>
                    <div class="list-item-actions">
                        <button onclick="deleteButton(${button.id})" class="btn btn-danger btn-small">åˆ é™¤</button>
                    </div>
                </div>
            `).join('');
        }

        // åŠ è½½æ¶ˆæ¯æ¨¡æ¿
        async function loadTemplates() {
            templates = await apiRequest('/api/templates');
            renderTemplates();
        }

        function renderTemplates() {
            const container = document.getElementById('templatesList');
            if (templates.length === 0) {
                container.innerHTML = '<p>æš‚æ— æ¨¡æ¿æ•°æ®</p>';
                return;
            }
            
            container.innerHTML = templates.map(template => `
                <div class="list-item">
                    <div class="list-item-content">
                        <strong>${template.name}</strong>
                        <div>${template.content.substring(0, 100)}${template.content.length > 100 ? '...' : ''}</div>
                        ${template.image_url ? '<div><span class="badge info">åŒ…å«å›¾ç‰‡</span></div>' : ''}
                        ${template.buttons_config ? '<div><span class="badge success">åŒ…å«æŒ‰é’®</span></div>' : ''}
                    </div>
                    <div class="list-item-actions">
                        <button onclick="deleteTemplate(${template.id})" class="btn btn-danger btn-small">åˆ é™¤</button>
                    </div>
                </div>
            `).join('');
        }

        // åŠ è½½è§¦å‘è¯
        async function loadTriggers() {
            triggers = await apiRequest('/api/triggers');
            renderTriggers();
        }

        function renderTriggers() {
            const container = document.getElementById('triggersList');
            if (triggers.length === 0) {
                container.innerHTML = '<p>æš‚æ— è§¦å‘è¯æ•°æ®</p>';
                return;
            }
            
            container.innerHTML = triggers.map(trigger => `
                <div class="list-item">
                    <div class="list-item-content">
                        <strong>"${trigger.word}"</strong>
                        <div>æ¨¡æ¿: ${trigger.template_name || 'æœªå…³è”'}</div>
                        <div>åŒ¹é…æ¨¡å¼: <span class="badge">${trigger.match_type === 'exact' ? 'ç²¾ç¡®åŒ¹é…' : 'åŒ…å«åŒ¹é…'}</span></div>
                        <div>ç¾¤ç»„ID: ${trigger.chat_id} | è§¦å‘æ¬¡æ•°: <span class="badge info">${trigger.trigger_count}</span></div>
                    </div>
                    <div class="list-item-actions">
                        <button onclick="deleteTrigger(${trigger.id})" class="btn btn-danger btn-small">åˆ é™¤</button>
                    </div>
                </div>
            `).join('');
        }

        // åŠ è½½å®šæ—¶ä»»åŠ¡
        async function loadTasks() {
            tasks = await apiRequest('/api/tasks');
            renderTasks();
        }

        function renderTasks() {
            const container = document.getElementById('tasksList');
            if (tasks.length === 0) {
                container.innerHTML = '<p>æš‚æ— å®šæ—¶ä»»åŠ¡</p>';
                return;
            }
            
            container.innerHTML = tasks.map(task => `
                <div class="list-item">
                    <div class="list-item-content">
                        <strong>${task.name}</strong>
                        <div>æ¨¡æ¿: ${task.template_name || 'æœªå…³è”'}</div>
                        <div>ç±»å‹: <span class="badge">${getScheduleTypeText(task.schedule_type)}</span> | æ—¶é—´: ${task.schedule_time}</div>
                        <div>ç¾¤ç»„ID: ${task.chat_id} | çŠ¶æ€: <span class="badge ${task.active ? 'success' : 'warning'}">${task.active ? 'å¯ç”¨' : 'æš‚åœ'}</span></div>
                    </div>
                    <div class="list-item-actions">
                        <button onclick="deleteTask(${task.id})" class="btn btn-danger btn-small">åˆ é™¤</button>
                    </div>
                </div>
            `).join('');
        }

        function getScheduleTypeText(type) {
            const types = {
                'daily': 'æ¯æ—¥æ‰§è¡Œ',
                'weekly': 'æ¯å‘¨æ‰§è¡Œ',
                'cron': 'è‡ªå®šä¹‰Cron'
            };
            return types[type] || type;
        }

        // æ›´æ–°ä¸‹æ‹‰é€‰æ‹©æ¡†
        function updateSelects() {
            // æ›´æ–°å•†å®¶é€‰æ‹©æ¡†
            const merchantSelects = document.querySelectorAll('#buttonMerchant, #testMerchant');
            merchantSelects.forEach(select => {
                const defaultOption = select.id === 'testMerchant' ? '<option value="">è¯·é€‰æ‹©å•†å®¶</option>' : '<option value="">é€‰æ‹©å•†å®¶</option>';
                select.innerHTML = defaultOption + 
                    merchants.map(m => `<option value="${m.id}">${m.teacher_name || 'æœªçŸ¥å•†å®¶'}</option>`).join('');
            });

            // æ›´æ–°æ¨¡æ¿é€‰æ‹©æ¡†
            const templateSelects = document.querySelectorAll('#triggerTemplate, #taskTemplate, #testTemplate');
            templateSelects.forEach(select => {
                const defaultOption = select.id === 'testTemplate' ? '<option value="">è¯·é€‰æ‹©æ¶ˆæ¯æ¨¡æ¿</option>' : '<option value="">é€‰æ‹©æ¶ˆæ¯æ¨¡æ¿</option>';
                select.innerHTML = defaultOption + 
                    templates.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
            });
        }

        // æŒ‰é’®æ„å»ºå™¨
        function addButtonRow() {
            buttonRowCount++;
            const container = document.getElementById('buttonRows');
            const rowDiv = document.createElement('div');
            rowDiv.className = 'button-row';
            rowDiv.innerHTML = `
                <input type="text" placeholder="æŒ‰é’®æ–‡å­—" class="button-text" style="flex: 1;">
                <input type="text" placeholder="å›è°ƒæ•°æ®(å¯é€‰)" class="button-callback" style="flex: 1;">
                <button type="button" onclick="removeButtonRow(this)" class="btn btn-danger btn-small">åˆ é™¤</button>
            `;
            container.appendChild(rowDiv);
        }

        function removeButtonRow(button) {
            button.parentElement.remove();
        }

        // é¢„è§ˆæ¨¡æ¿
        function previewTemplate() {
            const name = document.getElementById('templateName').value;
            const content = document.getElementById('templateContent').value;
            const imageUrl = document.getElementById('templateImage').value;
            
            if (!content) {
                showAlert('è¯·è¾“å…¥æ¶ˆæ¯å†…å®¹', 'error');
                return;
            }

            const previewDiv = document.getElementById('templatePreview');
            const previewContent = document.getElementById('previewContent');
            
            let html = '';
            if (imageUrl) {
                html += `<img src="${imageUrl}" alt="é¢„è§ˆå›¾ç‰‡" onerror="this.style.display='none'"><br>`;
            }
            html += `<div>${content}</div>`;
            
            // æ·»åŠ æŒ‰é’®é¢„è§ˆ
            const buttonRows = document.querySelectorAll('#buttonRows .button-row');
            if (buttonRows.length > 0) {
                html += '<div style="margin-top: 10px;">';
                buttonRows.forEach(row => {
                    const text = row.querySelector('.button-text').value;
                    if (text) {
                        html += `<span class="preview-button">${text}</span>`;
                    }
                });
                html += '</div>';
            }
            
            previewContent.innerHTML = html;
            previewDiv.style.display = 'block';
        }

        // æ›´æ–°è°ƒåº¦è¾“å…¥
        function updateScheduleInput() {
            const type = document.getElementById('taskScheduleType').value;
            const input = document.getElementById('taskScheduleTime');
            const label = document.getElementById('scheduleLabel');
            const help = document.getElementById('scheduleHelp');
            
            switch (type) {
                case 'daily':
                    label.textContent = 'æ‰§è¡Œæ—¶é—´';
                    input.placeholder = '09:00';
                    help.textContent = 'æ ¼å¼ï¼šHH:MMï¼ˆ24å°æ—¶åˆ¶ï¼‰';
                    break;
                case 'weekly':
                    label.textContent = 'æ‰§è¡Œæ—¶é—´';
                    input.placeholder = '1:09:00';
                    help.textContent = 'æ ¼å¼ï¼šæ˜ŸæœŸ:HH:MMï¼ˆæ˜ŸæœŸ1-7ï¼Œå‘¨æ—¥ä¸º0ï¼‰';
                    break;
                case 'cron':
                    label.textContent = 'Cronè¡¨è¾¾å¼';
                    input.placeholder = '0 9 * * *';
                    help.textContent = 'æ ¼å¼ï¼šåˆ† æ—¶ æ—¥ æœˆ å‘¨ï¼ˆæ ‡å‡†Cronæ ¼å¼ï¼‰';
                    break;
            }
        }



        // åˆ›å»ºæŒ‰é’®
        async function createButton(event) {
            event.preventDefault();
            showLoading();
            
            try {
                const title = document.getElementById('buttonTitle').value;
                const message = document.getElementById('buttonMessage').value;
                const merchantId = document.getElementById('buttonMerchant').value;
                
                await apiRequest('/api/buttons', 'POST', { title, message, merchantId });
                
                showAlert('æŒ‰é’®åˆ›å»ºæˆåŠŸï¼');
                document.getElementById('buttonTitle').value = '';
                document.getElementById('buttonMessage').value = '';
                document.getElementById('buttonMerchant').value = '';
                
                await loadButtons();
            } catch (error) {
                showAlert('åˆ›å»ºå¤±è´¥: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // åˆ›å»ºæ¶ˆæ¯æ¨¡æ¿
        async function createTemplate(event) {
            event.preventDefault();
            showLoading();
            
            try {
                const name = document.getElementById('templateName').value;
                const content = document.getElementById('templateContent').value;
                const imageUrl = document.getElementById('templateImage').value;
                
                // æ”¶é›†æŒ‰é’®é…ç½®
                const buttonRows = document.querySelectorAll('#buttonRows .button-row');
                const buttonsConfig = [];
                
                if (buttonRows.length > 0) {
                    const currentRow = [];
                    buttonRows.forEach(row => {
                        const text = row.querySelector('.button-text').value;
                        const callback = row.querySelector('.button-callback').value;
                        if (text) {
                            currentRow.push({
                                text: text,
                                callback_data: callback || `template_btn_${text}`
                            });
                        }
                    });
                    if (currentRow.length > 0) {
                        buttonsConfig.push(currentRow);
                    }
                }
                
                await apiRequest('/api/templates', 'POST', {
                    name, content, imageUrl, buttonsConfig
                });
                
                showAlert('æ¨¡æ¿åˆ›å»ºæˆåŠŸï¼');
                document.getElementById('templateName').value = '';
                document.getElementById('templateContent').value = '';
                document.getElementById('templateImage').value = '';
                document.getElementById('buttonRows').innerHTML = '';
                document.getElementById('templatePreview').style.display = 'none';
                buttonRowCount = 0;
                
                await loadTemplates();
                updateSelects();
            } catch (error) {
                showAlert('åˆ›å»ºå¤±è´¥: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // åˆ›å»ºè§¦å‘è¯
        async function createTrigger(event) {
            event.preventDefault();
            showLoading();
            
            try {
                const word = document.getElementById('triggerWord').value;
                const templateId = document.getElementById('triggerTemplate').value;
                const matchType = document.getElementById('triggerMatchType').value;
                const chatId = document.getElementById('triggerChatId').value;
                
                await apiRequest('/api/triggers', 'POST', {
                    word, templateId, matchType, chatId
                });
                
                showAlert('è§¦å‘è¯åˆ›å»ºæˆåŠŸï¼');
                document.getElementById('triggerWord').value = '';
                document.getElementById('triggerTemplate').value = '';
                document.getElementById('triggerChatId').value = '';
                
                await loadTriggers();
            } catch (error) {
                showAlert('åˆ›å»ºå¤±è´¥: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // åˆ›å»ºå®šæ—¶ä»»åŠ¡
        async function createTask(event) {
            event.preventDefault();
            showLoading();
            
            try {
                const name = document.getElementById('taskName').value;
                const templateId = document.getElementById('taskTemplate').value;
                const chatId = document.getElementById('taskChatId').value;
                const scheduleType = document.getElementById('taskScheduleType').value;
                const scheduleTime = document.getElementById('taskScheduleTime').value;
                
                await apiRequest('/api/tasks', 'POST', {
                    name, templateId, chatId, scheduleType, scheduleTime
                });
                
                showAlert('å®šæ—¶ä»»åŠ¡åˆ›å»ºæˆåŠŸï¼');
                document.getElementById('taskName').value = '';
                document.getElementById('taskTemplate').value = '';
                document.getElementById('taskChatId').value = '';
                document.getElementById('taskScheduleTime').value = '';
                
                await loadTasks();
            } catch (error) {
                showAlert('åˆ›å»ºå¤±è´¥: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // å¤„ç†æ¨¡å—ç±»å‹å˜åŒ–
        function handleModuleTypeChange() {
            const moduleType = document.getElementById('testModuleType').value;
            
            // éšè—æ‰€æœ‰æ¨¡å—
            document.getElementById('merchantModule').style.display = 'none';
            document.getElementById('templateModule').style.display = 'none';
            document.getElementById('customModule').style.display = 'none';
            
            // æ˜¾ç¤ºé€‰ä¸­çš„æ¨¡å—
            if (moduleType === 'merchant') {
                document.getElementById('merchantModule').style.display = 'block';
                updateMerchantSelect();
            } else if (moduleType === 'template') {
                document.getElementById('templateModule').style.display = 'block';
            } else if (moduleType === 'custom') {
                document.getElementById('customModule').style.display = 'block';
            }
        }

        // æ›´æ–°å•†å®¶é€‰æ‹©å™¨
        function updateMerchantSelect() {
            const select = document.getElementById('testMerchant');
            const currentValue = select.value; // ä¿å­˜å½“å‰é€‰ä¸­çš„å€¼
            select.innerHTML = '<option value="">è¯·é€‰æ‹©å•†å®¶</option>';
            
            console.log('ğŸ” å½“å‰å•†å®¶æ•°æ®:', merchants);
            
            merchants.forEach(merchant => {
                // æ”¾å®½ç­›é€‰æ¡ä»¶ï¼šåªè¦æœ‰å•†å®¶åç§°å°±å¯ä»¥é€‰æ‹©
                if (merchant.teacher_name) {
                    const option = document.createElement('option');
                    option.value = merchant.id;
                    option.textContent = `${merchant.teacher_name} - ${merchant.region_name || 'æœªçŸ¥åœ°åŒº'}`;
                    select.appendChild(option);
                    console.log(`âœ… æ·»åŠ å•†å®¶é€‰é¡¹: ${merchant.teacher_name} (ID: ${merchant.id})`);
                }
            });
            
            // å¦‚æœæ²¡æœ‰å¯é€‰å•†å®¶ï¼Œæ˜¾ç¤ºæç¤º
            if (select.children.length === 1) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'æš‚æ— å•†å®¶æ•°æ®ï¼Œè¯·æ£€æŸ¥å•†å®¶ç®¡ç†é¡µé¢';
                option.disabled = true;
                select.appendChild(option);
                console.log('âš ï¸ æ²¡æœ‰æ‰¾åˆ°å¯ç”¨å•†å®¶');
            } else {
                console.log(`âœ… å…±æ·»åŠ äº† ${select.children.length - 1} ä¸ªå•†å®¶é€‰é¡¹`);
            }
            
            // æ¢å¤ä¹‹å‰é€‰ä¸­çš„å€¼
            if (currentValue) {
                select.value = currentValue;
                // å¦‚æœæ¢å¤äº†é€‰ä¸­å€¼ï¼Œè§¦å‘é¢„è§ˆæ›´æ–°
                handleMerchantChange();
            }
            
            select.onchange = handleMerchantChange;
        }

        // å¤„ç†å•†å®¶é€‰æ‹©å˜åŒ–
        function handleMerchantChange() {
            const merchantId = document.getElementById('testMerchant').value;
            const preview = document.getElementById('merchantPreview');
            const content = document.getElementById('merchantPreviewContent');
            
            if (!merchantId) {
                preview.style.display = 'none';
                return;
            }
            
            const merchant = merchants.find(m => m.id == merchantId); // å·²ç»ä½¿ç”¨æ¾æ•£æ¯”è¾ƒ
            if (merchant) {
                // ä½¿ç”¨ä¸å•†å®¶ç®¡ç†é¡µé¢ç›¸åŒçš„æ ¼å¼
                const previewText = `åœ°åŒºï¼š#${merchant.region_name || 'xx'}              è‰ºåï¼š${merchant.teacher_name || 'æœªå¡«å†™'}
ä¼˜ç‚¹ï¼š${merchant.advantages || 'æœªå¡«å†™'}
ç¼ºç‚¹ï¼š${merchant.disadvantages || 'æœªå¡«å†™'}
ä»·æ ¼ï¼š${merchant.price1 || 'æœªå¡«å†™'}p              ${merchant.price2 || 'æœªå¡«å†™'}pp
è”ç³»ï¼š${merchant.contact || 'æœªå¡«å†™'}

è€å¸ˆğŸ’ƒè‡ªå¡«åŸºæœ¬åŠŸï¼š
ğŸ’¦æ´—:${merchant.skill_wash || 'æœªå¡«å†™'}
ğŸ‘„å¹:${merchant.skill_blow || 'æœªå¡«å†™'}
â¤ï¸åš:${merchant.skill_do || 'æœªå¡«å†™'}
ğŸå»:${merchant.skill_kiss || 'æœªå¡«å†™'}`;
                
                content.innerHTML = `<pre style="white-space: pre-wrap; font-family: inherit; margin: 0;">${previewText}</pre>`;
                preview.style.display = 'block';
            }
        }

        // å¤„ç†æ¨¡æ¿é€‰æ‹©å˜åŒ–
        function handleTemplateChange() {
            const templateId = document.getElementById('testTemplate').value;
            const preview = document.getElementById('templatePreviewTest');
            const content = document.getElementById('templatePreviewTestContent');
            
            if (!templateId) {
                preview.style.display = 'none';
                return;
            }
            
            const template = templates.find(t => t.id == templateId);
            if (template) {
                let previewHtml = `<p><strong>ğŸ“ å†…å®¹ï¼š</strong>${template.content}</p>`;
                
                if (template.image_url) {
                    previewHtml += `<p><strong>ğŸ–¼ï¸ å›¾ç‰‡ï¼š</strong><img src="${template.image_url}" style="max-width: 200px; max-height: 100px;" /></p>`;
                }
                
                if (template.buttons_config) {
                    try {
                        const buttons = JSON.parse(template.buttons_config);
                        if (buttons.length > 0) {
                            previewHtml += '<p><strong>ğŸ”˜ æŒ‰é’®ï¼š</strong></p>';
                            buttons.forEach(row => {
                                row.forEach(btn => {
                                    previewHtml += `<button style="margin: 2px; padding: 5px 10px; background: #007bff; color: white; border: none; border-radius: 3px;">${btn.text}</button>`;
                                });
                            });
                        }
                    } catch (e) {
                        console.error('è§£ææŒ‰é’®é…ç½®å¤±è´¥:', e);
                    }
                }
                
                content.innerHTML = previewHtml;
                preview.style.display = 'block';
            }
        }

        // æ·»åŠ æµ‹è¯•æŒ‰é’®è¡Œ
        let testButtonRowCount = 0;
        function addTestButtonRow() {
            testButtonRowCount++;
            const container = document.getElementById('testButtonRows');
            const row = document.createElement('div');
            row.className = 'button-row';
            row.style.cssText = 'display: flex; gap: 10px; margin-bottom: 10px; align-items: center;';
            row.innerHTML = `
                <input type="text" class="button-text" placeholder="æŒ‰é’®æ–‡å­—" style="flex: 1;">
                <input type="text" class="button-callback" placeholder="å›è°ƒæ•°æ®ï¼ˆå¯é€‰ï¼‰" style="flex: 1;">
                <button type="button" onclick="removeTestButtonRow(this)" class="btn btn-danger" style="padding: 5px 10px;">åˆ é™¤</button>
            `;
            container.appendChild(row);
        }

        // åˆ é™¤æµ‹è¯•æŒ‰é’®è¡Œ
        function removeTestButtonRow(button) {
            button.parentElement.remove();
        }

        // ä¿å­˜ç¾¤ç»„IDåˆ°æœ¬åœ°å­˜å‚¨
        function saveChatId(chatId) {
            if (chatId) {
                localStorage.setItem('lastChatId', chatId);
            }
        }

        // ä»æœ¬åœ°å­˜å‚¨åŠ è½½ç¾¤ç»„ID
        function loadChatId() {
            const lastChatId = localStorage.getItem('lastChatId');
            if (lastChatId) {
                document.getElementById('testChatId').value = lastChatId;
            }
        }

        // å‘é€æµ‹è¯•æ¶ˆæ¯
        async function sendTestMessage(event) {
            event.preventDefault();
            showLoading();
            
            try {
                const chatId = document.getElementById('testChatId').value;
                const moduleType = document.getElementById('testModuleType').value;
                
                // ä¿å­˜ç¾¤ç»„ID
                saveChatId(chatId);
                
                let sendData = { chatId };
                
                if (moduleType === 'merchant') {
                    // å•†å®¶ä¿¡æ¯æ¨¡å¼
                    const merchantId = document.getElementById('testMerchant').value;
                    if (!merchantId) {
                        showAlert('è¯·é€‰æ‹©å•†å®¶', 'error');
                        return;
                    }
                    sendData.type = 'merchant';
                    sendData.merchantId = merchantId;
                    
                } else if (moduleType === 'template') {
                    // æ¶ˆæ¯æ¨¡æ¿æ¨¡å¼
                    const templateId = document.getElementById('testTemplate').value;
                    if (!templateId) {
                        showAlert('è¯·é€‰æ‹©æ¶ˆæ¯æ¨¡æ¿', 'error');
                        return;
                    }
                    sendData.type = 'template';
                    sendData.templateId = templateId;
                    
                } else if (moduleType === 'custom') {
                    // è‡ªå®šä¹‰æ¶ˆæ¯æ¨¡å¼
                const message = document.getElementById('testMessage').value;
                    if (!message.trim()) {
                        showAlert('è¯·è¾“å…¥æ¶ˆæ¯å†…å®¹', 'error');
                        return;
                    }
                    
                    sendData.type = 'custom';
                    sendData.message = message;
                    sendData.imageUrl = document.getElementById('testImageUrl').value;
                    
                    // æ”¶é›†æŒ‰é’®é…ç½®
                    const buttonRows = document.querySelectorAll('#testButtonRows .button-row');
                    const buttonsConfig = [];
                    
                    if (buttonRows.length > 0) {
                        const currentRow = [];
                        buttonRows.forEach(row => {
                            const text = row.querySelector('.button-text').value;
                            const callback = row.querySelector('.button-callback').value;
                            if (text.trim()) {
                                currentRow.push({
                                    text: text.trim(),
                                    callback_data: callback.trim() || `test_btn_${text.trim()}`
                                });
                            }
                        });
                        if (currentRow.length > 0) {
                            buttonsConfig.push(currentRow);
                        }
                    }
                    
                    if (buttonsConfig.length > 0) {
                        sendData.buttonsConfig = buttonsConfig;
                    }
                    
                } else {
                    showAlert('è¯·é€‰æ‹©å‘é€æ¨¡å—', 'error');
                    return;
                }
                
                await apiRequest('/api/test-send', 'POST', sendData);
                
                showAlert('æµ‹è¯•æ¶ˆæ¯å‘é€æˆåŠŸï¼');
            } catch (error) {
                showAlert('å‘é€å¤±è´¥: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // åˆ é™¤æ“ä½œ
        async function deleteButton(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæŒ‰é’®å—ï¼Ÿ')) return;
            
            try {
                await apiRequest('/api/buttons', 'DELETE', { id });
                showAlert('æŒ‰é’®åˆ é™¤æˆåŠŸï¼');
                await loadButtons();
            } catch (error) {
                showAlert('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
            }
        }

        async function deleteTemplate(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ¨¡æ¿å—ï¼Ÿ')) return;
            
            try {
                await apiRequest('/api/templates', 'DELETE', { id });
                showAlert('æ¨¡æ¿åˆ é™¤æˆåŠŸï¼');
                await loadTemplates();
                updateSelects();
            } catch (error) {
                showAlert('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
            }
        }

        async function deleteTrigger(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè§¦å‘è¯å—ï¼Ÿ')) return;
            
            try {
                await apiRequest('/api/triggers', 'DELETE', { id });
                showAlert('è§¦å‘è¯åˆ é™¤æˆåŠŸï¼');
                await loadTriggers();
            } catch (error) {
                showAlert('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
            }
        }

        async function deleteTask(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå®šæ—¶ä»»åŠ¡å—ï¼Ÿ')) return;
            
            try {
                await apiRequest('/api/tasks', 'DELETE', { id });
                showAlert('å®šæ—¶ä»»åŠ¡åˆ é™¤æˆåŠŸï¼');
                await loadTasks();
            } catch (error) {
                showAlert('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
            }
        }

        // å¤åˆ¶å•†å®¶URLé“¾æ¥
        function copyMerchantUrl(url) {
            if (navigator.clipboard && window.isSecureContext) {
                // ç°ä»£æµè§ˆå™¨æ”¯æŒClipboard API
                navigator.clipboard.writeText(url).then(() => {
                    showAlert('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼', 'success');
                }).catch(err => {
                    console.error('å¤åˆ¶å¤±è´¥:', err);
                    fallbackCopyTextToClipboard(url);
                });
            } else {
                // æ—§æµè§ˆå™¨çš„å›é€€æ–¹æ¡ˆ
                fallbackCopyTextToClipboard(url);
            }
        }

        // å›é€€çš„å¤åˆ¶æ–¹æ³•
        function fallbackCopyTextToClipboard(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            
            // é¿å…åœ¨å±å¹•ä¸Šæ˜¾ç¤º
            textArea.style.position = "fixed";
            textArea.style.top = "0";
            textArea.style.left = "0";
            textArea.style.width = "2em";
            textArea.style.height = "2em";
            textArea.style.padding = "0";
            textArea.style.border = "none";
            textArea.style.outline = "none";
            textArea.style.boxShadow = "none";
            textArea.style.background = "transparent";
            
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showAlert('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼', 'success');
                } else {
                    showAlert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶é“¾æ¥', 'error');
                }
            } catch (err) {
                console.error('Fallback: å¤åˆ¶å¤±è´¥', err);
                showAlert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶é“¾æ¥', 'error');
            }
            
            document.body.removeChild(textArea);
        }

        // æµ‹è¯•å•†å®¶URLé“¾æ¥
        function openMerchantUrl(url) {
            window.open(url, '_blank');
            showAlert('å·²åœ¨æ–°çª—å£æ‰“å¼€æµ‹è¯•é“¾æ¥', 'info');
        }

        // åˆå§‹åŒ–æŒ‰é’®æ„å»ºå™¨
        addButtonRow();

        // æ–°å¢å•†å®¶æ¨¡æ€æ¡†
        function openNewMerchantModal() {
            document.getElementById('newMerchantModal').style.display = 'block';
        }

        // å…³é—­æ–°å¢å•†å®¶æ¨¡æ€æ¡†
        function closeNewMerchantModal() {
            document.getElementById('newMerchantModal').style.display = 'none';
        }

        // åˆ›å»ºæ–°å•†å®¶ - å¼ºåˆ¶è¦æ±‚å•†å®¶åç§°å’Œç”¨æˆ·å
        async function createNewMerchant(event) {
            event.preventDefault();
            showLoading();
            
            try {
                const name = document.getElementById('newMerchantName').value.trim();
                const username = document.getElementById('newMerchantUsername').value.trim();
                const bindCode = document.getElementById('newMerchantBindCode').value.trim();
                
                // å¼ºåˆ¶éªŒè¯å¿…å¡«å­—æ®µ
                if (!name) {
                    throw new Error('å•†å®¶åç§°ä¸èƒ½ä¸ºç©ºï¼');
                }
                if (!username) {
                    throw new Error('ç”¨æˆ·åä¸èƒ½ä¸ºç©ºï¼');
                }
                
                // éªŒè¯ç”¨æˆ·åæ ¼å¼
                if (username.includes('@')) {
                    throw new Error('ç”¨æˆ·åä¸éœ€è¦åŒ…å«@ç¬¦å·ï¼Œè¯·ç›´æ¥è¾“å…¥ç”¨æˆ·å');
                }
                if (username.length < 3) {
                    throw new Error('ç”¨æˆ·åé•¿åº¦ä¸èƒ½å°‘äº3ä¸ªå­—ç¬¦');
                }
                
                const requestData = {
                    teacher_name: name,
                    username: username
                };
                
                // å¦‚æœæœ‰ç»‘å®šç ï¼ŒåŒ…å«åœ¨è¯·æ±‚ä¸­
                if (bindCode) {
                    requestData.bind_code = bindCode;
                }
                
                const response = await apiRequest('/api/merchants', 'POST', requestData);
                
                let message = 'æ–°å•†å®¶åˆ›å»ºæˆåŠŸï¼';
                if (response.bindCode) {
                    message += `\nç»‘å®šç ï¼š${response.bindCode}`;
                }
                
                // æ˜¾ç¤ºè‡ªåŠ¨æ£€æµ‹ç»“æœ
                if (response.detectedUserId) {
                    message += `\nâœ… å·²è‡ªåŠ¨æ£€æµ‹åˆ°Telegram ID: ${response.detectedUserId}`;
                    message += '\nå•†å®¶ç°åœ¨å¯ä»¥ç›´æ¥æ”¶åˆ°é¢„çº¦é€šçŸ¥ï¼';
                } else {
                    message += '\nâš ï¸ æœªèƒ½è‡ªåŠ¨æ£€æµ‹åˆ°Telegram ID';
                    message += '\nå•†å®¶éœ€è¦ä½¿ç”¨ç»‘å®šç ä¸»åŠ¨ç»‘å®šæ‰ä¼šæ”¶åˆ°é€šçŸ¥ã€‚';
                }
                
                showAlert(message, response.detectedUserId ? 'success' : 'warning');
                closeNewMerchantModal();
                
                // æ¸…ç©ºè¡¨å•
                document.getElementById('newMerchantName').value = '';
                document.getElementById('newMerchantUsername').value = '';
                document.getElementById('newMerchantBindCode').value = '';
                
                await loadMerchants();
                await loadBindCodes(); // åˆ·æ–°ç»‘å®šç åˆ—è¡¨
            } catch (error) {
                showAlert('åˆ›å»ºæ–°å•†å®¶å¤±è´¥: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // ç”Ÿæˆç»‘å®šç 
        async function generateBindCodeForNewMerchant() {
            try {
                showLoading();
                const name = document.getElementById('newMerchantName').value;
                const username = document.getElementById('newMerchantUsername').value;
                
                if (!name || !username) {
                    showAlert('è¯·å…ˆå¡«å†™å•†å®¶åç§°å’Œç”¨æˆ·å', 'error');
                    return;
                }
                
                console.log('æ­£åœ¨ç”Ÿæˆç»‘å®šç ...');
                const response = await apiRequest('/api/bind-codes', 'POST', {
                    description: `ç®¡ç†å‘˜åˆ›å»º: ${name} (@${username})`
                });
                
                console.log('APIå“åº”:', response);
                
                // å…¼å®¹ä¸åŒçš„å“åº”æ ¼å¼
                let bindCode = null;
                if (response && response.success && response.data && response.data.code) {
                    bindCode = response.data.code;
                } else if (response && response.code) {
                    bindCode = response.code;
                } else {
                    console.error('å“åº”æ ¼å¼é”™è¯¯:', response);
                    throw new Error('ç”Ÿæˆç»‘å®šç å¤±è´¥ï¼šæœåŠ¡å™¨å“åº”æ ¼å¼é”™è¯¯');
                }
                
                document.getElementById('newMerchantBindCode').value = bindCode;
                showAlert('ç»‘å®šç ç”ŸæˆæˆåŠŸï¼');
                
            } catch (error) {
                console.error('ç”Ÿæˆç»‘å®šç å¤±è´¥:', error);
                showAlert('ç”Ÿæˆç»‘å®šç å¤±è´¥: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // åˆ·æ–°æ‰€æœ‰å•†å®¶å…³æ³¨çŠ¶æ€
        async function refreshFollowStatus() {
            try {
                showLoading();
                
                if (merchants.length === 0) {
                    showAlert('æ²¡æœ‰å•†å®¶æ•°æ®éœ€è¦æ£€æŸ¥', 'warning');
                    return;
                }
                
                // è·å–æ‰€æœ‰å•†å®¶ID
                const merchantIds = merchants.map(m => m.id);
                
                // è°ƒç”¨APIæ£€æŸ¥å…³æ³¨çŠ¶æ€
                const response = await apiRequest('/api/merchants/check-follow-status', 'POST', {
                    merchantIds: merchantIds
                });
                
                if (response.success) {
                    // æ›´æ–°å•†å®¶æ•°æ®ä¸­çš„å…³æ³¨çŠ¶æ€
                    merchants.forEach(merchant => {
                        if (response.result[merchant.id]) {
                            merchant.followStatus = response.result[merchant.id];
                        }
                    });
                    
                    // é‡æ–°æ¸²æŸ“å•†å®¶åˆ—è¡¨
                    renderMerchants();
                    
                    // ç»Ÿè®¡å…³æ³¨æƒ…å†µ
                    const followedCount = merchants.filter(m => m.followStatus && m.followStatus.followed).length;
                    const totalCount = merchants.length;
                    
                    showAlert(`å…³æ³¨çŠ¶æ€åˆ·æ–°å®Œæˆï¼\nå·²å…³æ³¨: ${followedCount}/${totalCount} ä¸ªå•†å®¶`);
                } else {
                    throw new Error(response.message || 'æ£€æŸ¥å…³æ³¨çŠ¶æ€å¤±è´¥');
                }
            } catch (error) {
                showAlert('åˆ·æ–°å…³æ³¨çŠ¶æ€å¤±è´¥: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // åˆ·æ–°å•ä¸ªå•†å®¶å…³æ³¨çŠ¶æ€
        async function refreshSingleMerchantFollowStatus(merchantId) {
            try {
                showLoading();
                
                const merchant = merchants.find(m => m.id == merchantId);
                if (!merchant) {
                    showAlert('å•†å®¶ä¸å­˜åœ¨', 'error');
                    return;
                }
                
                // è°ƒç”¨APIæ£€æŸ¥å•ä¸ªå•†å®¶çš„å…³æ³¨çŠ¶æ€
                const response = await apiRequest('/api/merchants/check-follow-status', 'POST', {
                    merchantIds: [merchantId]
                });
                
                if (response.success && response.result[merchantId]) {
                    // æ›´æ–°è¯¥å•†å®¶çš„å…³æ³¨çŠ¶æ€
                    merchant.followStatus = response.result[merchantId];
                    
                    // é‡æ–°æ¸²æŸ“å•†å®¶åˆ—è¡¨
                    renderMerchants();
                    
                    // æ˜¾ç¤ºæ£€æµ‹ç»“æœ
                    const status = merchant.followStatus.followed ? 'å·²å…³æ³¨æœºå™¨äºº' : 'æœªå…³æ³¨æœºå™¨äºº';
                    const reason = merchant.followStatus.reason ? ` (${merchant.followStatus.reason})` : '';
                    showAlert(`å•†å®¶ ${merchant.teacher_name} çš„å…³æ³¨çŠ¶æ€ï¼š${status}${reason}`, 
                             merchant.followStatus.followed ? 'success' : 'warning');
                } else {
                    throw new Error(response.message || 'æ£€æŸ¥å…³æ³¨çŠ¶æ€å¤±è´¥');
                }
            } catch (error) {
                showAlert(`æ£€æµ‹å•†å®¶å…³æ³¨çŠ¶æ€å¤±è´¥: ${error.message}`, 'error');
            } finally {
                hideLoading();
            }
        }

        // æµ‹è¯•å•ä¸ªå•†å®¶è¯¦ç»†å…³æ³¨çŠ¶æ€ï¼ˆè°ƒè¯•ç”¨ï¼‰
        async function testSingleMerchantFollowStatus(merchantId) {
            try {
                showLoading();
                
                const merchant = merchants.find(m => m.id == merchantId);
                if (!merchant) {
                    showAlert('å•†å®¶ä¸å­˜åœ¨', 'error');
                    return;
                }
                
                console.log(`ğŸ” å¼€å§‹æµ‹è¯•å•†å®¶ ${merchant.teacher_name} (${merchant.username}) çš„è¯¦ç»†å…³æ³¨çŠ¶æ€...`);
                
                // è°ƒç”¨è¯¦ç»†æµ‹è¯•API
                const response = await apiRequest('/api/merchants/test-follow-status', 'POST', {
                    merchantId: merchantId
                });
                
                if (response.success) {
                    const data = response.result;
                    
                    console.log('ğŸ“Š è¯¦ç»†æµ‹è¯•ç»“æœ:', data);
                    
                    // æ„å»ºè¯¦ç»†ä¿¡æ¯æ˜¾ç¤º
                    let message = `å•†å®¶è¯¦ç»†å…³æ³¨çŠ¶æ€æµ‹è¯•ç»“æœï¼š\n\n`;
                    message += `å•†å®¶ä¿¡æ¯ï¼š\n`;
                    message += `- ID: ${data.merchant_info.id}\n`;
                    message += `- è‰ºå: ${data.merchant_info.teacher_name}\n`;
                    message += `- ç”¨æˆ·å: ${data.merchant_info.username}\n`;
                    message += `- ç»‘å®šçš„Telegram ID: ${data.merchant_info.user_id || 'æœªç»‘å®š'}\n\n`;
                    
                    message += `å…³æ³¨çŠ¶æ€ï¼š\n`;
                    message += `- çŠ¶æ€: ${data.follow_status.followed ? 'âœ… å·²å…³æ³¨' : 'âŒ æœªå…³æ³¨'}\n`;
                    if (data.follow_status.reason) {
                        message += `- åŸå› : ${data.follow_status.reason}\n`;
                    }
                    if (data.follow_status.last_status) {
                        message += `- æœ€è¿‘çŠ¶æ€: ${data.follow_status.last_status}\n`;
                    }
                    
                    if (data.user_record) {
                        message += `\nç”¨æˆ·è®°å½•ï¼š\n`;
                        message += `- Telegram ID: ${data.user_record.user_id}\n`;
                        message += `- çœŸå®ç”¨æˆ·å: ${data.user_record.username}\n`;
                        message += `- å§“å: ${data.user_record.first_name || ''} ${data.user_record.last_name || ''}\n`;
                        message += `- äº¤äº’æ¬¡æ•°: ${data.interaction_count}\n`;
                        
                        if (data.recent_status_updates && data.recent_status_updates.length > 0) {
                            message += `\næœ€è¿‘çŠ¶æ€æ›´æ–°ï¼š\n`;
                            data.recent_status_updates.forEach((update, index) => {
                                const date = new Date(update.timestamp * 1000).toLocaleString();
                                message += `${index + 1}. ${update.action_type} - ${date}\n`;
                            });
                        }
                    } else {
                        message += `\nâŒ æœªæ‰¾åˆ°ç”¨æˆ·äº¤äº’è®°å½•\n`;
                        message += `è¿™æ„å‘³ç€ç”¨æˆ·å @${data.merchant_info.username} ä»æœªä¸æœºå™¨äººäº¤äº’è¿‡ã€‚\n`;
                    }
                    
                    // æ·»åŠ å»ºè®®
                    message += `\nğŸ’¡ å»ºè®®ï¼š\n`;
                    if (!data.user_record) {
                        message += `1. è¯·ç¡®è®¤ç”¨æˆ·å @${data.merchant_info.username} æ˜¯å¦æ­£ç¡®\n`;
                        message += `2. è®©å•†å®¶ä¸»åŠ¨å‘é€ /start å‘½ä»¤ç»™æœºå™¨äºº\n`;
                        message += `3. å•†å®¶éœ€è¦å…ˆå…³æ³¨æœºå™¨äººæ‰èƒ½æ”¶åˆ°é€šçŸ¥\n`;
                    } else if (!data.follow_status.followed) {
                        if (data.follow_status.reason === 'ç”¨æˆ·å·²å±è”½æœºå™¨äºº') {
                            message += `1. å•†å®¶å·²å±è”½æœºå™¨äººï¼Œéœ€è¦é‡æ–°å¯åŠ¨æœºå™¨äºº\n`;
                            message += `2. è®©å•†å®¶åœ¨Telegramä¸­æœç´¢æœºå™¨äººå¹¶ç‚¹å‡»"å¼€å§‹"æŒ‰é’®\n`;
                        } else {
                            message += `1. è®©å•†å®¶å‘é€ /start å‘½ä»¤ç»™æœºå™¨äºº\n`;
                            message += `2. ç¡®ä¿å•†å®¶ä¸æœºå™¨äººæœ‰è¿‡æœ‰æ•ˆäº¤äº’\n`;
                        }
                    } else {
                        message += `âœ… å•†å®¶çŠ¶æ€æ­£å¸¸ï¼Œå¯ä»¥æ­£å¸¸æ¥æ”¶é¢„çº¦é€šçŸ¥ï¼\n`;
                    }
                    
                    // æ ¹æ®çŠ¶æ€é€‰æ‹©alertç±»å‹
                    const alertType = data.follow_status.followed ? 'success' : 'warning';
                    showAlert(message, alertType);
                    
                } else {
                    throw new Error(response.message || 'æµ‹è¯•å¤±è´¥');
                }
            } catch (error) {
                console.error('æµ‹è¯•å•†å®¶è¯¦ç»†çŠ¶æ€å¤±è´¥:', error);
                showAlert(`æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            } finally {
                hideLoading();
            }
        }

        // è®¾ç½®æ‹–æ‹½ä¸Šä¼ åŠŸèƒ½
        function setupImageDragDrop() {
            const dropZone = document.getElementById('imageDropZone');
            if (!dropZone) return;
            
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.style.borderColor = '#007bff';
                dropZone.style.backgroundColor = '#f8f9fa';
            });
            
            dropZone.addEventListener('dragleave', (e) => {
                e.preventDefault();
                dropZone.style.borderColor = '#ccc';
                dropZone.style.backgroundColor = 'transparent';
            });
            
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.style.borderColor = '#ccc';
                dropZone.style.backgroundColor = 'transparent';
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    const fileInput = document.getElementById('editImageFile');
                    fileInput.files = files;
                    handleImageFileUpload({ target: { files: files } });
                }
            });
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–æ•°æ®
        document.addEventListener('DOMContentLoaded', function() {
            loadAllData();
            setupImageDragDrop();
        });
    </script>
</body>
</html> 