# æ•°æ®åº“ç‰ˆæœ¬ç®¡ç†å’Œè¿ç§»æŒ‡å—

## æ¦‚è¿°

ä½ çš„ç³»ç»Ÿå·²ç»å†…ç½®äº†å®Œå–„çš„æ•°æ®åº“ç‰ˆæœ¬ç®¡ç†æœºåˆ¶ï¼Œ**ä¸éœ€è¦é‡ç½®æ•°æ®åº“**å°±èƒ½è¿›è¡ŒåŠŸèƒ½å‡çº§ã€‚ç³»ç»Ÿé€šè¿‡ä»¥ä¸‹æ–¹å¼ç¡®ä¿æ•°æ®å…¼å®¹æ€§ï¼š

## æ ¸å¿ƒæœºåˆ¶

### 1. å¤šæ•°æ®åº“æ¶æ„
- **æ ¸å¿ƒæ•°æ®åº“** (`core.db`): å­˜å‚¨å•†å®¶ã€åœ°åŒºã€è®¢å•ç­‰æ°¸ä¹…æ•°æ®
- **æ¨¡æ¿æ•°æ®åº“** (`templates.db`): å­˜å‚¨æ¶ˆæ¯æ¨¡æ¿å’Œé…ç½®
- **æœˆåº¦ç”¨æˆ·æ•°æ®åº“** (`users_YYYY_MM.db`): æŒ‰æœˆåˆ†ç¦»ç”¨æˆ·äº¤äº’æ•°æ®

### 2. æ•°æ®åº“ç‰ˆæœ¬æ§åˆ¶
```sql
-- ç³»ç»Ÿè‡ªåŠ¨ç»´æŠ¤ç‰ˆæœ¬ä¿¡æ¯
CREATE TABLE db_meta (
    key TEXT PRIMARY KEY,
    value TEXT
);
```

### 3. è‡ªåŠ¨è¿ç§»æœºåˆ¶
ç³»ç»Ÿåœ¨å¯åŠ¨æ—¶ä¼šï¼š
- æ£€æŸ¥å½“å‰æ•°æ®åº“ç‰ˆæœ¬
- è‡ªåŠ¨æ·»åŠ ç¼ºå¤±çš„åˆ—
- è¿ç§»æ—§æ ¼å¼æ•°æ®
- ä¿æŒå‘ä¸‹å…¼å®¹

## å®é™…ä½¿ç”¨åœºæ™¯

### åœºæ™¯1ï¼šå¢åŠ æ–°åŠŸèƒ½å­—æ®µ
**éœ€æ±‚**ï¼šä¸ºå•†å®¶è¡¨æ·»åŠ "è¥ä¸šæ—¶é—´"å­—æ®µ

```javascript
// åœ¨database.jsä¸­æ·»åŠ ï¼š
try {
    db.exec(`ALTER TABLE merchants ADD COLUMN working_hours TEXT`);
} catch (e) { /* åˆ—å·²å­˜åœ¨ï¼Œå¿½ç•¥é”™è¯¯ */ }
```

**ç»“æœ**ï¼š
- âœ… ç°æœ‰56ä¸ªè€å¸ˆæ•°æ®å®Œå…¨ä¿ç•™
- âœ… 400å¤šä¸ªè®¢å•æ•°æ®å®Œå…¨ä¿ç•™
- âœ… æ–°å­—æ®µè‡ªåŠ¨æ·»åŠ ï¼Œé»˜è®¤å€¼ä¸ºNULL
- âœ… ç³»ç»Ÿæ­£å¸¸è¿è¡Œ

### åœºæ™¯2ï¼šä¿®æ”¹æ•°æ®ç»“æ„
**éœ€æ±‚**ï¼šå°†ä»·æ ¼å­—æ®µä»å•ä¸€æ”¹ä¸ºåŒºé—´

```javascript
// æ—§å­—æ®µä¿ç•™ï¼Œæ–°å¢å­—æ®µ
try {
    db.exec(`ALTER TABLE merchants ADD COLUMN price_range_min INTEGER`);
    db.exec(`ALTER TABLE merchants ADD COLUMN price_range_max INTEGER`);
} catch (e) { /* å·²å­˜åœ¨ */ }

// æ•°æ®è¿ç§»é€»è¾‘
const merchants = db.prepare('SELECT * FROM merchants WHERE price_range_min IS NULL').all();
merchants.forEach(merchant => {
    if (merchant.price1) {
        db.prepare(`UPDATE merchants SET price_range_min = ?, price_range_max = ? WHERE id = ?`)
          .run(merchant.price1, merchant.price2 || merchant.price1, merchant.id);
    }
});
```

### åœºæ™¯3ï¼šæ·»åŠ æ–°åŠŸèƒ½è¡¨
**éœ€æ±‚**ï¼šå¢åŠ "ä¼˜æƒ åˆ¸"åŠŸèƒ½

```javascript
// ç›´æ¥æ·»åŠ æ–°è¡¨ï¼Œä¸å½±å“ç°æœ‰æ•°æ®
db.exec(`
    CREATE TABLE IF NOT EXISTS coupons (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        merchant_id INTEGER,
        code TEXT UNIQUE,
        discount_amount INTEGER,
        valid_until INTEGER,
        FOREIGN KEY (merchant_id) REFERENCES merchants(id)
    )
`);
```

## çº¿ä¸Šå‡çº§æµç¨‹

### 1. å¼€å‘ç¯å¢ƒæµ‹è¯•
```bash
# 1. å¤‡ä»½å½“å‰æ•°æ®
node utils/backupDatabase.js backup ./backup-before-upgrade.json

# 2. éƒ¨ç½²æ–°ä»£ç 
# 3. ç³»ç»Ÿå¯åŠ¨æ—¶è‡ªåŠ¨æ‰§è¡Œè¿ç§»
# 4. éªŒè¯æ•°æ®å®Œæ•´æ€§
```

### 2. ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²
```bash
# Railwayä¼šè‡ªåŠ¨æ‰§è¡Œï¼š
# 1. ä¸‹è½½æ–°ä»£ç 
# 2. å¯åŠ¨åº”ç”¨
# 3. è‡ªåŠ¨æ•°æ®åº“è¿ç§»
# 4. ä¿æŒæœåŠ¡è¿è¡Œ
```

## æ•°æ®å¤‡ä»½å’Œæ¢å¤

### å¤‡ä»½æ•°æ®
```bash
# åˆ›å»ºå®Œæ•´å¤‡ä»½
node utils/backupDatabase.js backup ./backup-$(date +%Y%m%d).json

# å®šæœŸè‡ªåŠ¨å¤‡ä»½
node utils/backupDatabase.js scheduled
```

### æ¢å¤æ•°æ®
```bash
# ä»å¤‡ä»½æ¢å¤
node utils/backupDatabase.js restore ./backup-20241220.json
```

## Railwayäº‘ç«¯æ•°æ®ç®¡ç†

### æ•°æ®è®¿é—®æ–¹å¼
1. **Railway CLI**
```bash
railway login
railway environment
railway run node utils/backupDatabase.js backup ./cloud-backup.json
```

2. **é€šè¿‡APIæ¥å£**
ç³»ç»Ÿæä¾›ç®¡ç†æ¥å£è®¿é—®äº‘ç«¯æ•°æ®

3. **å®šæœŸè‡ªåŠ¨å¤‡ä»½**
å¯é…ç½®å®šæ—¶ä»»åŠ¡å°†æ•°æ®å¤‡ä»½åˆ°äº‘å­˜å‚¨

### æ•°æ®æœ¬åœ°åŒæ­¥
```bash
# ä¸‹è½½äº‘ç«¯æ•°æ®åˆ°æœ¬åœ°
railway run node -e "
const { backupToJSON } = require('./utils/backupDatabase');
backupToJSON('./local-sync.json');
"
```

## æœ€ä½³å®è·µ

### 1. ç‰ˆæœ¬å…¼å®¹æ€§
- âœ… åªæ·»åŠ å­—æ®µï¼Œä¸åˆ é™¤å­—æ®µ
- âœ… ä½¿ç”¨é»˜è®¤å€¼ç¡®ä¿å…¼å®¹æ€§
- âœ… ä¿ç•™æ—§å­—æ®µï¼Œé€æ­¥è¿ç§»
- âŒ ç›´æ¥åˆ é™¤æˆ–é‡å‘½åå­—æ®µ

### 2. æ•°æ®å®‰å…¨
- ğŸ”„ å‡çº§å‰è‡ªåŠ¨å¤‡ä»½
- ğŸ“Š è¿ç§»åæ•°æ®éªŒè¯
- ğŸ”’ å…³é”®æ“ä½œä½¿ç”¨äº‹åŠ¡
- â° å®šæœŸå¤‡ä»½ç­–ç•¥

### 3. é›¶åœæœºå‡çº§
- ğŸš€ Railwayè‡ªåŠ¨éƒ¨ç½²
- ğŸ“ˆ æ¸è¿›å¼åŠŸèƒ½å‘å¸ƒ
- ğŸ” å®æ—¶ç›‘æ§æ•°æ®å®Œæ•´æ€§
- ğŸ›¡ï¸ å¿«é€Ÿå›æ»šæœºåˆ¶

## æ€»ç»“

**ä½ å®Œå…¨ä¸éœ€è¦æ‹…å¿ƒæ•°æ®å…¼å®¹æ€§é—®é¢˜ï¼**

- âœ… ç°æœ‰çš„56ä¸ªè€å¸ˆå’Œ400å¤šä¸ªè®¢å•æ•°æ®ä¼šå®Œå…¨ä¿ç•™
- âœ… å¯ä»¥åœ¨ç°æœ‰æ–‡ä»¶åŸºç¡€ä¸Šç›´æ¥å¼€å‘æ–°åŠŸèƒ½
- âœ… æ•°æ®åº“ä¼šè‡ªåŠ¨å‡çº§ï¼Œæ— éœ€æ‰‹åŠ¨æ“ä½œ
- âœ… Railwayäº‘ç«¯æ•°æ®å¯ä»¥å¤‡ä»½å’ŒåŒæ­¥
- âœ… æ”¯æŒé›¶åœæœºå‡çº§å’Œå¿«é€Ÿå›æ»š

ç³»ç»Ÿè®¾è®¡æ—¶å°±è€ƒè™‘äº†é•¿æœŸæ¼”è¿›ï¼Œä½ å¯ä»¥æ”¾å¿ƒåœ°æŒç»­å¼€å‘å’Œå‡çº§åŠŸèƒ½ï¼ 