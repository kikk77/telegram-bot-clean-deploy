<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegramè¥é”€æœºå™¨äºº - å®Œæ•´ç®¡ç†åå°</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; }
        
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; text-align: center; }
        .header h1 { margin-bottom: 5px; }
        .header p { opacity: 0.9; }
        
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .tab { padding: 10px 20px; background: white; border: none; border-radius: 5px; cursor: pointer; transition: all 0.3s; font-size: 14px; }
        .tab.active { background: #667eea; color: white; }
        .tab:hover { transform: translateY(-2px); }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .card { background: white; border-radius: 10px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .card h3 { margin-bottom: 15px; color: #333; display: flex; align-items: center; gap: 10px; }
        
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; color: #555; }
        .form-group input, .form-group textarea, .form-group select { 
            width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px; 
            font-size: 14px; transition: border-color 0.3s; 
        }
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus { 
            outline: none; border-color: #667eea; 
        }
        .form-group small { color: #666; font-size: 12px; }
        
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .form-row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; }
        
        .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; transition: all 0.3s; }
        .btn-primary { background: #667eea; color: white; }
        .btn-danger { background: #f44336; color: white; }
        .btn-success { background: #4CAF50; color: white; }
        .btn-warning { background: #ff9800; color: white; }
        .btn-small { padding: 5px 10px; font-size: 12px; }
        .btn:hover { transform: translateY(-2px); opacity: 0.9; }
        
        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; 
                     border: 1px solid #eee; border-radius: 5px; margin-bottom: 10px; }
        .list-item:hover { background: #f9f9f9; }
        .list-item-content { flex: 1; }
        .list-item-actions { display: flex; gap: 5px; }
        
        .badge { background: #e0e0e0; color: #666; padding: 2px 8px; border-radius: 12px; font-size: 12px; margin-right: 5px; }
        .badge.success { background: #4CAF50; color: white; }
        .badge.warning { background: #ff9800; color: white; }
        .badge.info { background: #2196F3; color: white; }
        
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px; text-align: center; }
        .stat-number { font-size: 2em; font-weight: bold; margin-bottom: 5px; }
        
        .alert { padding: 15px; border-radius: 5px; margin-bottom: 15px; }
        .alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alert-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .alert-info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        
        .loading { display: none; text-align: center; padding: 20px; }
        .spinner { border: 3px solid #f3f3f3; border-top: 3px solid #667eea; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .button-builder { border: 1px solid #ddd; border-radius: 5px; padding: 15px; margin-bottom: 15px; }
        .button-row { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; }
        .button-preview { background: #f0f0f0; padding: 10px; border-radius: 5px; margin-top: 10px; }
        .preview-button { background: #667eea; color: white; padding: 8px 16px; border-radius: 4px; margin: 2px; display: inline-block; }
        
        .template-preview { background: #f9f9f9; border: 1px solid #ddd; border-radius: 5px; padding: 15px; margin-top: 10px; }
        .template-preview img { max-width: 200px; border-radius: 5px; margin-bottom: 10px; }
        
        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            position: relative;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            position: absolute;
            right: 15px;
            top: 10px;
        }

        .close:hover,
        .close:focus {
            color: #000;
            text-decoration: none;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        @media (max-width: 768px) {
            .form-row, .form-row-3 { grid-template-columns: 1fr; }
            .tabs { justify-content: center; }
            .container { padding: 10px; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ¤– Telegramè¥é”€æœºå™¨äºº - å®Œæ•´ç®¡ç†åå°</h1>
        <p>è§¦å‘è¯ç›‘å¬ | å®šæ—¶å‘é€ | æ¶ˆæ¯æ¨¡æ¿ | æ•°æ®ç»Ÿè®¡</p>
    </div>

    <div class="container">
        <div class="tabs">
            <button class="tab active" onclick="showTab('dashboard')">ğŸ“Š ä»ªè¡¨ç›˜</button>
            <button class="tab" onclick="showTab('bind-codes')">ğŸ”‘ ç»‘å®šç ç®¡ç†</button>
            <button class="tab" onclick="showTab('regions')">ğŸ“ åœ°åŒºç®¡ç†</button>
            <button class="tab" onclick="showTab('merchants')">ğŸ‘¥ å•†å®¶ç®¡ç†</button>
            <button class="tab" onclick="showTab('templates')">ğŸ“ æ¶ˆæ¯æ¨¡æ¿</button>
            <button class="tab" onclick="showTab('triggers')">ğŸ¯ è§¦å‘è¯é…ç½®</button>
            <button class="tab" onclick="showTab('tasks')">â° å®šæ—¶ä»»åŠ¡</button>
            <button class="tab" onclick="showTab('buttons')">ğŸ”˜ æŒ‰é’®ç®¡ç†</button>
            <button class="tab" onclick="showTab('test')">ğŸ§ª æµ‹è¯•å‘é€</button>
            <button class="tab" onclick="window.open('admin/orders.html', '_blank')">ğŸ“ˆ è®¢å•ç»Ÿè®¡</button>
        </div>

        <!-- ä»ªè¡¨ç›˜ -->
        <div id="dashboard" class="tab-content active">
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-number" id="totalOrders">0</div>
                    <div>ğŸ“‹ æ€»è®¢å•</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="bookedOrders">0</div>
                    <div>ğŸ“… å·²é¢„çº¦è®¢å•</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="incompleteOrders">0</div>
                    <div>â³ å¾…å¤„ç†è®¢å•</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="completedOrders">0</div>
                    <div>âœ… å·²å®Œæˆè®¢å•</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="avgPrice">Â¥0</div>
                    <div>ğŸ’° å¹³å‡è®¢å•ä»·æ ¼</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="avgUserRating">-</div>
                    <div>ğŸ‘¤ å¹³å‡ç”¨æˆ·è¯„åˆ†</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="avgMerchantRating">-</div>
                    <div>ğŸ‘©â€ğŸ« å¹³å‡å•†å®¶è¯„åˆ†</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="completionRate">0%</div>
                    <div>ğŸ“Š å®Œæˆç‡</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalMerchants">0</div>
                    <div>ğŸ‘¨â€ğŸ« å•†å®¶æ•°é‡</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalBindCodes">0</div>
                    <div>ğŸ”‘ ç»‘å®šç æ€»æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalRegions">0</div>
                    <div>ğŸ“ åœ°åŒºæ•°é‡</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalTemplates">0</div>
                    <div>ğŸ“ æ¶ˆæ¯æ¨¡æ¿</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalClicks">0</div>
                    <div>ğŸ‘† æ€»ç‚¹å‡»æ•°</div>
                </div>
            </div>
            
            <div class="card">
                <h3>ğŸ“ˆ ç³»ç»ŸçŠ¶æ€</h3>
                <div id="systemStatus">
                    <p>âœ… æœºå™¨äººè¿è¡Œæ­£å¸¸</p>
                    <p>âœ… æ•°æ®åº“è¿æ¥æ­£å¸¸</p>
                    <p>âœ… å®šæ—¶ä»»åŠ¡è°ƒåº¦å™¨è¿è¡Œä¸­</p>
                    <p>âœ… è§¦å‘è¯ç›‘å¬å·²å¯ç”¨</p>
                </div>
            </div>

            <div class="card">
                <h3>ğŸ‘¥ å•†å®¶é¢„çº¦ç»Ÿè®¡</h3>
                <div id="merchantBookingStats">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>åŠ è½½ä¸­...</p>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3>ğŸ“Š æ¶ˆæ¯äº’åŠ¨ç»Ÿè®¡</h3>
                <div id="messageStats">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>åŠ è½½ä¸­...</p>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3>ğŸ•’ æœ€è¿‘é¢„çº¦è®°å½•</h3>
                <div id="recentBookings">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>åŠ è½½ä¸­...</p>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3>ğŸ”˜ æŒ‰é’®ç‚¹å‡»ç»Ÿè®¡</h3>
                <div id="buttonStats">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>åŠ è½½ä¸­...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç»‘å®šç ç®¡ç† -->
        <div id="bind-codes" class="tab-content">
            <div class="card">
                <h3>ğŸ”‘ ç”Ÿæˆæ–°ç»‘å®šç </h3>
                <form onsubmit="createBindCode(event)">
                    <div class="form-group">
                        <label>ç»‘å®šç æè¿°</label>
                        <input type="text" id="bindCodeDescription" required placeholder="ä¾‹å¦‚ï¼šVIPå•†å®¶ä¸“ç”¨ç»‘å®šç ">
                        <small>ç”¨äºæ ‡è¯†ç»‘å®šç çš„ç”¨é€”</small>
                    </div>
                    <button type="submit" class="btn btn-primary">ç”Ÿæˆç»‘å®šç </button>
                </form>
            </div>

            <div class="card">
                <h3>ğŸ“‹ ç»‘å®šç åˆ—è¡¨</h3>
                <div style="margin-bottom: 15px;">
                    <button class="btn btn-danger" onclick="batchDeleteTestBindCodes()">ğŸ—‘ï¸ æ‰¹é‡åˆ é™¤æµ‹è¯•ç»‘å®šç </button>
                    <small style="margin-left: 10px; color: #666;">å°†åˆ é™¤æ‰€æœ‰æè¿°ä¸­åŒ…å«"æµ‹è¯•"çš„ç»‘å®šç ï¼ˆåŒ…æ‹¬å·²ä½¿ç”¨çš„ï¼‰</small>
                </div>
                <div id="bindCodesList"></div>
            </div>
        </div>

        <!-- åœ°åŒºç®¡ç† -->
        <div id="regions" class="tab-content">
            <div class="card">
                <h3>ğŸ“ æ·»åŠ æ–°åœ°åŒº</h3>
                <form onsubmit="createRegion(event)">
                    <div class="form-row">
                        <div class="form-group">
                            <label>åœ°åŒºåç§°</label>
                            <input type="text" id="regionName" required placeholder="ä¾‹å¦‚ï¼šåŒ—äº¬">
                        </div>
                        <div class="form-group">
                            <label>æ’åºé¡ºåº</label>
                            <input type="number" id="regionSortOrder" value="0" min="0" placeholder="æ•°å­—è¶Šå°è¶Šé å‰">
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">æ·»åŠ åœ°åŒº</button>
                </form>
            </div>

            <div class="card">
                <h3>ğŸ—ºï¸ åœ°åŒºåˆ—è¡¨</h3>
                <div id="regionsList"></div>
            </div>
        </div>

        <!-- æ¶ˆæ¯æ¨¡æ¿ç®¡ç† -->
        <div id="templates" class="tab-content">
            <div class="card">
                <h3>â• åˆ›å»ºæ¶ˆæ¯æ¨¡æ¿</h3>
                <form onsubmit="createTemplate(event)">
                    <div class="form-row">
                        <div class="form-group">
                            <label>æ¨¡æ¿åç§°</label>
                            <input type="text" id="templateName" required placeholder="ä¾‹å¦‚ï¼šå®¢æœè”ç³»æ¨¡æ¿">
                        </div>
                        <div class="form-group">
                            <label>å›¾ç‰‡URLï¼ˆå¯é€‰ï¼‰</label>
                            <input type="url" id="templateImage" placeholder="https://example.com/image.jpg">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>æ¶ˆæ¯å†…å®¹</label>
                        <textarea id="templateContent" rows="4" required placeholder="è¾“å…¥æ¶ˆæ¯å†…å®¹ï¼Œæ”¯æŒHTMLæ ¼å¼"></textarea>
                        <small>æ”¯æŒHTMLæ ¼å¼ï¼š&lt;b&gt;ç²—ä½“&lt;/b&gt; &lt;i&gt;æ–œä½“&lt;/i&gt; &lt;code&gt;ä»£ç &lt;/code&gt;</small>
                    </div>
                    
                    <div class="button-builder">
                        <label>æŒ‰é’®é…ç½®</label>
                        <div id="buttonRows"></div>
                        <button type="button" onclick="addButtonRow()" class="btn btn-success btn-small">+ æ·»åŠ æŒ‰é’®è¡Œ</button>
                    </div>
                    
                    <div class="template-preview" id="templatePreview" style="display: none;">
                        <h4>é¢„è§ˆæ•ˆæœï¼š</h4>
                        <div id="previewContent"></div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">åˆ›å»ºæ¨¡æ¿</button>
                    <button type="button" onclick="previewTemplate()" class="btn btn-warning">é¢„è§ˆæ•ˆæœ</button>
                </form>
            </div>

            <div class="card">
                <h3>ğŸ“‹ æ¨¡æ¿åˆ—è¡¨</h3>
                <div id="templatesList"></div>
            </div>
        </div>

        <!-- è§¦å‘è¯é…ç½® -->
        <div id="triggers" class="tab-content">
            <div class="card">
                <h3>ğŸ¯ æ·»åŠ è§¦å‘è¯</h3>
                <form onsubmit="createTrigger(event)">
                    <div class="form-row">
                        <div class="form-group">
                            <label>è§¦å‘è¯</label>
                            <input type="text" id="triggerWord" required placeholder="ä¾‹å¦‚ï¼šè”ç³»å®¢æœ">
                            <small>æ”¯æŒä¸­è‹±æ–‡ï¼Œä¸åŒºåˆ†å¤§å°å†™</small>
                        </div>
                        <div class="form-group">
                            <label>åŒ¹é…æ¨¡å¼</label>
                            <select id="triggerMatchType" required>
                                <option value="exact">ç²¾ç¡®åŒ¹é…</option>
                                <option value="contains">åŒ…å«åŒ¹é…</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>å…³è”æ¨¡æ¿</label>
                            <select id="triggerTemplate" required>
                                <option value="">é€‰æ‹©æ¶ˆæ¯æ¨¡æ¿</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ç¾¤ç»„ID</label>
                            <input type="text" id="triggerChatId" required placeholder="-1001234567890">
                            <small>ç¾¤ç»„IDé€šå¸¸ä¸ºè´Ÿæ•°</small>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">æ·»åŠ è§¦å‘è¯</button>
                </form>
            </div>

            <div class="card">
                <h3>ğŸ“ è§¦å‘è¯åˆ—è¡¨</h3>
                <div id="triggersList"></div>
            </div>
        </div>

        <!-- å®šæ—¶ä»»åŠ¡ -->
        <div id="tasks" class="tab-content">
            <div class="card">
                <h3>â° åˆ›å»ºå®šæ—¶ä»»åŠ¡</h3>
                <form onsubmit="createTask(event)">
                    <div class="form-row">
                        <div class="form-group">
                            <label>ä»»åŠ¡åç§°</label>
                            <input type="text" id="taskName" required placeholder="ä¾‹å¦‚ï¼šæ¯æ—¥è¥é”€æ¨é€">
                        </div>
                        <div class="form-group">
                            <label>å…³è”æ¨¡æ¿</label>
                            <select id="taskTemplate" required>
                                <option value="">é€‰æ‹©æ¶ˆæ¯æ¨¡æ¿</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>ç¾¤ç»„ID</label>
                            <input type="text" id="taskChatId" required placeholder="-1001234567890">
                        </div>
                        <div class="form-group">
                            <label>è°ƒåº¦ç±»å‹</label>
                            <select id="taskScheduleType" required onchange="updateScheduleInput()">
                                <option value="daily">æ¯æ—¥æ‰§è¡Œ</option>
                                <option value="weekly">æ¯å‘¨æ‰§è¡Œ</option>
                                <option value="cron">è‡ªå®šä¹‰Cron</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label id="scheduleLabel">æ‰§è¡Œæ—¶é—´</label>
                        <input type="text" id="taskScheduleTime" required placeholder="09:00">
                        <small id="scheduleHelp">æ ¼å¼ï¼šHH:MMï¼ˆ24å°æ—¶åˆ¶ï¼‰</small>
                    </div>
                    <button type="submit" class="btn btn-primary">åˆ›å»ºä»»åŠ¡</button>
                </form>
            </div>

            <div class="card">
                <h3>ğŸ“… ä»»åŠ¡åˆ—è¡¨</h3>
                <div id="tasksList"></div>
            </div>
        </div>

        <!-- å•†å®¶ç®¡ç† -->
        <div id="merchants" class="tab-content">
            <div class="card">
                <h3>ğŸ“Š ç»‘å®šç»Ÿè®¡</h3>
                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-number" id="totalBindCodes">0</div>
                        <div>æ€»ç»‘å®šç </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="usedBindCodes">0</div>
                        <div>å·²ä½¿ç”¨</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="boundMerchants">0</div>
                        <div>å·²ç»‘å®šå•†å®¶</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="bindingInProgress">0</div>
                        <div>ç»‘å®šä¸­</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3>ğŸ‘¥ å·²ç»‘å®šå•†å®¶åˆ—è¡¨</h3>
                <div id="merchantsList"></div>
            </div>

            <!-- å•†å®¶ç¼–è¾‘æ¨¡æ€æ¡† -->
            <div id="merchantEditModal" class="modal">
                <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
                    <span class="close" onclick="closeMerchantEditModal()">&times;</span>
                    <h3>âœï¸ ç¼–è¾‘å•†å®¶ä¿¡æ¯æ¨¡æ¿</h3>
                    <form onsubmit="updateMerchant(event)">
                        <input type="hidden" id="editMerchantId">
                        
                        <!-- åŸºæœ¬ä¿¡æ¯ -->
                        <div class="card" style="margin-bottom: 20px;">
                            <h4>ğŸ“‹ åŸºæœ¬ä¿¡æ¯</h4>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>åœ°åŒºï¼š#<span id="regionPrefix"></span></label>
                                    <select id="editRegionId" required onchange="updateRegionPrefix()">
                                        <option value="">é€‰æ‹©åœ°åŒº</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>è‰ºåï¼š</label>
                                    <input type="text" id="editTeacherName" required placeholder="è¯·è¾“å…¥è‰ºå">
                                </div>
                            </div>
                        </div>

                        <!-- æè¿°ä¿¡æ¯ -->
                        <div class="card" style="margin-bottom: 20px;">
                            <h4>ğŸ“ æè¿°ä¿¡æ¯</h4>
                            <div class="form-group">
                                <label>ä¼˜ç‚¹ï¼š</label>
                                <textarea id="editAdvantages" rows="3" placeholder="è¯·è¾“å…¥ä¼˜ç‚¹æè¿°ï¼Œæ”¯æŒæ–‡å­—ã€ç©ºæ ¼ã€emoji"></textarea>
                            </div>
                            <div class="form-group">
                                <label>ç¼ºç‚¹ï¼š</label>
                                <textarea id="editDisadvantages" rows="3" placeholder="è¯·è¾“å…¥ç¼ºç‚¹æè¿°ï¼Œæ”¯æŒæ–‡å­—ã€ç©ºæ ¼ã€emoji"></textarea>
                            </div>
                        </div>

                        <!-- ä»·æ ¼ä¿¡æ¯ -->
                        <div class="card" style="margin-bottom: 20px;">
                            <h4>ğŸ’° ä»·æ ¼ä¿¡æ¯</h4>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>ä»·æ ¼1ï¼š</label>
                                    <div style="display: flex; align-items: center;">
                                        <select id="editPrice1" style="flex: 1;">
                                            <option value="">é€‰æ‹©ä»·æ ¼</option>
                                        </select>
                                        <span style="margin-left: 5px; font-weight: bold;">p</span>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>ä»·æ ¼2ï¼š</label>
                                    <div style="display: flex; align-items: center;">
                                        <select id="editPrice2" style="flex: 1;">
                                            <option value="">é€‰æ‹©ä»·æ ¼</option>
                                        </select>
                                        <span style="margin-left: 5px; font-weight: bold;">pp</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- è”ç³»æ–¹å¼ -->
                        <div class="card" style="margin-bottom: 20px;">
                            <h4>ğŸ“ è”ç³»æ–¹å¼</h4>
                            <div class="form-group">
                                <label>è”ç³»ï¼š</label>
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <input type="text" id="editContact" placeholder="@username" style="flex: 1;">
                                    <button type="button" class="btn btn-small" onclick="useBindContact()" style="white-space: nowrap;">ä½¿ç”¨ç»‘å®šè”ç³»æ–¹å¼</button>
                                </div>
                                <small>å¯ä»¥æ‰‹åŠ¨ç¼–è¾‘æˆ–ä½¿ç”¨å•†å®¶ç»‘å®šæ—¶å¡«å†™çš„è”ç³»æ–¹å¼</small>
                            </div>
                        </div>

                        <!-- åŸºæœ¬åŠŸä¿¡æ¯ -->
                        <div class="card" style="margin-bottom: 20px;">
                            <h4>ğŸ’ƒ è€å¸ˆè‡ªå¡«åŸºæœ¬åŠŸ</h4>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>ğŸ’¦æ´—ï¼š</label>
                                    <input type="text" id="editWash" placeholder="è¯·å¡«å†™">
                                </div>
                                <div class="form-group">
                                    <label>ğŸ‘„å¹ï¼š</label>
                                    <input type="text" id="editBlow" placeholder="è¯·å¡«å†™">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>â¤ï¸åšï¼š</label>
                                    <input type="text" id="editDo" placeholder="è¯·å¡«å†™">
                                </div>
                                <div class="form-group">
                                    <label>ğŸå»ï¼š</label>
                                    <input type="text" id="editKiss" placeholder="è¯·å¡«å†™">
                                </div>
                            </div>
                        </div>

                        <!-- é¢„è§ˆåŒºåŸŸ -->
                        <div class="card" style="margin-bottom: 20px;">
                            <h4>ğŸ‘€ ä¿¡æ¯é¢„è§ˆ</h4>
                            <div id="merchantInfoPreview" style="background: #f9f9f9; padding: 15px; border-radius: 5px; white-space: pre-line; font-family: monospace;"></div>
                        </div>

                        <div class="form-actions">
                            <button type="button" onclick="closeMerchantEditModal()" class="btn btn-secondary">å–æ¶ˆ</button>
                            <button type="button" onclick="previewMerchantInfo()" class="btn btn-warning">é¢„è§ˆ</button>
                            <button type="submit" class="btn btn-primary">ä¿å­˜ä¿®æ”¹</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- æŒ‰é’®ç®¡ç† -->
        <div id="buttons" class="tab-content">
            <div class="card">
                <h3>â• åˆ›å»ºæ–°æŒ‰é’®</h3>
                <form onsubmit="createButton(event)">
                    <div class="form-row">
                        <div class="form-group">
                            <label>æŒ‰é’®æ ‡é¢˜</label>
                            <input type="text" id="buttonTitle" required placeholder="ä¾‹å¦‚ï¼šè”ç³»å®¢æœ">
                        </div>
                        <div class="form-group">
                            <label>å…³è”å•†å®¶</label>
                            <select id="buttonMerchant" required>
                                <option value="">é€‰æ‹©å•†å®¶</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>å›å¤æ¶ˆæ¯</label>
                        <textarea id="buttonMessage" rows="3" placeholder="ç”¨æˆ·ç‚¹å‡»æŒ‰é’®åæ”¶åˆ°çš„æ¶ˆæ¯"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">åˆ›å»ºæŒ‰é’®</button>
                </form>
            </div>

            <div class="card">
                <h3>ğŸ”˜ æŒ‰é’®åˆ—è¡¨</h3>
                <div id="buttonsList"></div>
            </div>
        </div>

        <!-- æµ‹è¯•å‘é€ -->
        <div id="test" class="tab-content">
            <div class="card">
                <h3>ğŸ“¤ å‘é€æµ‹è¯•æ¶ˆæ¯</h3>
                <form onsubmit="sendTestMessage(event)">
                    <div class="form-row">
                        <div class="form-group">
                            <label>ç¾¤ç»„ID</label>
                            <input type="text" id="testChatId" required placeholder="ä¾‹å¦‚ï¼š-1001234567890">
                            <small>ç¾¤ç»„IDé€šå¸¸ä¸ºè´Ÿæ•°ï¼Œå¯ä»¥é€šè¿‡æ·»åŠ æœºå™¨äººåˆ°ç¾¤ç»„è·å–</small>
                        </div>
                        <div class="form-group">
                            <label>æ¨¡å—é€‰æ‹©</label>
                            <select id="testModuleType" onchange="handleModuleTypeChange()">
                                <option value="">è¯·é€‰æ‹©å‘é€æ¨¡å—</option>
                                <option value="merchant">å•†å®¶ä¿¡æ¯é€‰æ‹©</option>
                                <option value="template">æ¶ˆæ¯æ¨¡æ¿é€‰æ‹©</option>
                                <option value="custom">è‡ªå®šä¹‰æ¶ˆæ¯å†…å®¹</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- å•†å®¶ä¿¡æ¯é€‰æ‹© -->
                    <div id="merchantModule" class="form-group" style="display: none;">
                        <label>é€‰æ‹©å•†å®¶</label>
                        <select id="testMerchant">
                            <option value="">è¯·é€‰æ‹©å•†å®¶</option>
                        </select>
                        <div id="merchantPreview" style="margin-top: 10px; padding: 10px; background: #f5f5f5; border-radius: 5px; display: none;">
                            <h4>å•†å®¶ä¿¡æ¯é¢„è§ˆï¼š</h4>
                            <div id="merchantPreviewContent"></div>
                        </div>
                    </div>
                    
                    <!-- æ¶ˆæ¯æ¨¡æ¿é€‰æ‹© -->
                    <div id="templateModule" class="form-group" style="display: none;">
                        <label>é€‰æ‹©æ¶ˆæ¯æ¨¡æ¿</label>
                        <select id="testTemplate" onchange="handleTemplateChange()">
                            <option value="">è¯·é€‰æ‹©æ¶ˆæ¯æ¨¡æ¿</option>
                        </select>
                        <div id="templatePreviewTest" style="margin-top: 10px; padding: 10px; background: #f5f5f5; border-radius: 5px; display: none;">
                            <h4>æ¨¡æ¿é¢„è§ˆï¼š</h4>
                            <div id="templatePreviewTestContent"></div>
                        </div>
                    </div>
                    
                    <!-- è‡ªå®šä¹‰æ¶ˆæ¯å†…å®¹ -->
                    <div id="customModule" class="form-group" style="display: none;">
                        <label>æ¶ˆæ¯å†…å®¹</label>
                        <textarea id="testMessage" rows="5" placeholder="è¯·è¾“å…¥è‡ªå®šä¹‰æ¶ˆæ¯å†…å®¹"></textarea>
                        <div class="form-group" style="margin-top: 10px;">
                            <label>å›¾ç‰‡URLï¼ˆå¯é€‰ï¼‰</label>
                            <input type="url" id="testImageUrl" placeholder="https://example.com/image.jpg">
                    </div>
                        <div class="form-group">
                            <label>æŒ‰é’®é…ç½®ï¼ˆå¯é€‰ï¼‰</label>
                            <div id="testButtonRows"></div>
                            <button type="button" onclick="addTestButtonRow()" class="btn btn-secondary" style="margin-top: 5px;">+ æ·»åŠ æŒ‰é’®</button>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-success">å‘é€åˆ°ç¾¤ç»„</button>
                </form>
            </div>
        </div>
    </div>

    <div id="loading" class="loading">
        <div class="spinner"></div>
        <p>å¤„ç†ä¸­...</p>
    </div>

    <script>
        let merchants = [];
        let buttons = [];
        let templates = [];
        let triggers = [];
        let tasks = [];
        let bindCodes = [];
        let regions = [];
        let buttonRowCount = 0;

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            initializePriceSelectors();
            loadAllData();
        });

        // åˆå§‹åŒ–ä»·æ ¼é€‰æ‹©å™¨
        function initializePriceSelectors() {
            const price1Select = document.getElementById('editPrice1');
            const price2Select = document.getElementById('editPrice2');
            
            // ç”Ÿæˆä»·æ ¼é€‰é¡¹ï¼Œä»100åˆ°5000ï¼Œé—´éš”100
            for (let price = 100; price <= 5000; price += 100) {
                const option1 = document.createElement('option');
                option1.value = price;
                option1.textContent = price;
                price1Select.appendChild(option1);
                
                const option2 = document.createElement('option');
                option2.value = price;
                option2.textContent = price;
                price2Select.appendChild(option2);
            }
        }

        // æ˜¾ç¤ºæç¤ºä¿¡æ¯
        function showAlert(message, type = 'success') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            
            const container = document.querySelector('.container');
            container.insertBefore(alertDiv, container.firstChild);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 3000);
        }

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        function showLoading() {
            document.getElementById('loading').style.display = 'block';
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function showTab(tabName) {
            // éšè—æ‰€æœ‰æ ‡ç­¾å†…å®¹
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // ç§»é™¤æ‰€æœ‰æ ‡ç­¾çš„æ¿€æ´»çŠ¶æ€
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // æ˜¾ç¤ºé€‰ä¸­çš„æ ‡ç­¾å†…å®¹
            document.getElementById(tabName).classList.add('active');
            
            // æ¿€æ´»é€‰ä¸­çš„æ ‡ç­¾
            event.target.classList.add('active');
            
            // åŠ è½½å¯¹åº”æ•°æ®
            if (tabName === 'dashboard') {
                loadStats();
                loadMerchantBookingStats();
                loadMessageStats();
                loadRecentBookings();
                loadButtonStats();
            }
        }

        // åŠ è½½æ‰€æœ‰æ•°æ®
        async function loadAllData() {
            showLoading();
            try {
                await Promise.all([
                    loadMerchants(),
                    loadButtons(),
                    loadTemplates(),
                    loadTriggers(),
                    loadTasks(),
                    loadBindCodes(),
                    loadRegions(),
                    loadStats()
                ]);
                updateSelects();
                // ç¡®ä¿æµ‹è¯•å‘é€é¡µé¢çš„å•†å®¶é€‰æ‹©å™¨ä¹Ÿå¾—åˆ°æ›´æ–°
                if (typeof updateMerchantSelect === 'function') {
                    updateMerchantSelect();
                }
                loadChatId(); // åŠ è½½ä¿å­˜çš„ç¾¤ç»„ID
            } catch (error) {
                showAlert('åŠ è½½æ•°æ®å¤±è´¥: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // APIè¯·æ±‚å°è£…
        async function apiRequest(url, method = 'GET', data = null) {
            const options = {
                method,
                headers: {
                    'Content-Type': 'application/json'
                }
            };
            
            if (data) {
                options.body = JSON.stringify(data);
            }
            
            const response = await fetch(url, options);
            const result = await response.json();
            
            if (!result.success) {
                throw new Error(result.error || 'è¯·æ±‚å¤±è´¥');
            }
            
            return result.data;
        }

        // åŠ è½½ç»‘å®šç æ•°æ®
        async function loadBindCodes() {
            try {
                bindCodes = await apiRequest('/api/bind-codes');
                renderBindCodes();
            } catch (error) {
                console.error('åŠ è½½ç»‘å®šç å¤±è´¥:', error);
            }
        }

        // æ¸²æŸ“ç»‘å®šç åˆ—è¡¨
        function renderBindCodes() {
            const container = document.getElementById('bindCodesList');
            if (!container) return;

            if (bindCodes.length === 0) {
                container.innerHTML = '<p>æš‚æ— ç»‘å®šç </p>';
                return;
            }

            container.innerHTML = bindCodes.map(code => `
                <div class="list-item">
                    <div class="list-item-content">
                        <strong>ğŸ”‘ ${code.code}</strong>
                        <div style="color: #666; font-size: 14px; margin-top: 5px;">
                            ğŸ“ ${code.description || 'æ— æè¿°'}
                        </div>
                        <div style="color: #666; font-size: 12px; margin-top: 5px;">
                            ${code.used ? 
                                `âœ… å·²ä½¿ç”¨ - ç»‘å®šå•†å®¶: ${code.teacher_name || 'æœªçŸ¥'} (@${code.username || 'æœªçŸ¥'})` : 
                                'â³ æœªä½¿ç”¨'
                            }
                        </div>
                        <div style="color: #999; font-size: 12px;">
                            åˆ›å»ºæ—¶é—´: ${new Date(code.created_at * 1000).toLocaleString()}
                        </div>
                    </div>
                    <div class="list-item-actions">
                        ${!code.used ? 
                            `<button class="btn btn-danger btn-small" onclick="deleteBindCode(${code.id})">åˆ é™¤</button>` : 
                            `<button class="btn btn-warning btn-small" onclick="forceDeleteBindCode(${code.id})">å¼ºåˆ¶åˆ é™¤</button>`
                        }
                    </div>
                </div>
            `).join('');
        }

        // åˆ›å»ºç»‘å®šç 
        async function createBindCode(event) {
            event.preventDefault();
            const description = document.getElementById('bindCodeDescription').value;

            try {
                showLoading();
                const result = await apiRequest('/api/bind-codes', 'POST', { description });
                showAlert(`ç»‘å®šç åˆ›å»ºæˆåŠŸï¼ç»‘å®šç ï¼š${result.code}`);
                document.getElementById('bindCodeDescription').value = '';
                await loadBindCodes();
            } catch (error) {
                showAlert('åˆ›å»ºç»‘å®šç å¤±è´¥: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // åˆ é™¤ç»‘å®šç 
        async function deleteBindCode(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªç»‘å®šç å—ï¼Ÿ')) return;

            try {
                showLoading();
                await apiRequest('/api/bind-codes', 'DELETE', { id });
                showAlert('ç»‘å®šç åˆ é™¤æˆåŠŸ');
                await loadBindCodes();
            } catch (error) {
                showAlert('åˆ é™¤ç»‘å®šç å¤±è´¥: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // å¼ºåˆ¶åˆ é™¤å·²ä½¿ç”¨çš„ç»‘å®šç 
        async function forceDeleteBindCode(id) {
            if (!confirm('ç¡®å®šè¦å¼ºåˆ¶åˆ é™¤è¿™ä¸ªå·²ä½¿ç”¨çš„ç»‘å®šç å—ï¼Ÿ\næ³¨æ„ï¼šè¿™å°†åˆ é™¤å·²ç»ç»‘å®šçš„å•†å®¶ç›¸å…³çš„ç»‘å®šç è®°å½•ï¼')) return;

            try {
                showLoading();
                await apiRequest('/api/bind-codes/force-delete', 'DELETE', { id });
                showAlert('ç»‘å®šç å·²å¼ºåˆ¶åˆ é™¤');
                await loadBindCodes();
            } catch (error) {
                showAlert('å¼ºåˆ¶åˆ é™¤ç»‘å®šç å¤±è´¥: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // æ‰¹é‡åˆ é™¤æµ‹è¯•ç»‘å®šç 
        async function batchDeleteTestBindCodes() {
            if (!confirm('ç¡®å®šè¦æ‰¹é‡åˆ é™¤æ‰€æœ‰æµ‹è¯•ç»‘å®šç å—ï¼Ÿ\nè¿™å°†åˆ é™¤æ‰€æœ‰æè¿°ä¸­åŒ…å«"æµ‹è¯•"çš„ç»‘å®šç ï¼ˆåŒ…æ‹¬å·²ä½¿ç”¨çš„ï¼‰ï¼')) return;

            try {
                showLoading();
                const result = await apiRequest('/api/bind-codes/batch-delete-test', 'DELETE');
                showAlert(`æ‰¹é‡åˆ é™¤æˆåŠŸï¼åˆ é™¤äº† ${result.deletedCount} ä¸ªæµ‹è¯•ç»‘å®šç `);
                await loadBindCodes();
            } catch (error) {
                showAlert('æ‰¹é‡åˆ é™¤æµ‹è¯•ç»‘å®šç å¤±è´¥: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // åŠ è½½åœ°åŒºæ•°æ®
        async function loadRegions() {
            try {
                regions = await apiRequest('/api/regions');
                renderRegions();
            } catch (error) {
                console.error('åŠ è½½åœ°åŒºå¤±è´¥:', error);
            }
        }

        // æ¸²æŸ“åœ°åŒºåˆ—è¡¨
        function renderRegions() {
            const container = document.getElementById('regionsList');
            if (!container) return;

            if (regions.length === 0) {
                container.innerHTML = '<p>æš‚æ— åœ°åŒºé…ç½®</p>';
                return;
            }

            container.innerHTML = regions.map(region => `
                <div class="list-item">
                    <div class="list-item-content">
                        <strong>ğŸ“ ${region.name}</strong>
                        <div style="color: #666; font-size: 14px; margin-top: 5px;">
                            æ’åº: ${region.sort_order}
                        </div>
                    </div>
                    <div class="list-item-actions">
                        <button class="btn btn-warning btn-small" onclick="editRegion(${region.id}, '${region.name}', ${region.sort_order})">ç¼–è¾‘</button>
                        <button class="btn btn-danger btn-small" onclick="deleteRegion(${region.id})">åˆ é™¤</button>
                    </div>
                </div>
            `).join('');
        }

        // åˆ›å»ºåœ°åŒº
        async function createRegion(event) {
            event.preventDefault();
            const name = document.getElementById('regionName').value;
            const sortOrder = parseInt(document.getElementById('regionSortOrder').value) || 0;

            try {
                showLoading();
                await apiRequest('/api/regions', 'POST', { name, sortOrder });
                showAlert('åœ°åŒºæ·»åŠ æˆåŠŸ');
                document.getElementById('regionName').value = '';
                document.getElementById('regionSortOrder').value = '0';
                await loadRegions();
            } catch (error) {
                showAlert('æ·»åŠ åœ°åŒºå¤±è´¥: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // ç¼–è¾‘åœ°åŒº
        function editRegion(id, currentName, currentSortOrder) {
            const name = prompt('è¯·è¾“å…¥æ–°çš„åœ°åŒºåç§°:', currentName);
            if (!name) return;

            const sortOrder = prompt('è¯·è¾“å…¥æ’åºé¡ºåº:', currentSortOrder);
            if (sortOrder === null) return;

            updateRegion(id, name, parseInt(sortOrder) || 0);
        }

        // æ›´æ–°åœ°åŒº
        async function updateRegion(id, name, sortOrder) {
            try {
                showLoading();
                await apiRequest('/api/regions', 'PUT', { id, name, sortOrder });
                showAlert('åœ°åŒºæ›´æ–°æˆåŠŸ');
                await loadRegions();
            } catch (error) {
                showAlert('æ›´æ–°åœ°åŒºå¤±è´¥: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // åˆ é™¤åœ°åŒº
        async function deleteRegion(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªåœ°åŒºå—ï¼Ÿåˆ é™¤åç›¸å…³å•†å®¶çš„åœ°åŒºä¿¡æ¯å°†ä¸¢å¤±ã€‚')) return;

            try {
                showLoading();
                await apiRequest('/api/regions', 'DELETE', { id });
                showAlert('åœ°åŒºåˆ é™¤æˆåŠŸ');
                await loadRegions();
            } catch (error) {
                showAlert('åˆ é™¤åœ°åŒºå¤±è´¥: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // åŠ è½½ç»Ÿè®¡æ•°æ®
        async function loadStats() {
            try {
                console.log('å¼€å§‹åŠ è½½ç»Ÿè®¡æ•°æ®...');
                
                // è·å–8ä¸ªæ ¸å¿ƒè®¢å•æŒ‡æ ‡
                const orderStats = await apiRequest('/api/stats/optimized');
                console.log('è·å–è®¢å•ç»Ÿè®¡æ•°æ®:', orderStats);
                
                // è·å–åŸºç¡€ç³»ç»Ÿæ•°æ®
                const basicStats = await apiRequest('/api/stats');
                console.log('è·å–åŸºç¡€ç»Ÿè®¡æ•°æ®:', basicStats);
                
                // æ›´æ–°8ä¸ªæ ¸å¿ƒè®¢å•æŒ‡æ ‡
                document.getElementById('totalOrders').textContent = orderStats.totalOrders || 0;
                document.getElementById('bookedOrders').textContent = orderStats.bookedOrders || 0;
                document.getElementById('incompleteOrders').textContent = orderStats.incompleteOrders || 0;
                document.getElementById('completedOrders').textContent = orderStats.completedOrders || 0;
                document.getElementById('avgPrice').textContent = orderStats.avgPrice ? `Â¥${orderStats.avgPrice}` : 'Â¥0';
                document.getElementById('avgUserRating').textContent = orderStats.avgUserRating > 0 ? `${orderStats.avgUserRating}/10` : '-';
                document.getElementById('avgMerchantRating').textContent = orderStats.avgMerchantRating > 0 ? `${orderStats.avgMerchantRating}/10` : '-';
                document.getElementById('completionRate').textContent = `${orderStats.completionRate || 0}%`;
                
                // æ›´æ–°åŸºç¡€ç³»ç»Ÿæ•°æ®
                document.getElementById('totalMerchants').textContent = basicStats.totalMerchants || 0;
                document.getElementById('totalBindCodes').textContent = basicStats.totalBindCodes || 0;
                document.getElementById('totalRegions').textContent = basicStats.totalRegions || 0;
                document.getElementById('totalTemplates').textContent = basicStats.totalTemplates || 0;
                document.getElementById('totalClicks').textContent = basicStats.totalClicks || 0;
                
                console.log('ç»Ÿè®¡æ•°æ®åŠ è½½å®Œæˆ');
            } catch (error) {
                console.error('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
            }
        }

        // åŠ è½½å•†å®¶é¢„çº¦ç»Ÿè®¡
        async function loadMerchantBookingStats() {
            try {
                const stats = await apiRequest('/api/merchant-bookings');
                const container = document.getElementById('merchantBookingStats');
                
                if (stats.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #666;">æš‚æ— é¢„çº¦è®°å½•</p>';
                    return;
                }

                // è®¡ç®—æ€»é¢„çº¦æ•°
                const totalBookings = stats.reduce((sum, merchant) => sum + merchant.booking_count, 0);
                document.getElementById('totalBookings').textContent = totalBookings;

                container.innerHTML = stats.map(merchant => {
                    const bookingDetails = merchant.booking_details ? 
                        merchant.booking_details.split('; ').filter(detail => detail.trim()).map(detail => {
                            const [username, courseType, time] = detail.split('|');
                            return `<div style="font-size: 12px; color: #666; margin: 2px 0;">
                                ${username} - ${courseType} - ${time}
                            </div>`;
                        }).join('') : '';

                    return `
                        <div class="list-item">
                            <div class="list-item-content">
                                <strong>ğŸ‘¨â€ğŸ« ${merchant.teacher_name || 'æœªçŸ¥è€å¸ˆ'}</strong>
                                <div style="color: #666; font-size: 14px; margin-top: 5px;">
                                    ğŸ“ åœ°åŒº: ${merchant.region_name || 'æœªè®¾ç½®'}
                                </div>
                                <div style="margin-top: 8px;">
                                    <span class="badge success">é¢„çº¦æ¬¡æ•°: ${merchant.booking_count}</span>
                                </div>
                                ${bookingDetails ? `<div style="margin-top: 10px; border-top: 1px solid #eee; padding-top: 8px;">
                                    <strong style="font-size: 12px;">é¢„çº¦è¯¦æƒ…:</strong>
                                    ${bookingDetails}
                                </div>` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('åŠ è½½å•†å®¶é¢„çº¦ç»Ÿè®¡å¤±è´¥:', error);
                document.getElementById('merchantBookingStats').innerHTML = '<p style="color: red;">åŠ è½½å¤±è´¥</p>';
            }
        }

        // åŠ è½½æ¶ˆæ¯ç»Ÿè®¡
        async function loadMessageStats() {
            try {
                const stats = await apiRequest('/api/message-stats');
                const container = document.getElementById('messageStats');
                
                if (stats.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #666;">æš‚æ— æ¶ˆæ¯äº’åŠ¨è®°å½•</p>';
                    return;
                }

                container.innerHTML = stats.map(stat => {
                    const actionTypeText = {
                        'click': 'æŒ‰é’®ç‚¹å‡»',
                        'template_click': 'æ¨¡æ¿ç‚¹å‡»',
                        'view': 'æ¶ˆæ¯æµè§ˆ'
                    }[stat.action_type] || stat.action_type;

                    return `
                        <div class="list-item">
                            <div class="list-item-content">
                                <strong>ğŸ“Š ${actionTypeText}</strong>
                                <div style="color: #666; font-size: 14px; margin-top: 5px;">
                                    ğŸ’¬ ç¾¤ç»„ID: ${stat.chat_id}
                                </div>
                                <div style="color: #666; font-size: 14px;">
                                    ğŸ‘¥ ç‹¬ç«‹ç”¨æˆ·: ${stat.unique_users} äºº
                                </div>
                                <div style="color: #666; font-size: 14px;">
                                    ğŸ•’ æœ€åäº’åŠ¨: ${stat.last_interaction || 'æœªçŸ¥'}
                                </div>
                                <div style="margin-top: 8px;">
                                    <span class="badge info">æ€»æ¬¡æ•°: ${stat.count}</span>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('åŠ è½½æ¶ˆæ¯ç»Ÿè®¡å¤±è´¥:', error);
                document.getElementById('messageStats').innerHTML = '<p style="color: red;">åŠ è½½å¤±è´¥</p>';
            }
        }

        // åŠ è½½æœ€è¿‘é¢„çº¦è®°å½•
        async function loadRecentBookings() {
            try {
                const bookings = await apiRequest('/api/recent-bookings');
                const container = document.getElementById('recentBookings');
                
                if (bookings.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #666;">æš‚æ— æœ€è¿‘é¢„çº¦è®°å½•</p>';
                    return;
                }

                container.innerHTML = bookings.map(booking => {
                    // æ„å»ºç”¨æˆ·æ˜¾ç¤ºåç§°
                    const fullName = `${booking.first_name || ''} ${booking.last_name || ''}`.trim() || 'æœªè®¾ç½®åç§°';
                    const username = booking.username ? `@${booking.username}` : 'æœªè®¾ç½®ç”¨æˆ·å';
                    const displayName = `${fullName}ï¼ˆ${username}ï¼‰`;
                    
                    return `
                        <div class="list-item">
                            <div class="list-item-content">
                                <strong>ğŸ‘¤ ${displayName}</strong>
                                <div style="color: #666; font-size: 14px; margin-top: 5px;">
                                    ğŸ‘¨â€ğŸ« é¢„çº¦è€å¸ˆ: ${booking.teacher_name || 'æœªçŸ¥'}
                                </div>
                                <div style="color: #666; font-size: 14px;">
                                    ğŸ“ åœ°åŒº: ${booking.region_name || 'æœªè®¾ç½®'}
                                </div>
                                <div style="color: #666; font-size: 14px;">
                                    ğŸ•’ é¢„çº¦æ—¶é—´: ${booking.booking_time}
                                </div>
                                <div style="margin-top: 8px;">
                                    <span class="badge info">${booking.course_type}</span>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('åŠ è½½æœ€è¿‘é¢„çº¦è®°å½•å¤±è´¥:', error);
                document.getElementById('recentBookings').innerHTML = '<p style="color: red;">åŠ è½½å¤±è´¥</p>';
            }
        }

        // åŠ è½½æŒ‰é’®ç‚¹å‡»ç»Ÿè®¡
        async function loadButtonStats() {
            try {
                const stats = await apiRequest('/api/button-stats');
                const container = document.getElementById('buttonStats');
                
                if (stats.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #666;">æš‚æ— æŒ‰é’®ç‚¹å‡»è®°å½•</p>';
                    return;
                }

                container.innerHTML = stats.map(button => `
                    <div class="list-item">
                        <div class="list-item-content">
                            <strong>ğŸ”˜ ${button.title}</strong>
                            <div style="color: #666; font-size: 14px; margin-top: 5px;">
                                ğŸ‘¨â€ğŸ« å…³è”å•†å®¶: ${button.merchant_name || 'æ— '}
                            </div>
                            <div style="color: #666; font-size: 14px;">
                                ğŸ•’ æœ€åç‚¹å‡»: ${button.last_click || 'ä»æœªç‚¹å‡»'}
                            </div>
                            <div style="margin-top: 8px;">
                                <span class="badge success">ç‚¹å‡»æ¬¡æ•°: ${button.click_count}</span>
                                <span class="badge info">äº’åŠ¨è®°å½•: ${button.interaction_count}</span>
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('åŠ è½½æŒ‰é’®ç»Ÿè®¡å¤±è´¥:', error);
                document.getElementById('buttonStats').innerHTML = '<p style="color: red;">åŠ è½½å¤±è´¥</p>';
            }
        }

        // åŠ è½½å•†å®¶æ•°æ®
        async function loadMerchants() {
            try {
                merchants = await apiRequest('/api/merchants');
                renderMerchants();
                updateSelects(); // æ›´æ–°ä¸‹æ‹‰é€‰æ‹©æ¡†
            } catch (error) {
                console.error('åŠ è½½å•†å®¶æ•°æ®å¤±è´¥:', error);
                showAlert('åŠ è½½å•†å®¶æ•°æ®å¤±è´¥: ' + error.message, 'error');
                document.getElementById('merchantsList').innerHTML = '<p style="color: red;">åŠ è½½å•†å®¶æ•°æ®å¤±è´¥</p>';
            }
        }

        function renderMerchants() {
            const container = document.getElementById('merchantsList');
            if (merchants.length === 0) {
                container.innerHTML = '<p>æš‚æ— å·²ç»‘å®šçš„å•†å®¶</p>';
                return;
            }
            
            container.innerHTML = merchants.map(merchant => `
                <div class="list-item">
                    <div class="list-item-content">
                        <strong>ğŸ‘¨â€ğŸ« ${merchant.teacher_name || 'æœªçŸ¥è€å¸ˆ'}</strong>
                        <div style="color: #666; font-size: 14px; margin-top: 5px;">
                            ğŸ“ åœ°åŒº: ${merchant.region_name || 'æœªè®¾ç½®'}
                        </div>
                        <div style="color: #666; font-size: 14px;">
                            ğŸ“ è”ç³»æ–¹å¼: ${merchant.contact || 'æœªè®¾ç½®'}
                        </div>
                        <div style="color: #666; font-size: 14px;">
                            ğŸ”‘ ç»‘å®šç : <code>${merchant.bind_code || 'æœªçŸ¥'}</code>
                        </div>
                        <div style="color: #666; font-size: 14px;">
                            ğŸ‘¤ ç”¨æˆ·ID: ${merchant.user_id} ${merchant.username ? `(@${merchant.username})` : ''}
                        </div>
                        <div style="color: #999; font-size: 12px; margin-top: 5px;">
                            ç»‘å®šæ—¶é—´: ${new Date(merchant.created_at * 1000).toLocaleString()}
                        </div>
                        <div style="margin-top: 8px;">
                            <span class="badge ${merchant.status === 'active' ? 'success' : 'warning'}">
                                ${merchant.status === 'active' ? 'æ­£å¸¸' : 'æš‚åœ'}
                            </span>
                            <span class="badge info">
                                ç»‘å®šæ­¥éª¤: ${merchant.bind_step}/5
                            </span>
                        </div>
                    </div>
                    <div class="list-item-actions">
                        <button class="btn btn-primary btn-small" onclick="editMerchant(${merchant.id})">ç¼–è¾‘</button>
                        <button class="btn ${merchant.status === 'active' ? 'btn-warning' : 'btn-success'} btn-small" onclick="toggleMerchantStatus(${merchant.id})">
                            ${merchant.status === 'active' ? 'æš‚åœ' : 'å¯åŠ¨'}
                        </button>
                        <button class="btn btn-danger btn-small" onclick="deleteMerchant(${merchant.id})">åˆ é™¤</button>
                    </div>
                </div>
            `).join('');
        }

        // ç¼–è¾‘å•†å®¶ä¿¡æ¯
        function editMerchant(id) {
            // éªŒè¯ç®¡ç†å‘˜å¯†ç 
            const password = prompt('è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç ä»¥è¿›è¡Œç¼–è¾‘æ“ä½œï¼š');
            if (password !== '9229') {
                showAlert('ç®¡ç†å‘˜å¯†ç é”™è¯¯ï¼Œç¼–è¾‘æ“ä½œå·²å–æ¶ˆ', 'error');
                return;
            }

            const merchant = merchants.find(m => m.id === id);
            if (!merchant) return;

            // å¡«å……åŸºæœ¬ä¿¡æ¯
            document.getElementById('editMerchantId').value = id;
            document.getElementById('editTeacherName').value = merchant.teacher_name || '';
            document.getElementById('editRegionId').value = merchant.region_id || '';
            document.getElementById('editContact').value = merchant.contact || '';
            
            // å¡«å……æ¨¡æ¿ä¿¡æ¯
            document.getElementById('editAdvantages').value = merchant.advantages || '';
            document.getElementById('editDisadvantages').value = merchant.disadvantages || '';
            document.getElementById('editPrice1').value = merchant.price1 || '';
            document.getElementById('editPrice2').value = merchant.price2 || '';
            document.getElementById('editWash').value = merchant.skill_wash || '';
            document.getElementById('editBlow').value = merchant.skill_blow || '';
            document.getElementById('editDo').value = merchant.skill_do || '';
            document.getElementById('editKiss').value = merchant.skill_kiss || '';
            
            // æ›´æ–°åœ°åŒºé€‰æ‹©æ¡†
            const regionSelect = document.getElementById('editRegionId');
            regionSelect.innerHTML = '<option value="">é€‰æ‹©åœ°åŒº</option>' + 
                regions.map(r => `<option value="${r.id}" ${r.id === merchant.region_id ? 'selected' : ''}>${r.name}</option>`).join('');
            
            // æ›´æ–°åœ°åŒºå‰ç¼€æ˜¾ç¤º
            updateRegionPrefix();
            
            // å­˜å‚¨åŸå§‹è”ç³»æ–¹å¼ç”¨äº"ä½¿ç”¨ç»‘å®šè”ç³»æ–¹å¼"åŠŸèƒ½
            window.currentMerchantBindContact = merchant.contact;
            
            document.getElementById('merchantEditModal').style.display = 'block';
        }

        // å…³é—­ç¼–è¾‘æ¨¡æ€æ¡†
        function closeMerchantEditModal() {
            document.getElementById('merchantEditModal').style.display = 'none';
        }

        // æ›´æ–°åœ°åŒºå‰ç¼€æ˜¾ç¤º
        function updateRegionPrefix() {
            const regionSelect = document.getElementById('editRegionId');
            const regionPrefix = document.getElementById('regionPrefix');
            
            if (regionSelect.value) {
                const selectedRegion = regions.find(r => r.id == regionSelect.value);
                if (selectedRegion) {
                    regionPrefix.textContent = selectedRegion.name;
                } else {
                    regionPrefix.textContent = 'xx';
                }
            } else {
                regionPrefix.textContent = 'xx';
            }
        }

        // ä½¿ç”¨ç»‘å®šè”ç³»æ–¹å¼
        function useBindContact() {
            const contactInput = document.getElementById('editContact');
            if (window.currentMerchantBindContact) {
                contactInput.value = window.currentMerchantBindContact;
                showAlert('å·²å¡«å…¥ç»‘å®šæ—¶çš„è”ç³»æ–¹å¼', 'info');
            } else {
                showAlert('æœªæ‰¾åˆ°ç»‘å®šæ—¶çš„è”ç³»æ–¹å¼', 'warning');
            }
        }

        // é¢„è§ˆå•†å®¶ä¿¡æ¯
        function previewMerchantInfo() {
            const regionSelect = document.getElementById('editRegionId');
            const selectedRegion = regions.find(r => r.id == regionSelect.value);
            const regionName = selectedRegion ? selectedRegion.name : 'xx';
            
            const teacherName = document.getElementById('editTeacherName').value || 'æœªå¡«å†™';
            const advantages = document.getElementById('editAdvantages').value || 'æœªå¡«å†™';
            const disadvantages = document.getElementById('editDisadvantages').value || 'æœªå¡«å†™';
            const price1 = document.getElementById('editPrice1').value || 'æœªå¡«å†™';
            const price2 = document.getElementById('editPrice2').value || 'æœªå¡«å†™';
            const contact = document.getElementById('editContact').value || 'æœªå¡«å†™';
            const skillWash = document.getElementById('editWash').value || 'æœªå¡«å†™';
            const skillBlow = document.getElementById('editBlow').value || 'æœªå¡«å†™';
            const skillDo = document.getElementById('editDo').value || 'æœªå¡«å†™';
            const skillKiss = document.getElementById('editKiss').value || 'æœªå¡«å†™';

            const preview = `åœ°åŒºï¼š#${regionName}              è‰ºåï¼š${teacherName}
ä¼˜ç‚¹ï¼š${advantages}
ç¼ºç‚¹ï¼š${disadvantages}
ä»·æ ¼ï¼š${price1}p              ${price2}pp
è”ç³»ï¼š${contact}

è€å¸ˆğŸ’ƒè‡ªå¡«åŸºæœ¬åŠŸï¼š
ğŸ’¦æ´—:${skillWash}
ğŸ‘„å¹:${skillBlow}
â¤ï¸åš:${skillDo}
ğŸå»:${skillKiss}`;

            document.getElementById('merchantInfoPreview').textContent = preview;
        }

        // æ›´æ–°å•†å®¶ä¿¡æ¯
        async function updateMerchant(event) {
            event.preventDefault();
            
            const id = document.getElementById('editMerchantId').value;
            const teacherName = document.getElementById('editTeacherName').value;
            const regionId = document.getElementById('editRegionId').value;
            const contact = document.getElementById('editContact').value;
            const advantages = document.getElementById('editAdvantages').value;
            const disadvantages = document.getElementById('editDisadvantages').value;
            const price1 = document.getElementById('editPrice1').value ? parseInt(document.getElementById('editPrice1').value) : null;
            const price2 = document.getElementById('editPrice2').value ? parseInt(document.getElementById('editPrice2').value) : null;
            const skillWash = document.getElementById('editWash').value;
            const skillBlow = document.getElementById('editBlow').value;
            const skillDo = document.getElementById('editDo').value;
            const skillKiss = document.getElementById('editKiss').value;

            try {
                showLoading();
                await apiRequest(`/api/merchants/${id}`, 'PUT', {
                    teacherName,
                    regionId,
                    contact,
                    advantages,
                    disadvantages,
                    price1,
                    price2,
                    skillWash,
                    skillBlow,
                    skillDo,
                    skillKiss
                });
                showAlert('å•†å®¶ä¿¡æ¯æ¨¡æ¿æ›´æ–°æˆåŠŸ');
                closeMerchantEditModal();
                await loadMerchants();
            } catch (error) {
                showAlert('æ›´æ–°å•†å®¶ä¿¡æ¯å¤±è´¥: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // æš‚åœ/å¯åŠ¨å•†å®¶
        async function toggleMerchantStatus(id) {
            const merchant = merchants.find(m => m.id === id);
            if (!merchant) return;

            const action = merchant.status === 'active' ? 'æš‚åœ' : 'å¯åŠ¨';
            
            // éªŒè¯ç®¡ç†å‘˜å¯†ç 
            const password = prompt(`è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç ä»¥${action}å•†å®¶ï¼š`);
            if (password !== '9229') {
                showAlert('ç®¡ç†å‘˜å¯†ç é”™è¯¯ï¼Œæ“ä½œå·²å–æ¶ˆ', 'error');
                return;
            }

            if (!confirm(`ç¡®å®šè¦${action}è¿™ä¸ªå•†å®¶å—ï¼Ÿ`)) return;

            try {
                showLoading();
                await apiRequest(`/api/merchants/${id}/toggle-status`, 'POST');
                showAlert(`å•†å®¶${action}æˆåŠŸ`);
                await loadMerchants();
            } catch (error) {
                showAlert(`${action}å•†å®¶å¤±è´¥: ` + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // åˆ é™¤å•†å®¶
        async function deleteMerchant(id) {
            // æ‰¾åˆ°è¦åˆ é™¤çš„å•†å®¶
            const merchant = merchants.find(m => m.id === id);
            if (!merchant) {
                showAlert('æœªæ‰¾åˆ°æŒ‡å®šçš„å•†å®¶', 'error');
                return;
            }

            if (!confirm(`ç¡®å®šè¦åˆ é™¤å•†å®¶"${merchant.teacher_name}"å—ï¼Ÿ\n\nâš ï¸ è¿™å°†åŒæ—¶åˆ é™¤ï¼š\n- ç›¸å…³çš„æŒ‰é’®æ•°æ®\n- ç›¸å…³çš„äº¤äº’è®°å½•\n- ç›¸å…³çš„é¢„çº¦æ•°æ®\n\næ­¤æ“ä½œä¸å¯æ’¤é”€ï¼`)) return;

            // éªŒè¯ç®¡ç†å‘˜å¯†ç 
            const password = prompt('è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç ä»¥ç¡®è®¤åˆ é™¤æ“ä½œï¼š');
            if (password !== '9229') {
                showAlert('ç®¡ç†å‘˜å¯†ç é”™è¯¯ï¼Œåˆ é™¤æ“ä½œå·²å–æ¶ˆ', 'error');
                return;
            }

            try {
                console.log(`å¼€å§‹åˆ é™¤å•†å®¶: ID=${id}, å§“å=${merchant.teacher_name}`);
                showLoading();
                
                // å…ˆæ£€æŸ¥ä¾èµ–å…³ç³»
                console.log('æ£€æŸ¥å•†å®¶ä¾èµ–å…³ç³»...');
                const checkResponse = await fetch(`/api/merchants/${id}/dependencies`);
                if (checkResponse.ok) {
                    const dependencies = await checkResponse.json();
                    if (dependencies.data && dependencies.data.total > 0) {
                        const details = [];
                        if (dependencies.data.orders > 0) details.push(`${dependencies.data.orders}ä¸ªè®¢å•`);
                        if (dependencies.data.bookingSessions > 0) details.push(`${dependencies.data.bookingSessions}ä¸ªé¢„çº¦`);
                        if (dependencies.data.buttons > 0) details.push(`${dependencies.data.buttons}ä¸ªæŒ‰é’®`);
                        
                        const confirmMessage = `è¯¥å•†å®¶æœ‰ä»¥ä¸‹ç›¸å…³æ•°æ®ï¼š\n${details.join('ã€')}\n\nç»§ç»­åˆ é™¤å°†æ¸…é™¤æ‰€æœ‰ç›¸å…³æ•°æ®ï¼Œç¡®å®šç»§ç»­å—ï¼Ÿ`;
                        if (!confirm(confirmMessage)) {
                            hideLoading();
                            return;
                        }
                    }
                }
                
                const response = await fetch(`/api/merchants/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTPé”™è¯¯: ${response.status} ${response.statusText}`);
                }

                const result = await response.json();
                console.log('åˆ é™¤APIå“åº”:', result);
                
                if (!result.success) {
                    throw new Error(result.error || result.message || 'åˆ é™¤å¤±è´¥');
                }

                showAlert(`å•†å®¶"${merchant.teacher_name}"åˆ é™¤æˆåŠŸ`, 'success');
                console.log('åˆ é™¤æˆåŠŸï¼Œå¼€å§‹é‡æ–°åŠ è½½æ•°æ®...');
                
                // é‡æ–°åŠ è½½æ‰€æœ‰ç›¸å…³æ•°æ®
                await Promise.all([
                    loadMerchants(),
                    loadButtons(),
                    loadStats() // å¦‚æœå­˜åœ¨ç»Ÿè®¡æ•°æ®ä¹Ÿéœ€è¦åˆ·æ–°
                ]);
                
                console.log('æ•°æ®é‡æ–°åŠ è½½å®Œæˆ');
                
            } catch (error) {
                console.error('åˆ é™¤å•†å®¶å¤±è´¥:', error);
                
                // è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯å¤„ç†
                let errorMessage = 'åˆ é™¤å•†å®¶å¤±è´¥';
                if (error.message) {
                    if (error.message.includes('FOREIGN KEY constraint')) {
                        errorMessage = 'åˆ é™¤å¤±è´¥ï¼šè¯¥å•†å®¶ä»æœ‰ç›¸å…³æ•°æ®å¼•ç”¨ï¼Œè¯·å…ˆåˆ é™¤ç›¸å…³çš„è®¢å•ã€é¢„çº¦æˆ–å…¶ä»–å…³è”æ•°æ®';
                    } else if (error.message.includes('HTTPé”™è¯¯')) {
                        errorMessage = `ç½‘ç»œé”™è¯¯ï¼š${error.message}`;
                    } else {
                        errorMessage = `åˆ é™¤å¤±è´¥ï¼š${error.message}`;
                    }
                }
                
                showAlert(errorMessage, 'error');
            } finally {
                hideLoading();
            }
        }

        // åŠ è½½æŒ‰é’®æ•°æ®
        async function loadButtons() {
            buttons = await apiRequest('/api/buttons');
            renderButtons();
        }

        function renderButtons() {
            const container = document.getElementById('buttonsList');
            if (buttons.length === 0) {
                container.innerHTML = '<p>æš‚æ— æŒ‰é’®æ•°æ®</p>';
                return;
            }
            
            container.innerHTML = buttons.map(button => `
                <div class="list-item">
                    <div class="list-item-content">
                        <strong>${button.title}</strong>
                        <div>å•†å®¶: ${button.merchant_name || 'æœªå…³è”'}</div>
                        <div>ç‚¹å‡»æ¬¡æ•°: <span class="badge info">${button.click_count}</span></div>
                    </div>
                    <div class="list-item-actions">
                        <button onclick="deleteButton(${button.id})" class="btn btn-danger btn-small">åˆ é™¤</button>
                    </div>
                </div>
            `).join('');
        }

        // åŠ è½½æ¶ˆæ¯æ¨¡æ¿
        async function loadTemplates() {
            templates = await apiRequest('/api/templates');
            renderTemplates();
        }

        function renderTemplates() {
            const container = document.getElementById('templatesList');
            if (templates.length === 0) {
                container.innerHTML = '<p>æš‚æ— æ¨¡æ¿æ•°æ®</p>';
                return;
            }
            
            container.innerHTML = templates.map(template => `
                <div class="list-item">
                    <div class="list-item-content">
                        <strong>${template.name}</strong>
                        <div>${template.content.substring(0, 100)}${template.content.length > 100 ? '...' : ''}</div>
                        ${template.image_url ? '<div><span class="badge info">åŒ…å«å›¾ç‰‡</span></div>' : ''}
                        ${template.buttons_config ? '<div><span class="badge success">åŒ…å«æŒ‰é’®</span></div>' : ''}
                    </div>
                    <div class="list-item-actions">
                        <button onclick="deleteTemplate(${template.id})" class="btn btn-danger btn-small">åˆ é™¤</button>
                    </div>
                </div>
            `).join('');
        }

        // åŠ è½½è§¦å‘è¯
        async function loadTriggers() {
            triggers = await apiRequest('/api/triggers');
            renderTriggers();
        }

        function renderTriggers() {
            const container = document.getElementById('triggersList');
            if (triggers.length === 0) {
                container.innerHTML = '<p>æš‚æ— è§¦å‘è¯æ•°æ®</p>';
                return;
            }
            
            container.innerHTML = triggers.map(trigger => `
                <div class="list-item">
                    <div class="list-item-content">
                        <strong>"${trigger.word}"</strong>
                        <div>æ¨¡æ¿: ${trigger.template_name || 'æœªå…³è”'}</div>
                        <div>åŒ¹é…æ¨¡å¼: <span class="badge">${trigger.match_type === 'exact' ? 'ç²¾ç¡®åŒ¹é…' : 'åŒ…å«åŒ¹é…'}</span></div>
                        <div>ç¾¤ç»„ID: ${trigger.chat_id} | è§¦å‘æ¬¡æ•°: <span class="badge info">${trigger.trigger_count}</span></div>
                    </div>
                    <div class="list-item-actions">
                        <button onclick="deleteTrigger(${trigger.id})" class="btn btn-danger btn-small">åˆ é™¤</button>
                    </div>
                </div>
            `).join('');
        }

        // åŠ è½½å®šæ—¶ä»»åŠ¡
        async function loadTasks() {
            tasks = await apiRequest('/api/tasks');
            renderTasks();
        }

        function renderTasks() {
            const container = document.getElementById('tasksList');
            if (tasks.length === 0) {
                container.innerHTML = '<p>æš‚æ— å®šæ—¶ä»»åŠ¡</p>';
                return;
            }
            
            container.innerHTML = tasks.map(task => `
                <div class="list-item">
                    <div class="list-item-content">
                        <strong>${task.name}</strong>
                        <div>æ¨¡æ¿: ${task.template_name || 'æœªå…³è”'}</div>
                        <div>ç±»å‹: <span class="badge">${getScheduleTypeText(task.schedule_type)}</span> | æ—¶é—´: ${task.schedule_time}</div>
                        <div>ç¾¤ç»„ID: ${task.chat_id} | çŠ¶æ€: <span class="badge ${task.active ? 'success' : 'warning'}">${task.active ? 'å¯ç”¨' : 'æš‚åœ'}</span></div>
                    </div>
                    <div class="list-item-actions">
                        <button onclick="deleteTask(${task.id})" class="btn btn-danger btn-small">åˆ é™¤</button>
                    </div>
                </div>
            `).join('');
        }

        function getScheduleTypeText(type) {
            const types = {
                'daily': 'æ¯æ—¥æ‰§è¡Œ',
                'weekly': 'æ¯å‘¨æ‰§è¡Œ',
                'cron': 'è‡ªå®šä¹‰Cron'
            };
            return types[type] || type;
        }

        // æ›´æ–°ä¸‹æ‹‰é€‰æ‹©æ¡†
        function updateSelects() {
            // æ›´æ–°å•†å®¶é€‰æ‹©æ¡†
            const merchantSelects = document.querySelectorAll('#buttonMerchant');
            merchantSelects.forEach(select => {
                select.innerHTML = '<option value="">é€‰æ‹©å•†å®¶</option>' + 
                    merchants.map(m => `<option value="${m.id}">${m.teacher_name || 'æœªçŸ¥å•†å®¶'}</option>`).join('');
            });

            // æ›´æ–°æ¨¡æ¿é€‰æ‹©æ¡†
            const templateSelects = document.querySelectorAll('#triggerTemplate, #taskTemplate, #testTemplate');
            templateSelects.forEach(select => {
                const defaultOption = select.id === 'testTemplate' ? '<option value="">è¯·é€‰æ‹©æ¶ˆæ¯æ¨¡æ¿</option>' : '<option value="">é€‰æ‹©æ¶ˆæ¯æ¨¡æ¿</option>';
                select.innerHTML = defaultOption + 
                    templates.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
            });
        }

        // æŒ‰é’®æ„å»ºå™¨
        function addButtonRow() {
            buttonRowCount++;
            const container = document.getElementById('buttonRows');
            const rowDiv = document.createElement('div');
            rowDiv.className = 'button-row';
            rowDiv.innerHTML = `
                <input type="text" placeholder="æŒ‰é’®æ–‡å­—" class="button-text" style="flex: 1;">
                <input type="text" placeholder="å›è°ƒæ•°æ®(å¯é€‰)" class="button-callback" style="flex: 1;">
                <button type="button" onclick="removeButtonRow(this)" class="btn btn-danger btn-small">åˆ é™¤</button>
            `;
            container.appendChild(rowDiv);
        }

        function removeButtonRow(button) {
            button.parentElement.remove();
        }

        // é¢„è§ˆæ¨¡æ¿
        function previewTemplate() {
            const name = document.getElementById('templateName').value;
            const content = document.getElementById('templateContent').value;
            const imageUrl = document.getElementById('templateImage').value;
            
            if (!content) {
                showAlert('è¯·è¾“å…¥æ¶ˆæ¯å†…å®¹', 'error');
                return;
            }

            const previewDiv = document.getElementById('templatePreview');
            const previewContent = document.getElementById('previewContent');
            
            let html = '';
            if (imageUrl) {
                html += `<img src="${imageUrl}" alt="é¢„è§ˆå›¾ç‰‡" onerror="this.style.display='none'"><br>`;
            }
            html += `<div>${content}</div>`;
            
            // æ·»åŠ æŒ‰é’®é¢„è§ˆ
            const buttonRows = document.querySelectorAll('#buttonRows .button-row');
            if (buttonRows.length > 0) {
                html += '<div style="margin-top: 10px;">';
                buttonRows.forEach(row => {
                    const text = row.querySelector('.button-text').value;
                    if (text) {
                        html += `<span class="preview-button">${text}</span>`;
                    }
                });
                html += '</div>';
            }
            
            previewContent.innerHTML = html;
            previewDiv.style.display = 'block';
        }

        // æ›´æ–°è°ƒåº¦è¾“å…¥
        function updateScheduleInput() {
            const type = document.getElementById('taskScheduleType').value;
            const input = document.getElementById('taskScheduleTime');
            const label = document.getElementById('scheduleLabel');
            const help = document.getElementById('scheduleHelp');
            
            switch (type) {
                case 'daily':
                    label.textContent = 'æ‰§è¡Œæ—¶é—´';
                    input.placeholder = '09:00';
                    help.textContent = 'æ ¼å¼ï¼šHH:MMï¼ˆ24å°æ—¶åˆ¶ï¼‰';
                    break;
                case 'weekly':
                    label.textContent = 'æ‰§è¡Œæ—¶é—´';
                    input.placeholder = '1:09:00';
                    help.textContent = 'æ ¼å¼ï¼šæ˜ŸæœŸ:HH:MMï¼ˆæ˜ŸæœŸ1-7ï¼Œå‘¨æ—¥ä¸º0ï¼‰';
                    break;
                case 'cron':
                    label.textContent = 'Cronè¡¨è¾¾å¼';
                    input.placeholder = '0 9 * * *';
                    help.textContent = 'æ ¼å¼ï¼šåˆ† æ—¶ æ—¥ æœˆ å‘¨ï¼ˆæ ‡å‡†Cronæ ¼å¼ï¼‰';
                    break;
            }
        }



        // åˆ›å»ºæŒ‰é’®
        async function createButton(event) {
            event.preventDefault();
            showLoading();
            
            try {
                const title = document.getElementById('buttonTitle').value;
                const message = document.getElementById('buttonMessage').value;
                const merchantId = document.getElementById('buttonMerchant').value;
                
                await apiRequest('/api/buttons', 'POST', { title, message, merchantId });
                
                showAlert('æŒ‰é’®åˆ›å»ºæˆåŠŸï¼');
                document.getElementById('buttonTitle').value = '';
                document.getElementById('buttonMessage').value = '';
                document.getElementById('buttonMerchant').value = '';
                
                await loadButtons();
            } catch (error) {
                showAlert('åˆ›å»ºå¤±è´¥: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // åˆ›å»ºæ¶ˆæ¯æ¨¡æ¿
        async function createTemplate(event) {
            event.preventDefault();
            showLoading();
            
            try {
                const name = document.getElementById('templateName').value;
                const content = document.getElementById('templateContent').value;
                const imageUrl = document.getElementById('templateImage').value;
                
                // æ”¶é›†æŒ‰é’®é…ç½®
                const buttonRows = document.querySelectorAll('#buttonRows .button-row');
                const buttonsConfig = [];
                
                if (buttonRows.length > 0) {
                    const currentRow = [];
                    buttonRows.forEach(row => {
                        const text = row.querySelector('.button-text').value;
                        const callback = row.querySelector('.button-callback').value;
                        if (text) {
                            currentRow.push({
                                text: text,
                                callback_data: callback || `template_btn_${text}`
                            });
                        }
                    });
                    if (currentRow.length > 0) {
                        buttonsConfig.push(currentRow);
                    }
                }
                
                await apiRequest('/api/templates', 'POST', {
                    name, content, imageUrl, buttonsConfig
                });
                
                showAlert('æ¨¡æ¿åˆ›å»ºæˆåŠŸï¼');
                document.getElementById('templateName').value = '';
                document.getElementById('templateContent').value = '';
                document.getElementById('templateImage').value = '';
                document.getElementById('buttonRows').innerHTML = '';
                document.getElementById('templatePreview').style.display = 'none';
                buttonRowCount = 0;
                
                await loadTemplates();
                updateSelects();
            } catch (error) {
                showAlert('åˆ›å»ºå¤±è´¥: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // åˆ›å»ºè§¦å‘è¯
        async function createTrigger(event) {
            event.preventDefault();
            showLoading();
            
            try {
                const word = document.getElementById('triggerWord').value;
                const templateId = document.getElementById('triggerTemplate').value;
                const matchType = document.getElementById('triggerMatchType').value;
                const chatId = document.getElementById('triggerChatId').value;
                
                await apiRequest('/api/triggers', 'POST', {
                    word, templateId, matchType, chatId
                });
                
                showAlert('è§¦å‘è¯åˆ›å»ºæˆåŠŸï¼');
                document.getElementById('triggerWord').value = '';
                document.getElementById('triggerTemplate').value = '';
                document.getElementById('triggerChatId').value = '';
                
                await loadTriggers();
            } catch (error) {
                showAlert('åˆ›å»ºå¤±è´¥: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // åˆ›å»ºå®šæ—¶ä»»åŠ¡
        async function createTask(event) {
            event.preventDefault();
            showLoading();
            
            try {
                const name = document.getElementById('taskName').value;
                const templateId = document.getElementById('taskTemplate').value;
                const chatId = document.getElementById('taskChatId').value;
                const scheduleType = document.getElementById('taskScheduleType').value;
                const scheduleTime = document.getElementById('taskScheduleTime').value;
                
                await apiRequest('/api/tasks', 'POST', {
                    name, templateId, chatId, scheduleType, scheduleTime
                });
                
                showAlert('å®šæ—¶ä»»åŠ¡åˆ›å»ºæˆåŠŸï¼');
                document.getElementById('taskName').value = '';
                document.getElementById('taskTemplate').value = '';
                document.getElementById('taskChatId').value = '';
                document.getElementById('taskScheduleTime').value = '';
                
                await loadTasks();
            } catch (error) {
                showAlert('åˆ›å»ºå¤±è´¥: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // å¤„ç†æ¨¡å—ç±»å‹å˜åŒ–
        function handleModuleTypeChange() {
            const moduleType = document.getElementById('testModuleType').value;
            
            // éšè—æ‰€æœ‰æ¨¡å—
            document.getElementById('merchantModule').style.display = 'none';
            document.getElementById('templateModule').style.display = 'none';
            document.getElementById('customModule').style.display = 'none';
            
            // æ˜¾ç¤ºé€‰ä¸­çš„æ¨¡å—
            if (moduleType === 'merchant') {
                document.getElementById('merchantModule').style.display = 'block';
                updateMerchantSelect();
            } else if (moduleType === 'template') {
                document.getElementById('templateModule').style.display = 'block';
            } else if (moduleType === 'custom') {
                document.getElementById('customModule').style.display = 'block';
            }
        }

        // æ›´æ–°å•†å®¶é€‰æ‹©å™¨
        function updateMerchantSelect() {
            const select = document.getElementById('testMerchant');
            select.innerHTML = '<option value="">è¯·é€‰æ‹©å•†å®¶</option>';
            
            merchants.forEach(merchant => {
                // æ£€æŸ¥ç»‘å®šæ­¥éª¤æ˜¯å¦å®Œæˆï¼ˆbind_step = 5ï¼‰ä¸”çŠ¶æ€ä¸ºæ´»è·ƒ
                if (merchant.bind_step === 5 && merchant.status === 'active') {
                    const option = document.createElement('option');
                    option.value = merchant.id;
                    option.textContent = `${merchant.teacher_name || 'æœªçŸ¥å§“å'} - ${merchant.region_name || 'æœªçŸ¥åœ°åŒº'}`;
                    select.appendChild(option);
                }
            });
            
            // å¦‚æœæ²¡æœ‰å¯é€‰å•†å®¶ï¼Œæ˜¾ç¤ºæç¤º
            if (select.children.length === 1) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'æš‚æ— å¯ç”¨å•†å®¶ï¼ˆéœ€è¦å®Œæˆç»‘å®šä¸”çŠ¶æ€ä¸ºæ´»è·ƒï¼‰';
                option.disabled = true;
                select.appendChild(option);
            }
            
            select.onchange = handleMerchantChange;
        }

        // å¤„ç†å•†å®¶é€‰æ‹©å˜åŒ–
        function handleMerchantChange() {
            const merchantId = document.getElementById('testMerchant').value;
            const preview = document.getElementById('merchantPreview');
            const content = document.getElementById('merchantPreviewContent');
            
            if (!merchantId) {
                preview.style.display = 'none';
                return;
            }
            
            const merchant = merchants.find(m => m.id == merchantId);
            if (merchant) {
                // ä½¿ç”¨ä¸å•†å®¶ç®¡ç†é¡µé¢ç›¸åŒçš„æ ¼å¼
                const previewText = `åœ°åŒºï¼š#${merchant.region_name || 'xx'}              è‰ºåï¼š${merchant.teacher_name || 'æœªå¡«å†™'}
ä¼˜ç‚¹ï¼š${merchant.advantages || 'æœªå¡«å†™'}
ç¼ºç‚¹ï¼š${merchant.disadvantages || 'æœªå¡«å†™'}
ä»·æ ¼ï¼š${merchant.price1 || 'æœªå¡«å†™'}p              ${merchant.price2 || 'æœªå¡«å†™'}pp
è”ç³»ï¼š${merchant.contact || 'æœªå¡«å†™'}

è€å¸ˆğŸ’ƒè‡ªå¡«åŸºæœ¬åŠŸï¼š
ğŸ’¦æ´—:${merchant.skill_wash || 'æœªå¡«å†™'}
ğŸ‘„å¹:${merchant.skill_blow || 'æœªå¡«å†™'}
â¤ï¸åš:${merchant.skill_do || 'æœªå¡«å†™'}
ğŸå»:${merchant.skill_kiss || 'æœªå¡«å†™'}`;
                
                content.innerHTML = `<pre style="white-space: pre-wrap; font-family: inherit; margin: 0;">${previewText}</pre>`;
                preview.style.display = 'block';
            }
        }

        // å¤„ç†æ¨¡æ¿é€‰æ‹©å˜åŒ–
        function handleTemplateChange() {
            const templateId = document.getElementById('testTemplate').value;
            const preview = document.getElementById('templatePreviewTest');
            const content = document.getElementById('templatePreviewTestContent');
            
            if (!templateId) {
                preview.style.display = 'none';
                return;
            }
            
            const template = templates.find(t => t.id == templateId);
            if (template) {
                let previewHtml = `<p><strong>ğŸ“ å†…å®¹ï¼š</strong>${template.content}</p>`;
                
                if (template.image_url) {
                    previewHtml += `<p><strong>ğŸ–¼ï¸ å›¾ç‰‡ï¼š</strong><img src="${template.image_url}" style="max-width: 200px; max-height: 100px;" /></p>`;
                }
                
                if (template.buttons_config) {
                    try {
                        const buttons = JSON.parse(template.buttons_config);
                        if (buttons.length > 0) {
                            previewHtml += '<p><strong>ğŸ”˜ æŒ‰é’®ï¼š</strong></p>';
                            buttons.forEach(row => {
                                row.forEach(btn => {
                                    previewHtml += `<button style="margin: 2px; padding: 5px 10px; background: #007bff; color: white; border: none; border-radius: 3px;">${btn.text}</button>`;
                                });
                            });
                        }
                    } catch (e) {
                        console.error('è§£ææŒ‰é’®é…ç½®å¤±è´¥:', e);
                    }
                }
                
                content.innerHTML = previewHtml;
                preview.style.display = 'block';
            }
        }

        // æ·»åŠ æµ‹è¯•æŒ‰é’®è¡Œ
        let testButtonRowCount = 0;
        function addTestButtonRow() {
            testButtonRowCount++;
            const container = document.getElementById('testButtonRows');
            const row = document.createElement('div');
            row.className = 'button-row';
            row.style.cssText = 'display: flex; gap: 10px; margin-bottom: 10px; align-items: center;';
            row.innerHTML = `
                <input type="text" class="button-text" placeholder="æŒ‰é’®æ–‡å­—" style="flex: 1;">
                <input type="text" class="button-callback" placeholder="å›è°ƒæ•°æ®ï¼ˆå¯é€‰ï¼‰" style="flex: 1;">
                <button type="button" onclick="removeTestButtonRow(this)" class="btn btn-danger" style="padding: 5px 10px;">åˆ é™¤</button>
            `;
            container.appendChild(row);
        }

        // åˆ é™¤æµ‹è¯•æŒ‰é’®è¡Œ
        function removeTestButtonRow(button) {
            button.parentElement.remove();
        }

        // ä¿å­˜ç¾¤ç»„IDåˆ°æœ¬åœ°å­˜å‚¨
        function saveChatId(chatId) {
            if (chatId) {
                localStorage.setItem('lastChatId', chatId);
            }
        }

        // ä»æœ¬åœ°å­˜å‚¨åŠ è½½ç¾¤ç»„ID
        function loadChatId() {
            const lastChatId = localStorage.getItem('lastChatId');
            if (lastChatId) {
                document.getElementById('testChatId').value = lastChatId;
            }
        }

        // å‘é€æµ‹è¯•æ¶ˆæ¯
        async function sendTestMessage(event) {
            event.preventDefault();
            showLoading();
            
            try {
                const chatId = document.getElementById('testChatId').value;
                const moduleType = document.getElementById('testModuleType').value;
                
                // ä¿å­˜ç¾¤ç»„ID
                saveChatId(chatId);
                
                let sendData = { chatId };
                
                if (moduleType === 'merchant') {
                    // å•†å®¶ä¿¡æ¯æ¨¡å¼
                    const merchantId = document.getElementById('testMerchant').value;
                    if (!merchantId) {
                        showAlert('è¯·é€‰æ‹©å•†å®¶', 'error');
                        return;
                    }
                    sendData.type = 'merchant';
                    sendData.merchantId = merchantId;
                    
                } else if (moduleType === 'template') {
                    // æ¶ˆæ¯æ¨¡æ¿æ¨¡å¼
                    const templateId = document.getElementById('testTemplate').value;
                    if (!templateId) {
                        showAlert('è¯·é€‰æ‹©æ¶ˆæ¯æ¨¡æ¿', 'error');
                        return;
                    }
                    sendData.type = 'template';
                    sendData.templateId = templateId;
                    
                } else if (moduleType === 'custom') {
                    // è‡ªå®šä¹‰æ¶ˆæ¯æ¨¡å¼
                const message = document.getElementById('testMessage').value;
                    if (!message.trim()) {
                        showAlert('è¯·è¾“å…¥æ¶ˆæ¯å†…å®¹', 'error');
                        return;
                    }
                    
                    sendData.type = 'custom';
                    sendData.message = message;
                    sendData.imageUrl = document.getElementById('testImageUrl').value;
                    
                    // æ”¶é›†æŒ‰é’®é…ç½®
                    const buttonRows = document.querySelectorAll('#testButtonRows .button-row');
                    const buttonsConfig = [];
                    
                    if (buttonRows.length > 0) {
                        const currentRow = [];
                        buttonRows.forEach(row => {
                            const text = row.querySelector('.button-text').value;
                            const callback = row.querySelector('.button-callback').value;
                            if (text.trim()) {
                                currentRow.push({
                                    text: text.trim(),
                                    callback_data: callback.trim() || `test_btn_${text.trim()}`
                                });
                            }
                        });
                        if (currentRow.length > 0) {
                            buttonsConfig.push(currentRow);
                        }
                    }
                    
                    if (buttonsConfig.length > 0) {
                        sendData.buttonsConfig = buttonsConfig;
                    }
                    
                } else {
                    showAlert('è¯·é€‰æ‹©å‘é€æ¨¡å—', 'error');
                    return;
                }
                
                await apiRequest('/api/test-send', 'POST', sendData);
                
                showAlert('æµ‹è¯•æ¶ˆæ¯å‘é€æˆåŠŸï¼');
            } catch (error) {
                showAlert('å‘é€å¤±è´¥: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // åˆ é™¤æ“ä½œ
        async function deleteButton(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæŒ‰é’®å—ï¼Ÿ')) return;
            
            try {
                await apiRequest('/api/buttons', 'DELETE', { id });
                showAlert('æŒ‰é’®åˆ é™¤æˆåŠŸï¼');
                await loadButtons();
            } catch (error) {
                showAlert('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
            }
        }

        async function deleteTemplate(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ¨¡æ¿å—ï¼Ÿ')) return;
            
            try {
                await apiRequest('/api/templates', 'DELETE', { id });
                showAlert('æ¨¡æ¿åˆ é™¤æˆåŠŸï¼');
                await loadTemplates();
                updateSelects();
            } catch (error) {
                showAlert('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
            }
        }

        async function deleteTrigger(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè§¦å‘è¯å—ï¼Ÿ')) return;
            
            try {
                await apiRequest('/api/triggers', 'DELETE', { id });
                showAlert('è§¦å‘è¯åˆ é™¤æˆåŠŸï¼');
                await loadTriggers();
            } catch (error) {
                showAlert('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
            }
        }

        async function deleteTask(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå®šæ—¶ä»»åŠ¡å—ï¼Ÿ')) return;
            
            try {
                await apiRequest('/api/tasks', 'DELETE', { id });
                showAlert('å®šæ—¶ä»»åŠ¡åˆ é™¤æˆåŠŸï¼');
                await loadTasks();
            } catch (error) {
                showAlert('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
            }
        }

        // åˆå§‹åŒ–æŒ‰é’®æ„å»ºå™¨
        addButtonRow();
    </script>
</body>
</html> 